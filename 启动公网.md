# 公网访问启动指南

## 问题现象
公网地址长时间处于「准备中」状态

## 解决方案

### 1. 项目结构说明

本项目为 **arkok** 多应用系统，包含：
- **手机端程序**：对应公网访问路径 `/app`
- **大屏端程序**：对应公网访问路径 `/screen`

项目结构：
```
/home/devbox/project/
├── arkok/                      # 主项目目录
│   ├── server.js              # 后端服务器（Express + WebSocket）
│   ├── .env                   # 数据库配置文件
│   ├── public/                # 静态文件目录（生产环境）
│   │   ├── index.html         # 手机端（访问路径：/app）
│   │   ├── assets/            # 编译后的资源文件
│   │   │   ├── main-*.js      # 手机端主程序（重要）
│   │   │   ├── bigscreen-*.js # 大屏端程序
│   │   │   └── client-*.js    # 共享客户端代码
│   │   └── bigscreen/         # 大屏端静态文件（访问路径：/screen）
│   ├── mobile/                # 手机端源码（需编译）
│   │   ├── src/               # 源代码
│   │   ├── dist/              # 构建输出（npm run build）
│   │   └── package.json       # 依赖和构建脚本
│   ├── bigscreen/             # 大屏端源码
│   └── package.json           # 服务器依赖
└── entrypoint.sh              # 启动脚本
```

**重要说明**：
- `/public` 目录是**生产环境**使用的静态文件目录
- `/mobile/dist` 是编译后的输出目录，需要手动复制到 `/public/assets/`
- 请勿直接修改 `/public/assets/` 中的文件，应该修改源码后重新编译

### 2. 启动服务

在 Devbox 实例中运行启动命令：

```bash
cd /home/devbox/project
./entrypoint.sh
```

或者使用后台启动：

```bash
cd /home/devbox/project
nohup ./entrypoint.sh > server.log 2>&1 &
```

### 3. 前端资源构建与管理

#### 构建流程说明

本项目使用 **Vite** 作为前端构建工具，支持多入口构建：

**源码位置**：
- 手机端源码：`/home/devbox/project/arkok/mobile/`
- 大屏端源码：`/home/devbox/project/arkok/bigscreen/`

**构建输出**：
- 手机端：`/home/devbox/project/arkok/mobile/dist/`
- 输出文件：`main-*.js`, `client-*.js`

**重要**：构建后的文件需要手动复制到生产目录：
```bash
cd /home/devbox/project/arkok/mobile

# 安装依赖（仅在首次或依赖变更时）
npm install

# 构建生产版本
npm run build

# 复制构建文件到 public/assets/
cp dist/assets/main-*.js ../public/assets/
cp dist/index.html ../public/
```

**生产环境使用的文件**：
- `/public/index.html` - 手机端入口文件
- `/public/assets/main-*.js` - 手机端主程序（关键）
- `/public/assets/bigscreen-*.js` - 大屏端程序
- `/public/assets/client-*.js` - 共享代码

#### 常见问题：手机端显示空白页（404 错误）

**问题现象**：访问 `/app` 时页面空白，浏览器控制台显示 404 错误

**错误信息**：
```
GET https://xxx.sealosbja.site/assets/main-xxx.js net::ERR_ABORTED 404
```

**根本原因**：`public/assets/` 目录缺少编译后的 `main-*.js` 文件

**解决方案**：
1. 检查资源文件是否存在：
   ```bash
   ls -lh /home/devbox/project/arkok/public/assets/
   ```

2. 如果缺少 `main-*.js` 文件，重新编译：
   ```bash
   cd /home/devbox/project/arkok/mobile
   npm install
   npm run build
   cp dist/assets/main-*.js ../public/assets/
   cp dist/index.html ../public/
   ```

3. 重启服务器：
   ```bash
   # 停止旧进程
   kill $(pgrep -f "arkok/server.js")

   # 启动新服务
   cd /home/devbox/project
   ./entrypoint.sh
   ```

### 4. 关键检查点

#### ✅ 监听地址配置
- **必须**：确保开发服务器运行在 `0.0.0.0` 而非 `localhost`
- **当前配置**：`arkok/server.js` 已正确配置为 `0.0.0.0:3000`
- **配置文件位置**：`/home/devbox/project/arkok/server.js:49`

```javascript
const server = http.createServer(app);
server.listen(PORT, '0.0.0.0', () => {
  console.log(`Server running at http://0.0.0.0:${PORT}`);
});
```

#### ✅ 端口配置
- 代码中使用端口：`3000`（在 .env 文件中配置）
- Devbox 开放端口：需确认与平台配置一致
- **注意**：entrypoint.sh 会加载 .env 文件中的 PORT 配置

#### ✅ 数据库连接配置
- **配置文件**：`/home/devbox/project/arkok/.env`
- **数据库服务**：Sealos PostgreSQL
- **自动连接**：entrypoint.sh 会自动加载 .env 文件并连接数据库

数据库配置参数：
```bash
DB_HOST=growark-postgresql.ns-bg6fgs6y.svc  # Sealos 数据库主机（集群内网地址）
DB_PORT=5432                                  # 数据库端口
DB_NAME=postgres                             # 数据库名
DB_USER=postgres                             # 数据库用户
DB_PASSWORD=kngwb5cb                         # 数据库密码
```

### 5. 服务模式说明

#### 为什么只需要 3000 端口？

本项目采用**单服务器多应用**架构，仅需 3000 端口即可同时服务多个前端应用：

**架构说明**：
1. **Express 服务器**（端口 3000）同时处理：
   - 静态文件服务（手机端、大屏端）
   - API 接口（学生数据管理）
   - WebSocket 实时通信

2. **路由区分**：
   - `/app` → 手机端应用（public/index.html）
   - `/screen` → 大屏端应用（public/bigscreen/index.html）
   - `/api/*` → API 接口（server.js 处理）

3. **开发模式 vs 生产模式**：
   - **生产模式**（当前使用）：
     - 前端代码编译为静态文件（main-*.js, bigscreen-*.js）
     - Express 服务器统一提供静态文件和 API 服务
     - 仅需要 3000 端口

   - **开发模式**（本地开发）：
     - 在 `/mobile` 目录运行 `npm run dev`
     - Vite 开发服务器提供热更新（也使用 3000 端口）
     - 但生产部署不需要此步骤

**结论**：生产环境只需要启动 Express 服务器（3000 端口），无需其他服务！

#### 验证服务模式

```bash
# 检查端口监听状态
netstat -tulpn | grep :3000

# 预期输出：tcp 0 0 0.0.0.0:3000 0.0.0.0:* LISTEN node
# 这表明 Express 服务器正在监听所有网络接口的 3000 端口
```

如果看到多个 Node.js 进程或多个端口，说明可能有：
1. 旧的服务器进程未正确关闭
2. 同时启动了开发服务器和 Express 服务器

**解决方法**：
```bash
# 停止所有 Node.js 进程
kill $(pgrep -f "arkok/server.js")

# 重新启动
./entrypoint.sh
```

#### ✅ 路由映射配置
- **手机端**：`http://公网地址/app` → `/home/devbox/project/arkok/public/index.html`
- **大屏端**：`http://公网地址/screen` → `/home/devbox/project/arkok/public/bigscreen/index.html`
- **Admin管理端**：`http://公网地址/admin` → `/home/devbox/project/arkok/public/index.html`

### 4. 启动后的等待时间

启动服务后，内部网关需要 **2-5 分钟**准备，请耐心等待。

### 5. 服务状态检查

#### 检查服务是否运行
```bash
ps aux | grep "arkok/server.js" | grep -v grep
```

预期输出：
```
devbox   59527  0.5  0.0 11778092 61536 ?      Sl   04:14   0:00 node arkok/server.js
```

#### 查看实时日志
```bash
# 如果服务在后台运行，使用以下命令查看输出
# PID 需要替换为实际进程ID
tail -f /proc/$(pgrep -f "arkok/server.js")/fd/1
```

#### 手动测试服务
```bash
# 测试服务器是否启动
curl http://0.0.0.0:3000/health

# 测试学生数据API
curl http://0.0.0.0:3000/api/students

# 测试手机端页面
curl -I http://0.0.0.0:3000/app

# 测试大屏端页面
curl -I http://0.0.0.0:3000/screen
```

### 6. 配置文件说明

#### entrypoint.sh（启动脚本）
- **位置**：`/home/devbox/project/entrypoint.sh`
- **用途**：自动化启动脚本，确保数据库连接和服务器启动
- **启动命令**：`./entrypoint.sh [development|production]`
- **默认环境**：development
- **自动操作**：
  1. 切换到 `/home/devbox/project/arkok` 目录
  2. 加载 `.env` 环境变量文件
  3. 显示数据库连接配置信息
  4. 启动 Node.js 服务器（server.js）

#### .env（数据库配置文件）
- **位置**：`/home/devbox/project/arkok/.env`
- **用途**：存储数据库连接配置
- **重要**：请勿将密码提交到版本控制

示例配置：
```bash
# Node.js环境
NODE_ENV=development
PORT=3000

# 数据库配置（Sealos PostgreSQL）
DB_HOST=growark-postgresql.ns-bg6fgs6y.svc  # Sealos 集群内网地址
DB_PORT=5432
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=kngwb5cb

# WebSocket配置
WS_ORIGIN=*
WS_PATH=/ws

# CORS配置
CORS_ORIGIN=*
CORS_CREDENTIALS=true

# 连接池配置
DB_POOL_MIN=2
DB_POOL_MAX=10
DB_IDLE_TIMEOUT=30000
DB_CONNECTION_TIMEOUT=10000
```

#### arkok/server.js（后端服务器）
- **位置**：`/home/devbox/project/arkok/server.js`
- **功能**：
  - 提供前端静态文件服务
  - 代理 API 请求到 PostgreSQL 数据库
  - 处理 WebSocket 实时通信
  - 学生数据管理（积分、经验值、等级等）
- **端口**：3000
- **API端点**：
  - `/api/students` - 获取学生列表和积分数据
  - `/api/docs` - API 文档
  - `/health` - 健康检查
  - `/ws` - WebSocket 连接
- **前端路径**：
  - `/app` - 手机端应用
  - `/screen` - 大屏端应用
  - `/admin` - 管理端应用

### 7. 环境区分

#### 开发环境（development）
```bash
./entrypoint.sh development
# 或
./entrypoint.sh
```

#### 生产环境（production）
```bash
./entrypoint.sh production
```

### 8. 常见问题排查

#### Q1: 公网地址仍显示"准备中"

**检查步骤**：
1. 服务是否已启动：`ps aux | grep "arkok/server.js"`
2. 是否等待 2-5 分钟（网关准备时间）
3. 检查服务器是否监听 0.0.0.0 地址（不是 localhost）
4. 检查端口是否为 3000
5. 检查健康检查接口：
   ```bash
   curl http://localhost:3000/health
   ```

#### Q2: 网页可以访问但没有数据

**可能原因**：数据库连接失败

**检查步骤**：
1. 查看服务器输出日志，检查是否有数据库连接错误
2. 验证 .env 文件是否存在：
   ```bash
   ls -la /home/devbox/project/arkok/.env
   ```
3. 检查 .env 文件中的数据库配置是否正确
4. 测试数据库连接：
   ```bash
   curl http://localhost:3000/api/students
   ```
5. 如果返回学生数据，说明连接正常

#### Q3: 如何修改数据库连接配置

**配置文件**：`/home/devbox/project/arkok/.env`

需要修改的参数：
- `DB_HOST` - 数据库主机地址
- `DB_PORT` - 数据库端口
- `DB_NAME` - 数据库名称
- `DB_USER` - 数据库用户名
- `DB_PASSWORD` - 数据库密码

修改后需重启服务：
```bash
# 停止旧服务
kill $(pgrep -f "arkok/server.js")

# 启动新服务
./entrypoint.sh
```

#### Q4: 如何切换到其他服务

本项目已固定为 arkok 项目，如需切换到其他服务：

1. 修改 `entrypoint.sh` 中的 `build_target` 变量（当前为 "server"）
2. 确保对应的服务文件存在于 `/home/devbox/project/arkok/` 目录
3. 更新 `.env` 文件中的相应配置
4. 重启服务

#### Q5: 学生班级/数据持久化问题

**问题现象**：在手机端管理后台修改学生班级（或修改学生信息）后，刷新页面数据又恢复到默认值

**根本原因分析**：
1. **前端层面**：`handleMoveToTeacherClass` 函数已正确调用 PUT `/api/students/:id` API
2. **后端层面**：server.js 中的 API 实现已正确处理 `class_name` 字段的更新
3. **数据库层面**：需要检查 `students` 表的 `class_name` 字段是否存在约束或默认值

**排查步骤**：
1. **检查前端请求**：使用浏览器开发者工具查看 Network 面板，确认 PUT 请求正文中包含正确的 class_name
   ```
   PUT /api/students/15
   { "class_name": "黄老师班" }
   ```

2. **检查 API 响应**：确认后端返回 200 且返回的数据中包含更新后的 class_name

3. **检查数据库 Schema**（如问题仍存在）：
   ```bash
   # 连接到 PostgreSQL
   psql -h growark-postgresql.ns-bg6fgs6y.svc -U postgres -d postgres

   # 查看 students 表结构
   \d students
   ```
   检查 `class_name` 字段是否有：
   - DEFAULT 约束（如 DEFAULT '三年一班'）
   - NOT NULL 约束
   - CHECK 约束

4. **检查数据库触发器**：确认是否有触发器会重置 class_name 字段
   ```sql
   SELECT * FROM pg_trigger WHERE tgrelid = 'students'::regclass;
   ```

**解决方案**：
- 如果 `class_name` 字段有 DEFAULT 约束，需要移除：
  ```sql
  ALTER TABLE students ALTER COLUMN class_name DROP DEFAULT;
  ```

- 确保前端发送的字段名与后端 API 期望的字段名一致：
  - 前端发送：`class_name`
  - 后端接收：`class_name`（server.js line 374）
- 检查是否有其他 API 或定时任务会覆盖 class_name 字段

**验证数据持久化**：
```bash
# 直接查询数据库确认数据是否保存
curl http://localhost:3000/api/students
# 检查返回的 JSON 中 class_name 是否正确
```

### 9. 快速启动命令

```bash
cd /home/devbox/project

# 后台启动
nohup ./entrypoint.sh > server.log 2>&1 &

# 查看启动日志
tail -f server.log
```

### 10. 停止服务

```bash
# 查找进程 ID
ps aux | grep "arkok/server.js"

# 杀死进程（优雅关闭）
kill <PID>

# 强制杀死进程
kill -9 <PID>
```

### 11. 生产环境部署建议

1. **使用生产环境模式**：
   ```bash
   ./entrypoint.sh production
   ```

2. **使用进程管理器**（推荐 PM2）：
   ```bash
   npm install -g pm2
   cd /home/devbox/project/arkok
   pm2 start server.js --name "arkok-server" --env production
   ```

3. **配置反向代理**（Nginx）：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;

       location / {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

### 12. 数据备份与恢复

Sealos PostgreSQL 数据库会定期自动备份，如需手动备份：

```bash
# 导出数据库
pg_dump -h growark-postgresql.ns-bg6fgs6y.svc -U postgres -d postgres > backup.sql

# 导入数据库
psql -h growark-postgresql.ns-bg6fgs6y.svc -U postgres -d postgres < backup.sql
```

---

**最后更新**：2025-11-25 07:50
**文档位置**：`/home/devbox/project/启动公网.md`
**配置版本**：arkok-server-v1.1
**数据库**：Sealos PostgreSQL (growark-postgresql.ns-bg6fgs6y.svc)
**主要更新**：
- 新增前端资源构建与管理章节
- 新增手机端空白页（404错误）解决方案
- 新增服务模式说明（为什么只需要 3000 端口）
- 新增学生数据持久化问题排查（Q5）
