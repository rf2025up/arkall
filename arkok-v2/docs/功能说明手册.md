# ARKOK V2 功能说明手册

---

## 📖 目录

1. [数据流转架构](#数据流转架构-ssot)
2. [加分规则详解](#加分规则详解)
3. [功能模块说明](#功能模块说明)
4. [2025-12-26 更新日志](#2025-12-26-更新日志)

---

## 数据流转架构 (SSOT)

### 核心设计原则：Single Source of Truth（单一事实来源）

ArkOK V2 采用 SSOT 架构，全站 **9 大模块**的数据最终汇流入 `task_records` 表，实现统一的数据流转和展示。

### 数据流转图

```
┌─────────────────────────────────────────────────────────┐
│                    9 大加分模块                         │
├─────────────────────────────────────────────────────────┤
│ 1. LMS 进度系统     │ 2. 勋章    │ 3. PK 对决           │
│ 4. 挑战赛          │ 5. 习惯    │ 6. 个性化辅导         │
│ 7. 手动任务        │ 8. 转移    │ 9. 其他               │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
          ┌──────────────────────────┐
          │   task_records 表        │
          │  (SSOT 唯一数据源)         │
          └──────────────────────────┘
                         │
         ┌───────────────┴───────────────┐
         ▼                               ▼
  ┌──────────────┐              ┌──────────────┐
  │ 教师端/学生端 │              │   家长端     │
  │ (按类型过滤)  │              │ (按分类聚合)  │
  └──────────────┘              └──────────────┘
```

### Type / Task_Category 双重分类系统

**设计目的**：实现清晰的一一对应映射，避免数据污染（如 PK 数据出现在挑战面板）。

| Type（业务类型） | Task_Category（分类） | 前端显示位置 |
|-----------------|---------------------|-------------|
| QC | PROGRESS | 个人详情页 - 进度地图 |
| PROJECT | PROGRESS | 个人详情页 - 进度地图 |
| TASK | TASK | 个人详情页 - 任务达人面板 |
| METHODOLOGY | METHODOLOGY | 个人详情页 - 任务达人面板 |
| SPECIAL | SPECIAL / CHALLENGE | 个人详情页 - 任务/挑战面板 |
| CHALLENGE | CHALLENGE | 个人详情页 - 挑战面板 |
| PK | PK | 个人详情页 - PK 面板 |
| PK_RESULT | PK | 个人详情页 - PK 面板 |
| BADGE | BADGE | 个人详情页 - 勋章面板 |
| HABIT | HABIT | 个人详情页 - 习惯面板 |

**前端过滤规则**：
- **任务达人面板**：`type ∈ ['TASK', 'METHODOLOGY', 'SPECIAL']`
- **挑战面板**：`type='CHALLENGE' && task_category='CHALLENGE'`（严格匹配）
- **PK 面板**：`type ∈ ['PK', 'PK_RESULT']`
- **勋章面板**：`type='BADGE'`

---

## 加分规则详解

### 9 大模块加分汇总

| 模块 | 典型奖励 | Points | 数据源 | Service 位置 |
|------|---------|--------|--------|------------|
| **1. LMS 进度** | 5-50 exp | 0 | curriculum 表 | lms.service.ts:316 |
| **2. 勋章** | **固定 20 exp** | 0 | badges 表 | badge.service.ts:403 |
| **3. PK 对决** | 获胜 50 exp<br>平局 25 exp | 获胜 20<br>平局 10 | pk_matches.metadata | pkmatch.service.ts:789 |
| **4. 挑战赛** | 参加 50 exp<br>完成 50 exp | 0 | challenges 表 | challenge.service.ts:439 |
| **5. 习惯打卡** | 5-20 exp | 0 | habits 表 | habit.service.ts:179 |
| **6. 个性化辅导** | 50 exp | 20 points | personalized_tutoring_plans 表 | personalized-tutoring.service.ts:363 |
| **7. 手动任务** | 5-10 exp | 0 | 老师手动创建 | lms.service.ts:742 |
| **8. 学生转移** | **0 exp** | 0 | students 表 | student.service.ts:1094 |
| **9. 其他操作** | 5-10 exp | 0 | 日常行为 | 各个 service |

### 详细加分说明

#### 1. LMS 进度系统
- **QC 任务**（质量检查）：5 exp
  - 示例："生字词听写", "课文背诵", "口算计时"
- **PROJECT 任务**（项目作业）：30-50 exp
  - 示例："阅读理解自主讲解"

#### 2. 勋章系统
- **固定奖励**：每个勋章 +20 exp（不可配置）
- 示例："获得勋章: 速度之星" → +20 exp

#### 3. PK 对决系统
- **获胜**：+50 exp, +20 points
- **平局**：+25 exp, +10 points
- 示例："PK对决获胜: 阅读" → +50 exp, +20 points

#### 4. 挑战赛系统
- **参加挑战**：+50 exp
- **完成挑战**：额外 +50 exp
- 同一个挑战最多获得 2 次加分

#### 5. 习惯打卡系统
- **默认奖励**：5 exp（可配置 10-20 exp）
- 示例："习惯打卡: 字字开花" → +10 exp

#### 6. 个性化辅导系统
- **完成辅导**：+50 exp, +20 points
- 仅在完成时发放，不记录进行态

#### 7. 手动任务
- **QC 任务**：5 exp
- **方法任务**：5 exp
- **常规任务**：5-10 exp
- 示例："书写工整" → +10 exp

#### 8. 学生转移
- **不加分**：0 exp（仅记录转移历史）

#### 9. 其他操作
- **日常行为**：5-10 exp
- 示例："桌面整洁" → +10 exp

### Points 积分使用说明

Points 主要用于以下场景：
- **PK 对决**：获胜 +20 points，平局 +10 points
- **个性化辅导**：完成 +20 points
- **其他模块**：仅奖励 exp，不奖励 points

**注意**：Points 和 exp 是独立的奖励系统，大部分模块只奖励 exp。

---

## 功能模块说明

### 教师端功能

#### 1. 学员管理
- **路径**：首页 → 学员管理
- **功能**：
  - 查看所有学生列表
  - 添加/编辑/删除学生
  - 转移学生到其他老师
  - 批量操作（批量转移）

#### 2. 课程发布（LMS）
- **路径**：首页 → 课程发布
- **功能**：
  - 选择年级/学科/版本
  - 选择单元/课时
  - 配置任务列表（QC、PROJECT）
  - 一键发布到班级

#### 3. 勋章颁发
- **路径**：首页 → 勋章管理
- **功能**：
  - 创建自定义勋章
  - 颁发勋章给学生
  - 查看勋章颁发历史

#### 4. PK 对决
- **路径**：首页 → PK 对决
- **功能**：
  - 创建 PK 对决
  - 设置对决主题
  - 配置奖励（exp/points）
  - 结算对决结果

#### 5. 挑战赛
- **路径**：首页 → 挑战赛
- **功能**：
  - 创建挑战活动
  - 设置参与条件
  - 配置奖励
  - 查看参与情况

#### 6. 习惯管理
- **路径**：首页 → 习惯管理
- **功能**：
  - 创建习惯项目
  - 配置打卡奖励
  - 查看打卡统计

#### 7. 个性化辅导
- **路径**：首页 → 个性化辅导
- **功能**：
  - 创建 1v1 辅导计划
  - 设置辅导内容
  - 完成后发放奖励
  - 查看辅导历史

### 学生端功能

#### 1. 个人详情页
- **路径**：首页 → 点击学生头像
- **面板展示**：
  - **过关地图**：显示全学期进度
  - **任务达人**：显示任务/方法/特殊任务
  - **挑战面板**：显示挑战赛记录
  - **PK 面板**：显示 PK 对决记录
  - **勋章面板**：显示获得的勋章
  - **习惯面板**：显示习惯打卡记录

#### 2. 成长长河
- **时间线展示**：按时间倒序显示所有任务记录
- **过滤功能**：可按类型筛选

### 家长端功能

#### 1. 今日时间线
- **路径**：家长端 → 首页
- **功能**：
  - 查看孩子今日所有活动
  - 按日期聚合显示
  - 点赞/评论功能

#### 2. 学业进度
- **路径**：家长端 → 学业进度
- **功能**：
  - 查看全学期进度地图
  - 查看各科目过关情况
  - 查看详细任务记录

---

## 2025-12-26 更新日志

### 1. 全局 Header 视觉系统重塑 (QC 风格)
- **更新对象**: `StudentManagement.tsx` (学员管理), `TeacherManagement.tsx` (教师管理)
- **设计规范**:
  - 引入沉浸式大圆角背景，采用橙色渐变方案，视觉中心更聚焦。
  - 废除原有的悬浮式顶栏，改为随页面滚动的自然流式布局。
  - **组件精修**:
    - 移除通知铃铛图标，保持界面极简。
    - “添加学生/教师”按钮统一移至右侧，采用 **纯白药丸背景 + 橙色文字** 设计。
    - 图标加粗 (`strokeWidth={3}`)，增强视觉交互反馈。

### 2. 2025 版课纲数据全学段校核与重构
- **更新对象**: `curriculum.service.ts` (课纲服务层)
- **数据灌装范围**:
  - **语文 (PEP)**: 2-6 年级上册全面对齐 2025 新教材，包含《观潮》、《走月亮》、《白鹭》等核心课目及其配套语文园地。
  - **数学 (PEP)**: 3-6 年级上册全面重构，加入《曹冲称象》故事、综合实践活动及总复习模块。
  - **英语 (湘少版)**: 3 年级上册数据补全。
- **优化点**: 彻底清理了历史版本中的语数数据冲突，确保科目、版本、单元序号严格与 2025 秋季新教科书一致。

### 3. 个人详情页“过关地图”动态适配系统
- **更新对象**: `StudentDetail.tsx` (学生详情页)
- **核心逻辑**:
  - **1:1 动态格数**: 告别硬编码的 40 格，现在地图格数会自动根据实际课纲总课数动态呈现。
  - **分科目专属色系**:
    - **语文**: 采用橙红系方案 (`orange-500`)。
    - **数学**: 采用深蓝系方案 (`blue-500`)。
    - **英语**: 采用翠绿系方案 (`green-500`)。
  - **成就节点交互**:
    - 差异化着色：区分 QC 过关、核心教法、个性加餐。
    - 过关节点增加微动呼吸动画。
    - 鼠标悬浮格点时动态显示通过的具体任务名称及达成日期。

### 4. 师生关系转移功能 (抢人模式)
- **更新对象**: `StudentService` (后端), `StudentRoutes` (路由), `ApiService` (前端)
- **核心逻辑**:
  - **功能定位**: 允许老师从全校名单中批量将学生“抢”到自己名下（即由转班升级为抢人）。
  - **数据一致性**:
    - 自动更新学生的 `teacherId` 为目标老师 ID。
    - 自动同步学生的 `className` 为目标老师的 `primaryClassName`（或默认“老师姓名+班”）。
  - **全链路追踪**:
    - 自动创建类型为 `SPECIAL` 的任务记录，详细记录转移操作的发起人、来源老师及目标老师。
    - 触发 `STUDENTS_TRANSFERRED` Socket 事件，实现多端数据实时刷新。

---
*最后更新人: Antigravity AI*
*更新时间: 2025-12-26 23:25*

### 🆕 2025-12-26 晚间修复

#### 4.1 师生转移交互优化
- **更新对象**: `Home.tsx`
- **优化点**: 转移成功后自动切换至"我的班级"视图，用户无需手动切换即可看到新转入的学生。

#### 4.2 PC 端右键菜单支持
- **更新对象**: `Home.tsx`
- **优化点**: PC 端支持右键点击学生头像触发评分/转移菜单（替代移动端长按）。

#### 4.3 勋章发布功能修复
- **更新对象**: `schema.prisma`
- **问题描述**: 勋章发布时报 500 错误，原因是 `task_category` 字段使用了 `BADGE` 值，但该值未在 `TaskCategory` 枚举中定义。
- **修复方案**: 在 Prisma Schema 的 `TaskCategory` 枚举中新增 `BADGE` 值。
