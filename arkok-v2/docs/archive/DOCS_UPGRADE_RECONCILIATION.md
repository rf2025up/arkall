# ArkOK V2 技术架构演进报告 (V2.0 vs V5.0)

本报告对比了旧版白皮书（V2.0）中描述的架构与当前生产环境（V5.0 憲法标准）的实际差异。

## 1. 核心架构对比

| 维度 | 旧版白皮书 (V2.0) | 当前实际版本 (V5.0) | 变更说明 |
| :--- | :--- | :--- | :--- |
| **Prisma 管理** | 各 Service `new PrismaClient()` 自实例化 | **全局单例注入** (Singleton) | 根治了 API 超时与数据库连接泄露问题。 |
| **分类体系** | 复杂层级 (`educationalDomain` 等) | **扁平标签化** (`category` / `type`) | 降低业务耦合，支撑快速的标签检索和地图回显。 |
| **投送逻辑** | 显式 `className` 发布 | **隐式师生绑定** (`teacherId`) | 增强了数据安全性，发布范围由关系链路自动确定。 |
| **时区处理** | 未明确，存在 UTC 偏差风险 | **强制 UTC+8 显式渲染** | 解决了当日任务在跨过零点或环境差异时显示为“昨日”的 Bug。 |
| **覆盖策略** | 仅有简单的状态修改 | **原子化清理并覆盖** | 实现了同日重复发布的幂等性，保留手动 `isOverridden` 数据。 |

## 2. 数据模型字典对比

| 表/字段 | 旧版白皮书 (V2.0) | 当前实际配置 (`schema.prisma`) | 
| :--- | :--- | :--- |
| **表名规范** | `student`, `lessonPlan` (驼峰) | `students`, `lesson_plans` (**强制复数+蛇形**) |
| **任务记录表** | `taskRecords` | `task_records` |
| **关键位** | 无 `isOverridden` | `isOverridden` (解决手动与自动冲突的关键) |
| **关联名** | `A`, `B` | `playerA`, `playerB` (符合 PK 业务语义) |

## 3. UI 视觉规范对比

| 元素 | 旧版/默认风格 | 当前“流光·智简”专家版 |
| :--- | :--- | :--- |
| **Header 风格** | 简单白色或单色背景条 | **沉浸式橙色渐变** (pt-8 pb-5, 30px 大圆角) |
| **交互排版** | 文字描述密集，说明性文案多 | **科学功能分区** (左信息/右操作/下情境) |
| **组件特性** | 标准按钮与卡片 | **玻璃拟态 (Glassmorphism)** & 精细胶囊形态 |

---

## 4. 重构执行路线图

我准备按照以下三个阶段完成对技术白皮书的“拨乱反正”：

### 第一阶段：文档归档与纠偏 (即刻开始)
1. **[MOVE]**: 将过时的 `ArkOK_V2_技术功能白皮书.md` 转移至备灾存档区，避免误导新入开发者。
2. **[NEW]**: 初始化 `ArkOK_V2_TECHNICAL_WHITEPAPER_V5.md` 骨架。

### 第二阶段：内容全量更新 (深度对齐)
1. **代码同步**: 从 `lms.service.ts` 和 `app.ts` 中提取真实的 Service 注入逻辑。
2. **模型同步**: 基于当前的 `schema.prisma` 完整重写“数据模型设计”章节，特别是 JSON 字段的业务定义。
3. **流程同步**: 绘制最新的“发布覆盖流程”与“全站地图数据流向图”。

### 第三阶段：验收与宣贯
1. **核对验证**: 确保文档中的每一个接口路径、字段名与代码库 100% 吻合。
2. **提交审阅**: 邀请用户对“多端同步”和“UI 规范”章节进行最终对齐。

**如果对比报告符合您的认知，我将立即开始执行第一阶段的归档与新版创建。**
