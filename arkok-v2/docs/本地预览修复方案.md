# 🛠️ ArkOK V2 本地预览修复方案总结

这次“白屏/500错误”问题的解决过程可以总结为 **“全链路疏通”**。以下是具体的故障原因分析及修复步骤，建议记录以备后用。

## 1. 核心问题诊断

| 现象 | 故障层级 | 根本原因 |
|------|----------|----------|
| **学生列表 500** | 数据库/后端 | Sealos 云数据库临时连接中断，导致 Prisma 查询崩溃。 |
| **API 请求超时** | 网络/代理 | 开启了 **TUN 模式**，代理软件拦截了浏览器发往 `localhost` 的内部转发请求。 |
| **白屏/无法连接** | 系统进程 | 存在多个 `ts-node-dev` **僵尸进程**，导致新启动的服务无法真正解构端口。 |

## 2. 修复操作清单

### 第一步：彻底清理“僵尸”进程
单纯的 `Ctrl+C` 有时无法杀掉子进程。我们执行了强制清理：
```bash
# 杀掉所有残留的开发服务进程
pkill -f "ts-node-dev"
pkill -f "vite"
```

### 第二步：重启后端服务（重连数据库）
在干净的环境下重新启动后端，让 Prisma 与 Sealos 重新握手：
```bash
cd server && npm run dev
```

### 第三步：配置代理“直连”规则
解决 TUN 模式干扰的关键。在代理软件（V2ray/Clash）中添加了以下绕过规则：
- **域名规则**：`localhost`, `127.0.0.1` 设置为 `Direct` (直连)。
- **进程规则**：将 `node` 进程设为直连（针对 TUN 模式最有效）。

### 第四步：Vite 配置优化
将 `vite.config.ts` 中的代理目标明确指向 `127.0.0.1` 而非 `localhost`，避开 IPv6/IPv4 解析歧义。

## 3. 日常维护建议

1. **服务启动顺序**：先启动后端 (3000)，确认看到 `Database connected` 字样后，再启动前端 (5173)。
2. **代理切换**：本地开发时，建议将代理切换为“规则模式”而非“全局模式”，并确认 `localhost` 在绕过列表中。
3. **遇到 500 报错**：优先检查服务器控制台日志。如果是数据库报错，只需重启后端服务即可。

---
*修复状态：已验证（前端、后端、数据库均已打通）*
