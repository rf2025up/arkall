# 托管中心·全流程专业把关与成就体系全案 (V5.8)

> **最后更新**: 2025-12-25

## 一、 设计思路与背景 (Design Philosophy & Background)

### 1. 行业痛点：服务的"不可见性"与"非标准化"
托管行业长期面临服务难以量化、家长感知弱、教师操作繁琐的问题。目前的系统往往无法体现机构在"作业辅导"之外的专业用心，如习惯培养、能力训练以及针对个体的精准纠偏。

### 2. 设计初衷：全透明、全动态、全闭环
本方案旨在构建一整套"从计划到执行，从日结到学期"的数字化闭环。通过**"标准方案 + 极致灵活性"**的对冲，既保证了机构宣发的专业性，又适配了托管现场"一生一案、动态纠偏"的真实复杂度。

---

## 二、 核心价值主张 (Core Values)

*   **对家长：从"看到作业"到"看到用心"**。通过双层看板，家长不仅能看到结果，更能看到机构为孩子量身定制的"加餐"和"补漏"计划，消除信息黑盒。
*   **对老师：从"手动录入"到"智能把关"**。通过拨盘纠偏和动态库，将繁琐的填表变为简单的"点选"和"确认"，提升职业成就感。
*   **对机构：从"日常看管"到"长期资产"**。每一次过关、每一个未过关节点都转化为期末的"补强地图"，支撑课后服务的持续溢价与续费。

---

## 三、 全维度需求清单 (Requirement Matrix)

### 1. 备课页 (PrepView)：标准方案配置中心
| 需求项 | 详细说明 | 业务价值 |
| :--- | :--- | :--- |
| **可编程分类体系** | 默认的"核心双基、习惯把关、能力训练"名称均可实时重命名。 | 适配不同机构的特色术语，提升专业定制感。 |
| **内容动态增删** | 所有把关项、任务条目支持修改、新增及拖拽排序。 | 确保教学大纲能紧跟学校进度及机构教研变化。 |
| **定制加餐计划** | 支持为特定学生发布"专属加餐"任务（仅该生家长可见）。 | 体现"因材施教"的极致用心，增强高客单价服务的差异化。 |
| **三支柱底图** | UI 分区展示基础、习惯、能力三大专业模块。 | 明确机构的服务边界与专业交付物。 |

### 2. 过关页 (QCView)：自由纠偏与激励指挥塔
| 需求项 | 详细说明 | 业务价值 |
| :--- | :--- | :--- |
| **进度拨盘 (Dial)** | 滑动选择单元/课次，系统自动回填课程标题。 | **SSOT (唯一事实来源)**，解决多学生进度不一的快速统计难题。 |
| **非锁定灵活性** | 过关页不被备课计划锁死，允许老师随时增减今日任务。 | 尊重一线老师的临场判断，适配学生突发状况。 |
| **动态激励库** | 随时补录"学校表现、家校联结"等临时成就。 | 捕捉孩子在校的闪光点，通过积分即时激励行为改变。 |
| **补过/重测逻辑** | 记录未通过项，系统自动将其推送到后续的"消账"流程。 | 确保每一个知识盲区都有交代，不遗漏任何问题。 |

### 3. 学生详情页 (StudentDetail)：长期积累成就图
| 需求项 | 详细说明 | 业务价值 |
| :--- | :--- | :--- |
| **1-40课静态地图** | 全学期底图展示，节点随老师确认过关而"点亮"。 | 视觉化呈现长期的学业积累，防止"学了后面忘前面"。 |
| **状态化节点** | 地图节点含：`已过关(绿)`、`待补强(红/黄)`、`未开始(灰)`。 | 清晰标识学业遗漏点，让地图具备"导航"功能。 |
| **成果回溯卡** | 点击已亮节点，弹出当日"把关动态卡"。 | 支持家长/老师随时调取任一天的历史成果，备查与回顾。 |

### 4. 家长端 (Parent View)：专业交付看板
| 需求项 | 详细说明 | 业务价值 |
| :--- | :--- | :--- |
| **置顶计划看板** | 系统置顶展示今日"把关目标"，含基础、习惯、能力、定制。 | 塑造"有目的、有计划"的机构形象。 |
| **执行态同步** | 老师每勾选一项，看板上对应的圈立即"点绿"。 | 让家长实时掌握孩子在托管中心的任务进度。 |
| **成就动态轴** | 下方流式展示"15:40 语文双基过关"等动态气泡。 | 提供流动感和陪伴感，提升家校互动的交互频次。 |

---

## 四、 核心闭环：【精准补强】与【期末数据汇总】

本方案最具杀伤力的功能在于**对"未过关"的处理**：
1.  **不留死角**：当孩子某项测试未过关时，系统不会简单忽略，而是将其状态标记为 `RECHECK`。
2.  **跨日消账**：老师在后续的过关页中，可以清晰看到该生所有的"历史欠账"，并随时安排补过。
3.  **期末 Roundup**：系统支持一键拉取某个学生全学期的所有 `FALSE/FAIL` 记录。
    *   **应用场景**：期末冲刺前，机构可以打印出一份《张三同学：学期学业遗漏点精准补强清单》。
    *   **商业意义**：这种基于全量过程数据的精准分析，是任何普通托管无法提供的核弹级交付，极大增强家长粘性。

---

## 五、 三端权限层级与数据流规则 (V5.8 新增)

### 5.1 权限层级

```
┌──────────────────────────────────────────────────────────┐
│                     权限金字塔                           │
├──────────────────────────────────────────────────────────┤
│        过关页 (QCView)     ← 【最高权限】                │
│           可覆写任何进度，是 SSOT                        │
├──────────────────────────────────────────────────────────┤
│        备课页 (PrepView)   ← 初始化权限                  │
│           定义今日计划，发布覆盖前次                      │
├──────────────────────────────────────────────────────────┤
│        家长端 (ParentView) ← 只读权限                    │
│           展示公告牌与成就卡片                           │
└──────────────────────────────────────────────────────────┘
```

> [!IMPORTANT]
> **过关页权限最高**：即使备课页发布了"第10课"，过关页的"课程拨盘"仍可覆写为"第5课"，确保每个学生的进度画像绝对真实。

### 5.2 发布覆盖规则

> [!CAUTION]
> **每次新发布备课，过关页应该是全新的，没有任何勾选**

**技术实现** (`lms.service.ts:publishPlan`):
```typescript
// 1. 发布前：删除当日所有旧记录
await prisma.task_records.deleteMany({
  where: { 
    studentId: { in: boundStudents.map(s => s.id) },
    content: { path: ['taskDate'], equals: todayStr }
  }
});

// 2. 发布后：创建新记录，状态为 PENDING
taskRecordsToCreate.push({
  type: task.type,  // 'QC' | 'TASK' | 'SPECIAL'
  status: 'PENDING',
  content: { courseInfo, taskDate: dateStr }
});
```

### 5.3 过关点亮流程

```
备课发布 → PENDING 记录 → 过关页点击 → COMPLETED 记录 → 家长端成就卡片
```

**过关页操作规则**:
- 找到现有 PENDING 记录 → 更新为 COMPLETED
- 允许修改课程进度（拨盘） → 新的 courseInfo 覆写旧值
- 每一课的每个过关项只能点亮**一次**（去重）

---

## 六、 家长端显示规则 (V5.8 新增)

### 6.1 公告牌（今日能力培养目标）

**数据来源**: 当日所有 `task_records` (PENDING + COMPLETED)

**分类识别规则**:

| 分类 | 识别条件 |
|------|----------|
| **基础过关** | `type='QC'` 或 `task_category='PROGRESS'` 或标题含"生字/听写/口算/背诵/古诗/竖式" |
| **习惯培养** | `category` 含"习惯" 或 `task_category='TASK'` 或 `category='综合成长'` |
| **能力训练** | `category` 含"能力/教学法" 或 `task_category='METHODOLOGY'` |
| **定制加餐** | 不属于以上分类 |

**视觉状态**:
- ✓ 绿勾 = 已完成 (`status='COMPLETED'`)
- ○ 蓝点 = 待办 (`status='PENDING'`)

### 6.2 成就卡片（基础过关）

**数据来源**: 当日 `type='QC'` 且 `status='COMPLETED'`

**分组键**: `${subject}-${unit}-${lesson}` （确保不同课程分开显示）

**去重规则**: 同一 groupKey 内，相同 title 只显示一次

**课文标题来源**: `task_records.content.courseInfo.title` 或 `.chinese.title`

**显示格式**:
```
✅ 基础过关 [语文]                    21:57
┌──────────────────────────────────────┐
│  第2单元 第4课《田家四季歌》    +10 XP │
│  ✓ 生字听写              +5          │
│  ✓ 课文背诵              +5          │
│  已完成 2/2                  +10 XP  │
└──────────────────────────────────────┘
```

### 6.3 成就卡片聚合规则

> [!IMPORTANT]
> 所有任务类别都采用**聚合显示**，同一类别的多条记录合并为一张卡片。

| 卡片类型 | 聚合来源 | 排除内容 |
|----------|----------|----------|
| `QC_GROUP` | `type='QC'` | 按 subject-unit-lesson 分组 |
| `METHODOLOGY_GROUP` | `task_category='METHODOLOGY'` 或 category 含"能力/教学法" | - |
| `HABIT_TASK_GROUP` | `task_category='TASK'` 或 category 含"习惯/综合成长" | - |
| `SPECIAL_GROUP` | `type='SPECIAL'` | 排除"移入班级"、"手动调整"等系统操作 |

**聚合卡片显示格式**:
```
📝 核心教学法                        22:42
┌──────────────────────────────────────┐
│  ✓ 限时挑战              +10         │
│  ✓ 信息提取              +10         │
│  ✓ 阅读表达              +10         │
│  已完成 3/3                  +30 XP  │
└──────────────────────────────────────┘
```

### 6.4 SPECIAL 类型说明

`SPECIAL` 类型包含两类记录，需区分处理：

| 子类型 | 来源 | 是否显示 |
|--------|------|----------|
| **定制加餐任务** | 备课页发布的个性化任务（如"整理错题本"） | ✅ 显示在"定制加餐"卡片 |
| **系统操作记录** | 系统自动生成（如"移入班级"、"老师手动调整进度"） | ❌ 不显示 |

---

## 七、 数据隔离原则 (V5.8 新增)

### 7.1 课程隔离
- 分组键: `${subject}-${unit}-${lesson}`
- 第2单元第4课 vs 第1单元第2课 → **分别显示两张卡片**
- 不同课程的数据绝对不能混在一起

### 7.2 时间隔离
- 公告牌: 只显示**当天**的记录
- 成就卡片: 只显示**当天**已完成的记录
- 不做跨天累计 (避免历史测试数据污染)

### 7.3 每课唯一性
- 每一课的每个过关项只能点亮**一次**
- 技术实现: `seenTitles.has(title) → 跳过`

---

## 八、 技术实现要点 (V5.8 新增)

### 8.1 关键文件映射

| 文件 | 职责 |
|------|------|
| `PrepView.tsx` | 备课页 UI，选择过关项并发布 |
| `QCView.tsx` | 过关页 UI，执行过关操作和进度调整 |
| `lms.service.ts:publishPlan` | 发布逻辑，删旧创新 |
| `lms.routes.ts:POST /records` | 过关点击 API |
| `parent.service.ts:getTodayTimeline` | 家长端数据聚合 |
| `TodayTimeline.tsx` | 家长端渲染 |

### 8.2 时区处理

> [!NOTE]
> 后端强制使用北京时间 (UTC+8)，避免 VPN/代理导致的时区错误

```typescript
const beijingNow = new Date(Date.now() + 8 * 60 * 60 * 1000);
const todayStr = beijingNow.toISOString().split('T')[0];
```

### 8.3 关键数据结构

```typescript
// task_records 表核心字段
{
  type: 'QC' | 'TASK' | 'SPECIAL',
  task_category: 'PROGRESS' | 'TASK' | 'METHODOLOGY',
  status: 'PENDING' | 'COMPLETED',
  content: {
    category: string,         // 中文分类标签
    courseInfo: {             // 课程进度
      unit: string,
      lesson: string,
      title: string           // 课文名（如：田家四季歌）
    },
    taskDate: string          // 日期 YYYY-MM-DD
  }
}
```

---

## 九、 系统演进历史

### V1.0 - V4.0：任务发布驱动 (Task-Driven)
*   **设计逻辑**：老师在备课页选择任务（背诵、口算等），一键下发至全校区。
*   **核心矛盾**：
    *   **进度僵化**：备课页发布的是"第 10 课"，但每个学生进度不同，导致进度数据失真。
    *   **录入负担**：老师每次都需要手动输入"第 X 课 - 课文名字"，极其繁琐且易错。
    *   **价值感缺失**：家长端只能看到"过了"、"没过"，感受不到机构教学的专业深度。

### V5.1：大纲驱动与灵活纠偏 (Curriculum-First)
*   **引入标准地图**：内置 2025 新版人教版全学期索引。
*   **解耦机制**：备课页发布的内容仅作为"默认建议"，过关页拥有最高权限可覆写。
*   **实时同步**：以过关页的"实调"作为 SSOT，同步至学期地图。
*   **带来的改变**：解决了"活的学生"与"死的计划"之间的矛盾。

### V5.2：专业教学设计中心 (Pedagogic Design Center)
*   **备课页的蜕变**：从"任务分发器"升级为**"专家教学方案输出端"**。
*   **专业维度注入**：重难点剖析、教学法背书、定制加餐。
*   **价值外显**：这些内容汇集成精美的**"专业教学计划卡片"**呈献给家长。

### V5.8：完整数据流闭环 (当前版本)
*   **发布覆盖规则**：每次新发布完全覆盖前次数据。
*   **权限层级明确**：过关页 > 备课页 > 家长端。
*   **数据隔离原则**：课程隔离、时间隔离、每课唯一性。

> [!TIP]
> **结论**：备课页不再是繁杂的操作负担，而是机构展现其不可替代的**专业价值**的核心窗口。

---

## 十、 过关抽屉 UI 规格

### 10.1 信息架构

```
┌─────────────────────────────────────────┐
│  Header: 学生信息 + 日期 + 一键过关      │
├─────────────────────────────────────────┤
│  进度拨盘: 语文/数学/英语 单元+课程      │
├─────────────────────────────────────────┤
│  学科 Tab: 语文(橙) | 数学(蓝) | 英语(紫) │
├─────────────────────────────────────────┤
│  基础过关清单 (静态勾选项)               │
│  ☐ 生字听写  ☐ 课文背诵  ☐ 古诗默写     │
├─────────────────────────────────────────┤
│  核心教学法面板 (红色主题)               │
├─────────────────────────────────────────┤
│  综合成长面板 (绿色主题)                 │
├─────────────────────────────────────────┤
│  定制加餐面板 (橙色主题)                 │
├─────────────────────────────────────────┤
│  底部结算栏: [待结算 15 EXP] [确认结算]  │
└─────────────────────────────────────────┘
```

### 10.2 学科主题色

| Tab | 主题色 | 激活样式 |
|-----|--------|----------|
| 语文 | 橙色 | `bg-orange-500 text-white` |
| 数学 | 蓝色 | `bg-blue-600 text-white` |
| 英语 | 紫色 | `bg-indigo-600 text-white` |

### 10.3 静态过关项清单

> [!NOTE]
> 基础过关项为**前端静态配置**，不再从后端动态获取。

| 学科 | 默认清单项 |
|------|-----------| 
| **语文** | 生字听写、课文背诵、古诗/日积月累默写、课文理解问答 |
| **数学** | 口算计时、竖式/脱式、概念/公式背默 |
| **英语** | 单词默写、中英互译、句型背诵、课文背诵 |

### 10.4 交互规则

| 操作 | 调用接口 | 效果 |
|------|----------|------|
| 点击未勾选项 | `POST /lms/records` | 创建 COMPLETED 记录 |
| 点击已勾选项 | `PATCH /lms/records/:id/status` | 切换回 PENDING |
| 一键过关 | 批量更新 | 所有 PENDING → COMPLETED |
| 确认结算 | `PATCH /records/student/:id/pass-all` | 更新学生经验值 |

### 10.5 视觉风格

- **整体**：灵动卡片式设计，圆角柔和（24px-32px）
- **背景**：浅灰渐变 `#F8FAFC`
- **卡片**：白色 + 微阴影 + 玻璃感边框
- **动效**：勾选时有弹性缩放反馈
- **间距**：宽松留白，模块间 gap 16-24px

---

## 十一、 更新日志

| 日期 | 版本 | 变更 |
|------|------|------|
| 2025-12-25 | V5.8 | 整合完整方案，新增：权限层级、发布覆盖规则、家长端显示规则、数据隔离原则、演进历史、过关抽屉UI规格 |
| 2025-12-20 | V5.7 | 完善三端需求矩阵 |
| 2025-12-15 | V5.6 | 引入精准补强与期末数据汇总机制 |
| 2025-12-10 | V5.2 | 升级备课页为专业教学设计中心 |
| 2025-12-05 | V5.1 | 引入大纲驱动与灵活纠偏机制 |

