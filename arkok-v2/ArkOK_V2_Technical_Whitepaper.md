# ArkOK V2 技术与功能全景白皮书 (2025-12-21)

## 1. 核心愿景 (Core Vision)
ArkOK V2 是一个**以过程反馈驱动的习惯塑造与成就加速器**。通过“最近发展区”理论，将复杂的学习过程颗粒化为实时交互（PK、挑战、过关），使成长可视化、社交化。

## 2. 核心架构底座: 5.0 技术宪法 (The Constitution)
这是系统的最高行为准则，所有开发必须遵循：

*   **单事实来源 (SSOT)**: 所有学生行为（PK、勋章、挑战、过关、习惯）最终必须映射到 `task_records`。UI 层应通过 `task_records` 进行聚合展示，严禁绕过记录直接读取业务表。
*   **Prisma 全局单例**: 统一使用 `src/utils/prisma.ts` 导出的单例对象，严禁在 Service/Route 中 `new PrismaClient()`，以根除连接泄漏导致的 10s 超时问题。
*   **UUID ID 策略**: 全系统采用 UUID v4，确保数据迁移与合并时无冲突。
*   **接口聚合原则**: 复杂页面（如详情页、大屏）应由后端提供专门的聚合 Profile 接口，单次请求获取全量看板数据，提升首屏响应速度。

## 3. 核心功能链路深度解析

### 3.1 备课与过关 (Prep & QC)

#### 3.1.1 备课页 (PrepView)
**核心目的**: 老师为自己名下的学生发布当日学习任务。

**功能模块**:
1. **课程进度设置**: 记录三科（语文/数学/英语）当前教学位置，格式为 `第X单元 第X课 课文名称`
2. **任务选择**:
   - **QC 过关任务**: 基础必达项（如听写、口算）→ `type: 'QC'`
   - **普通任务**: 核心教学法、综合成长类 → `type: 'TASK'`
   - **特殊任务**: 定向加餐（指定学生）→ `type: 'SPECIAL'`
3. **发布安全约束**: 🔒 只能投送到 `teacherId = 当前老师` 的学生；同日多次发布会覆盖旧记录（保留 `isOverridden` 的手动调整项）

#### 3.1.2 过关页 (QCView)
**核心目的**: 老师执行线下考核，记录学生的过关情况。

**五大功能模块**:
| 模块名称 | 数据库 `type` | `task_category` | 用途 |
|---------|--------------|-----------------|------|
| **课程进度** | QC | PROGRESS | 汇入全学期过关地图，更新学业位置 |
| **基础过关项** (语/数/英 Tab) | QC | PROGRESS | 每日必达完成率统计 |
| **核心教学法** | TASK | METHODOLOGY | 9大教学法维度，任务达人时间线 |
| **综合成长** | TASK | TASK | 阅读、整理、家庭联结等成长任务 |
| **定制加餐** | TASK | PERSONALIZED | 老师为特定学生定制的专属任务 |

**关键字段**:
- `courseInfo`: 存储课程进度快照（单元/课时/课文名），用于绘制全学期地图
- `content.category`: 保留原始中文分类字符串，供前端分组展示

#### 3.1.3 数据归宿 (SSOT 原则)
所有备课与过关操作最终汇入 `task_records` 表，详情页通过聚合接口读取：
- **全学期过关地图**: 筛选 `type: 'QC'` 记录，按 `courseInfo` 绘制学业进度
- **任务达人时间线**: 筛选 `type: 'TASK'` 记录，展示成长轨迹


### 3.2 学生成长体系 (Growth & Social)
*   **PK 对战**: 强实时、强反馈。通过 `pk_matches` 产生行为，同步生成两名参与者的 `CHALLENGE` 型任务记录，确保经验值和积分的原子化发放。
*   **挑战 (Challenge)**: 包含个人及团队挑战。新宪法要求“参加挑战”即生成“进行中”任务记录，防止数据在统计时失踪。
*   **习惯 (Habit)**: 每日微习惯通过 `habit_logs` 沉淀，辅以连击统计提升用户粘性。

### 3.3 大屏端交互 (Big Screen)
*   基于 Socket.io 的低延迟流。
*   **逻辑**: 当后端产生核心记录（过关、PK、加分）时，广播全局事件，大屏端监听并触发动态可视化效果。

## 4. 详情页重构: SSOT 的终局之路
### 4.1 现状诊断
- 之前的重构解决了“数据产生”的一致性，但前端详情页仍保留了“多头调用”的旧习（如 `all-records`, `pk-stats` 等）。
- 404 报错源于物理路径已迁移，但前端残留代码仍在尝试访问废弃接口。

### 4.2 终局方案
- **完全收拢**: `StudentDetail.tsx` 已彻底移除所有细碎的 `useState` 和冗余的 `useEffect`。
- **权威数据源**: 所有 UI 展现统一来自于 `api/students/profile/:id`。后端在此接口中完成挑战、习惯、PK、勋章的全量聚合。
- **派生计算**: 前端通过 `useMemo` 基于 `studentProfile` 实时计算展示逻辑，确保数据 0 延迟、0 状态冲突。
- **验证通过**: 已在“宁可歆”、“陈宇涵”等账号下验证，数据同步精确无误，加载速度优于 500ms，无 404 回归。

---
*声明：此文档为 ArkOK V2 的权威技术定义文件，所有后续开发应以此为基石。*