generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model badges {
  id             String           @id @default(uuid())
  schoolId       String
  name           String
  description    String?
  icon           String?
  category       String
  requirement    Json?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  schools        schools          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student_badges student_badges[]

  @@unique([schoolId, name])
}

model challenge_participants {
  id          String             @id @default(uuid())
  challengeId String
  studentId   String
  joinedAt    DateTime           @default(now())
  status      ParticipantStatus  @default(JOINED)
  result      ParticipantResult?
  score       Int?
  notes       String?
  completedAt DateTime?
  challenges  challenges         @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  students    students           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([challengeId, studentId])
}

model challenges {
  id                     String                   @id @default(uuid())
  schoolId               String
  title                  String
  description            String?
  type                   ChallengeType            @default(PERSONAL)
  status                 ChallengeStatus          @default(DRAFT)
  creatorId              String
  startDate              DateTime                 @default(now())
  endDate                DateTime?
  rewardPoints           Int                      @default(0)
  rewardExp              Int                      @default(0)
  maxParticipants        Int                      @default(2)
  metadata               Json?
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  challenge_participants challenge_participants[]
  teachers               teachers                 @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  schools                schools                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model habit_logs {
  id         String   @id @default(uuid())
  schoolId   String
  habitId    String
  studentId  String
  checkedAt  DateTime @default(now())
  streakDays Int      @default(1)
  notes      String?
  habits     habits   @relation(fields: [habitId], references: [id], onDelete: Cascade)
  schools    schools  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students   students @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model habits {
  id           String       @id @default(uuid())
  schoolId     String
  name         String
  description  String?
  icon         String?
  expReward    Int          @default(5)
  pointsReward Int?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  habit_logs   habit_logs[]
  schools      schools      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
}

model lesson_plans {
  id           String         @id @default(uuid())
  schoolId     String
  teacherId    String
  title        String
  content      Json
  date         DateTime
  isActive     Boolean        @default(true)
  isGlobal     Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  schools      schools        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers     teachers       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  task_records task_records[]
}

model mistakes {
  id         String        @id @default(uuid())
  schoolId   String
  studentId  String
  imageUrl   String?
  ocrText    String?
  status     MistakeStatus @default(PENDING)
  category   String?
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  aiAnalysis Json?
  schools    schools       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students   students      @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model pk_matches {
  id        String    @id @default(uuid())
  schoolId  String
  studentA  String
  studentB  String
  winnerId  String?
  status    PKStatus  @default(ONGOING)
  topic     String
  metadata  Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  schools   schools   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  playerA   students  @relation("pk_matches_studentA", fields: [studentA], references: [id], onDelete: Cascade)
  playerB   students  @relation("pk_matches_studentB", fields: [studentB], references: [id], onDelete: Cascade)
  winner    students? @relation("pk_matches_winner", fields: [winnerId], references: [id])

  @@index([schoolId, createdAt])
  @@index([studentA, status])
  @@index([studentB, status])
  @@index([schoolId, status])
}

model schools {
  id                          String                        @id @default(uuid())
  name                        String
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  isActive                    Boolean                       @default(true)
  planType                    PlanType                      @default(FREE)
  expiredAt                   DateTime?                     @default(dbgenerated("'2026-12-31 23:59:59'::timestamp without time zone"))
  settings                    Json?
  educationalPhilosophy       String                        @default("我们致力于培养面向未来的孩子，视自主学习力为核心武器，通过反馈驱动和最近发展区理论，鼓励孩子注重过程，持续自我迭代。")
  badges                      badges[]
  challenges                  challenges[]
  habit_logs                  habit_logs[]
  habits                      habits[]
  lesson_plans                lesson_plans[]
  mistakes                    mistakes[]
  personalized_tutoring_plans personalized_tutoring_plans[]
  pk_matches                  pk_matches[]
  students                    students[]
  task_library                task_library[]
  task_records                task_records[]
  teachers                    teachers[]
  // 家长端关系
  parents                     parents[]
  // 签到记录关系
  student_checkins            student_checkins[]
}

model student_badges {
  id        String   @id @default(uuid())
  studentId String
  badgeId   String
  awardedBy String?
  awardedAt DateTime @default(now())
  reason    String?
  badges    badges   @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  students  students @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model students {
  id                          String                        @id @default(uuid())
  schoolId                    String
  name                        String
  className                   String?
  level                       Int                           @default(1)
  points                      Int                           @default(0)
  exp                         Int                           @default(0)
  avatarUrl                   String?
  isActive                    Boolean                       @default(true)
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  teamId                      String?
  teacherId                   String?
  currentLesson               String?
  currentLessonTitle          String?
  currentUnit                 String?
  currentInviteCode           String? // 当前有效的邀请码
  inviteCodeExpiresAt         DateTime? // 邀请码过期时间
  challenge_participants      challenge_participants[]
  habit_logs                  habit_logs[]
  mistakes                    mistakes[]
  personalized_tutoring_plans personalized_tutoring_plans[]
  pk_matches_studentA         pk_matches[]                  @relation("pk_matches_studentA")
  pk_matches_studentB         pk_matches[]                  @relation("pk_matches_studentB")
  pk_matches_winner           pk_matches[]                  @relation("pk_matches_winner")
  student_badges              student_badges[]
  schools                     schools                       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers                    teachers?                     @relation(fields: [teacherId], references: [id])
  task_records                task_records[]
  // 家长端关系
  parent_student_bindings     parent_student_bindings[]
  daily_summaries             daily_summaries[]
  campaigns                   campaigns[]
  // 签到记录关系
  student_checkins            student_checkins[]

  @@unique([schoolId, name])
}

// 学生签到记录表
model student_checkins {
  id          String   @id @default(uuid())
  studentId   String
  schoolId    String
  checkinDate String // "2025-12-22" 格式，每天只能签到一次
  checkedBy   String? // 操作人（老师ID）
  createdAt   DateTime @default(now())

  students students @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schools  schools  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([studentId, checkinDate])
  @@index([studentId, checkinDate])
}

model task_library {
  id          String   @id @default(uuid())
  category    String
  name        String
  description String?
  defaultExp  Int      @default(0)
  type        TaskType @default(TASK)
  difficulty  Int?
  isActive    Boolean  @default(true)
  isGlobal    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  schoolId    String
  schools     schools  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, category, name])
}

model task_records {
  id            String        @id @default(uuid())
  schoolId      String
  studentId     String
  type          TaskType
  title         String
  content       Json?
  status        TaskStatus    @default(PENDING)
  expAwarded    Int           @default(0)
  submittedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lessonPlanId  String?
  task_category TaskCategory  @default(TASK)
  is_current    Boolean       @default(true)
  attempts      Int           @default(0)
  subject       String?
  isOverridden  Boolean       @default(false)
  lesson_plans  lesson_plans? @relation(fields: [lessonPlanId], references: [id])
  schools       schools       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students      students      @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model teachers {
  id                          String                        @id @default(uuid())
  schoolId                    String
  username                    String                        @unique
  password                    String
  name                        String
  email                       String?                       @unique
  role                        Role                          @default(TEACHER)
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  displayName                 String?
  primaryClassName            String?
  challenges                  challenges[]
  lesson_plans                lesson_plans[]
  personalized_tutoring_plans personalized_tutoring_plans[]
  students                    students[]
  schools                     schools                       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model personalized_tutoring_plans {
  id                   String    @id @default(uuid())
  teacherId            String
  schoolId             String
  title                String
  subject              String
  difficulty           Int       @default(3)
  scheduledDate        String
  scheduledTime        String
  duration             Int
  actualStartTime      DateTime?
  actualEndTime        DateTime?
  studentId            String
  studentName          String
  studentClass         String
  knowledgePoints      Json
  mainProblem          String
  detailedContent      String?
  teachingObjectives   String?
  preparationMaterials String?
  tutoringMethods      Json
  expReward            Int       @default(50)
  pointsReward         Int       @default(20)
  expAwarded           Boolean   @default(false)
  pointsAwarded        Boolean   @default(false)
  status               String    @default("SCHEDULED")
  completionNotes      String?
  studentFeedback      String?
  parentFeedback       String?
  effectivenessRating  Int?
  followUpRequired     Boolean   @default(false)
  followUpDate         String?
  followUpNotes        String?
  attachments          Json?
  totalSessions        Int       @default(1)
  completedSessions    Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  schools              schools   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students             students  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teachers             teachers  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([studentId, status])
  @@index([teacherId, scheduledDate])
  @@index([schoolId, scheduledDate])
  @@index([status, scheduledDate])
  @@map("personalized_tutoring_plans")
}

enum ChallengeStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ChallengeType {
  PERSONAL
  GROUP
  CLASS
}

enum MistakeStatus {
  PENDING
  REVIEWING
  RESOLVED
  IGNORED
}

enum PKStatus {
  ONGOING
  COMPLETED
  CANCELLED
}

enum ParticipantResult {
  WINNER
  COMPLETED
  FAILED
}

// ==================== 家长端模型 ====================

// 家长账户（支持绑定多个孩子）
model parents {
  id                      String                    @id @default(uuid())
  schoolId                String
  phone                   String // 手机号作为登录账号
  password                String                    @default("0000") // 默认密码
  name                    String? // 家长姓名
  identity                String? // 身份标签：爸爸/妈妈/爷爷/奶奶/其他
  lastLoginAt             DateTime?
  isActive                Boolean                   @default(true)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  schools                 schools                   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  parent_student_bindings parent_student_bindings[]
  daily_summaries         daily_summaries[]

  @@unique([schoolId, phone])
}

// 家长-学生绑定关系
model parent_student_bindings {
  id          String   @id @default(uuid())
  parentId    String
  studentId   String
  inviteCode  String // 老师生成的邀请码
  bindingTime DateTime @default(now())
  isActive    Boolean  @default(true)
  parents     parents  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  students    students @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
}

// 每日家校反馈汇总
model daily_summaries {
  id            String   @id @default(uuid())
  studentId     String
  parentId      String
  date          String // "2025-12-21" 格式
  parentLiked   Boolean  @default(false)
  parentComment String?
  teacherRead   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  students      students @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parents       parents  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId, date])
}

// 裂变活动（暂保留接口，具体逻辑后续设计）
model campaigns {
  id        String   @id @default(uuid())
  studentId String
  type      String // "REVIVE" / "INVITE"
  status    String   @default("ACTIVE") // ACTIVE / COMPLETED / EXPIRED
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  students  students @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

// ==================== 家长端模型结束 ====================

enum ParticipantStatus {
  JOINED
  WITHDRAWN
  DISQUALIFIED
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum Role {
  PLATFORM_ADMIN
  ADMIN
  TEACHER
}

enum TaskCategory {
  PROGRESS
  METHODOLOGY
  TASK
  PERSONALIZED
}

enum TaskStatus {
  PENDING
  SUBMITTED
  REVIEWED
  COMPLETED
}

enum TaskType {
  HOMEWORK
  QUIZ
  PROJECT
  CHALLENGE
  DAILY
  QC
  TASK
  SPECIAL
}
