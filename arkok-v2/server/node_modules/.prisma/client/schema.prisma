generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model badges {
  id             String           @id
  schoolId       String
  name           String
  description    String?
  icon           String?
  category       String
  requirement    Json?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  schools        schools          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student_badges student_badges[]

  @@unique([schoolId, name])
}

model challenge_participants {
  id          String             @id
  challengeId String
  studentId   String
  joinedAt    DateTime           @default(now())
  status      ParticipantStatus  @default(JOINED)
  result      ParticipantResult?
  score       Int?
  notes       String?
  completedAt DateTime?
  challenges  challenges         @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  students    students           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([challengeId, studentId])
}

model challenges {
  id                     String                   @id
  schoolId               String
  title                  String
  description            String?
  type                   ChallengeType            @default(PERSONAL)
  status                 ChallengeStatus          @default(DRAFT)
  creatorId              String
  startDate              DateTime                 @default(now())
  endDate                DateTime?
  rewardPoints           Int                      @default(0)
  rewardExp              Int                      @default(0)
  maxParticipants        Int                      @default(2)
  metadata               Json?
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  challenge_participants challenge_participants[]
  teachers               teachers                 @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  schools                schools                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model habit_logs {
  id         String   @id
  schoolId   String
  habitId    String
  studentId  String
  checkedAt  DateTime @default(now())
  streakDays Int      @default(1)
  notes      String?
  habits     habits   @relation(fields: [habitId], references: [id], onDelete: Cascade)
  schools    schools  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students   students @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model habits {
  id           String       @id
  schoolId     String
  name         String
  description  String?
  icon         String?
  expReward    Int          @default(5)
  pointsReward Int?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  habit_logs   habit_logs[]
  schools      schools      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
}

model lesson_plans {
  id           String         @id
  schoolId     String
  teacherId    String
  title        String
  content      Json
  date         DateTime
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  schools      schools        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers     teachers       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  task_records task_records[]
}

model mistakes {
  id         String        @id
  schoolId   String
  studentId  String
  imageUrl   String?
  ocrText    String?
  status     MistakeStatus @default(PENDING)
  category   String?
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime
  aiAnalysis Json?
  schools    schools       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students   students      @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model pk_matches {
  id                                     String    @id
  schoolId                               String
  studentA                               String
  studentB                               String
  winnerId                               String?
  status                                 PKStatus  @default(ONGOING)
  topic                                  String
  metadata                               Json?
  createdAt                              DateTime  @default(now())
  updatedAt                              DateTime
  schools                                schools   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students_pk_matches_studentATostudents students  @relation("pk_matches_studentATostudents", fields: [studentA], references: [id], onDelete: Cascade)
  students_pk_matches_studentBTostudents students  @relation("pk_matches_studentBTostudents", fields: [studentB], references: [id], onDelete: Cascade)
  students_pk_matches_winnerIdTostudents students? @relation("pk_matches_winnerIdTostudents", fields: [winnerId], references: [id])
}

model schools {
  id                          String                        @id
  name                        String
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  isActive                    Boolean                       @default(true)
  planType                    PlanType                      @default(FREE)
  settings                    Json?
  educationalPhilosophy       String                        @default("æˆ‘ä»¬è‡´åŠ›äºåŸ¹å…»é¢å‘æœªæ¥çš„å­©å­ï¼Œè§†è‡ªä¸»å­¦ä¹ åŠ›ä¸ºæ ¸å¿ƒæ­¦å™¨ï¼Œé€šè¿‡åé¦ˆé©±åŠ¨å’Œæœ€è¿‘å‘å±•åŒºç†è®ºï¼Œé¼“åŠ±å­©å­æ³¨é‡è¿‡ç¨‹ï¼ŒæŒç»­è‡ªæˆ‘è¿­ä»£ã€‚")
  badges                      badges[]
  challenges                  challenges[]
  habit_logs                  habit_logs[]
  habits                      habits[]
  lesson_plans                lesson_plans[]
  mistakes                    mistakes[]
  pk_matches                  pk_matches[]
  students                    students[]
  task_library                task_library[]
  task_records                task_records[]
  teachers                    teachers[]
  personalized_tutoring_plans personalized_tutoring_plans[]
}

model student_badges {
  id        String   @id
  studentId String
  badgeId   String
  awardedBy String?
  awardedAt DateTime @default(now())
  reason    String?
  badges    badges   @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  students  students @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model students {
  id                                       String                        @id
  schoolId                                 String
  name                                     String
  className                                String?
  level                                    Int                           @default(1)
  points                                   Int                           @default(0)
  exp                                      Int                           @default(0)
  avatarUrl                                String?
  currentUnit                              String? // ğŸ†• è¿›åº¦å¿«ç…§ï¼šå½“å‰å•å…ƒ
  currentLesson                            String? // ğŸ†• è¿›åº¦å¿«ç…§ï¼šå½“å‰è¯¾
  currentLessonTitle                       String? // ğŸ†• è¿›åº¦å¿«ç…§ï¼šå½“å‰è¯¾ç¨‹æ ‡é¢˜
  isActive                                 Boolean                       @default(true)
  createdAt                                DateTime                      @default(now())
  updatedAt                                DateTime
  teamId                                   String?
  teacherId                                String?
  challenge_participants                   challenge_participants[]
  habit_logs                               habit_logs[]
  mistakes                                 mistakes[]
  pk_matches_pk_matches_studentATostudents pk_matches[]                  @relation("pk_matches_studentATostudents")
  pk_matches_pk_matches_studentBTostudents pk_matches[]                  @relation("pk_matches_studentBTostudents")
  pk_matches_pk_matches_winnerIdTostudents pk_matches[]                  @relation("pk_matches_winnerIdTostudents")
  student_badges                           student_badges[]
  schools                                  schools                       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers                                 teachers?                     @relation(fields: [teacherId], references: [id])
  task_records                             task_records[]
  personalized_tutoring_plans              personalized_tutoring_plans[]

  @@unique([schoolId, name])
}

model task_library {
  id                     String   @id
  schoolId               String
  category               String
  name                   String
  description            String?
  defaultExp             Int      @default(0)
  type                   TaskType @default(TASK)
  difficulty             Int?
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime
  educationalDomain      String   @default("åŸºç¡€ä½œä¸š")
  educationalSubcategory String   @default("åŸºç¡€æ ¸å¿ƒ")
  schools                schools  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, educationalDomain, educationalSubcategory, name])
}

model task_records {
  id            String        @id
  schoolId      String
  studentId     String
  type          TaskType
  title         String
  content       Json?
  status        TaskStatus    @default(PENDING)
  expAwarded    Int           @default(0)
  submittedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  lessonPlanId  String?
  task_category TaskCategory  @default(TASK)
  is_current    Boolean       @default(true)
  isOverridden  Boolean       @default(false) // ğŸ†• è¿›åº¦ä¼˜å…ˆçº§æ ‡è®°ï¼šè€å¸ˆæ‰‹åŠ¨ä¿®æ”¹åä¸º true
  attempts      Int           @default(0)
  subject       String?
  lesson_plans  lesson_plans? @relation(fields: [lessonPlanId], references: [id])
  schools       schools       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students      students      @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model teachers {
  id                          String                        @id
  schoolId                    String
  username                    String                        @unique
  password                    String
  name                        String
  email                       String?                       @unique
  role                        Role                          @default(TEACHER)
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  displayName                 String?
  primaryClassName            String?
  challenges                  challenges[]
  lesson_plans                lesson_plans[]
  students                    students[]
  schools                     schools                       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  personalized_tutoring_plans personalized_tutoring_plans[]
}

enum ChallengeStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ChallengeType {
  PERSONAL
  GROUP
  CLASS
}

enum MistakeStatus {
  PENDING
  REVIEWING
  RESOLVED
  IGNORED
}

enum PKStatus {
  ONGOING
  COMPLETED
  CANCELLED
}

enum ParticipantResult {
  WINNER
  COMPLETED
  FAILED
}

enum ParticipantStatus {
  JOINED
  WITHDRAWN
  DISQUALIFIED
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum Role {
  ADMIN
  TEACHER
}

enum TaskCategory {
  PROGRESS
  METHODOLOGY
  TASK
  PERSONALIZED
}

enum TaskStatus {
  PENDING
  SUBMITTED
  REVIEWED
  COMPLETED
}

enum TaskType {
  HOMEWORK
  QUIZ
  PROJECT
  CHALLENGE
  DAILY
  QC
  TASK
  SPECIAL
}

// ğŸ†• 1v1ä¸ªæ€§åŒ–æ•™å­¦è®¡åˆ’è¡¨ - ç‹¬ç«‹äºè¿›åº¦å‘å¸ƒç³»ç»Ÿ
model personalized_tutoring_plans {
  // åŸºç¡€æ ‡è¯†
  id        String @id @default(uuid())
  teacherId String
  schoolId  String

  // åŸºæœ¬ä¿¡æ¯
  title      String @db.Text
  subject    String // 'chinese' | 'math' | 'english' | 'general' | 'science' | 'art'
  difficulty Int    @default(3) // 1-5çº§éš¾åº¦

  // æ—¶é—´å®‰æ’
  scheduledDate   String // YYYY-MM-DD
  scheduledTime   String // HH:mm
  duration        Int // è¾…å¯¼æ—¶é•¿(åˆ†é’Ÿ)
  actualStartTime DateTime?
  actualEndTime   DateTime?

  // å­¦ç”Ÿä¿¡æ¯
  studentId    String
  studentName  String // å†—ä½™å­˜å‚¨ï¼Œæ–¹ä¾¿æŸ¥è¯¢
  studentClass String // å†—ä½™å­˜å‚¨ï¼Œæ–¹ä¾¿æŸ¥è¯¢

  // è¾…å¯¼å†…å®¹ç»“æ„åŒ–å­˜å‚¨
  knowledgePoints      Json // string[] - çŸ¥è¯†ç‚¹åˆ—è¡¨
  mainProblem          String  @db.Text // ä¸»è¦é—®é¢˜æè¿°
  detailedContent      String? @db.Text // è¯¦ç»†è¾…å¯¼å†…å®¹
  teachingObjectives   String? @db.Text // æ•™å­¦ç›®æ ‡
  preparationMaterials String? @db.Text // å‡†å¤‡ææ–™

  // è¾…å¯¼æ–¹æ³• (JSONBå­˜å‚¨é€‰æ‹©çŠ¶æ€)
  tutoringMethods Json // {
  //   conceptExplaining: boolean,     // æ¦‚å¿µæ¢³ç†
  //   exampleTeaching: boolean,       // ä¾‹é¢˜è®²è§£
  //   mistakeReflection: boolean,     // é”™é¢˜åæ€
  //   practiceExercise: boolean,      // ç»ƒä¹ å·©å›º
  //   interactiveDiscussion: boolean, // äº’åŠ¨è®¨è®º
  //   summaryReview: boolean          // æ€»ç»“å›é¡¾
  // }

  // å¥–åŠ±æœºåˆ¶
  expReward     Int     @default(50) // ç»éªŒå€¼å¥–åŠ±
  pointsReward  Int     @default(20) // ç§¯åˆ†å¥–åŠ±
  expAwarded    Boolean @default(false) // æ˜¯å¦å·²å‘æ”¾ç»éªŒ
  pointsAwarded Boolean @default(false) // æ˜¯å¦å·²å‘æ”¾ç§¯åˆ†

  // çŠ¶æ€è·Ÿè¸ª
  status              String  @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW
  completionNotes     String? @db.Text // å®Œæˆå¤‡æ³¨
  studentFeedback     String? @db.Text // å­¦ç”Ÿåé¦ˆ
  parentFeedback      String? @db.Text // å®¶é•¿åé¦ˆ
  effectivenessRating Int? // 1-5åˆ† æ•™å­¦æ•ˆæœè¯„åˆ†

  // è·Ÿè¿›è®¡åˆ’
  followUpRequired Boolean @default(false) // æ˜¯å¦éœ€è¦è·Ÿè¿›
  followUpDate     String? // è·Ÿè¿›æ—¥æœŸ
  followUpNotes    String? @db.Text // è·Ÿè¿›è¯´æ˜

  // ææ–™é™„ä»¶
  attachments Json? // é™„ä»¶åˆ—è¡¨ {name, url, type}

  // ç»Ÿè®¡ä¿¡æ¯
  totalSessions     Int @default(1) // æ€»è¯¾æ—¶æ•°
  completedSessions Int @default(0) // å·²å®Œæˆè¯¾æ—¶æ•°

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»å®šä¹‰ - ä½¿ç”¨å¤æ•°å¼•ç”¨
  students students @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teachers teachers @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  schools  schools  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // ç´¢å¼•ä¼˜åŒ–
  @@index([studentId, status])
  @@index([teacherId, scheduledDate])
  @@index([schoolId, scheduledDate])
  @@index([status, scheduledDate])
  @@map("personalized_tutoring_plans")
}
