// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// SaaS Multi-tenancy: Schools Model
model School {
  id                   String     @id @default(uuid())
  name                 String
  planType             PlanType   @default(FREE)
  isActive             Boolean    @default(true)
  settings             Json?      // å­¦æ ¡è®¾ç½® (JSONæ ¼å¼)
  educationalPhilosophy String     @db.Text @default("æˆ‘ä»¬è‡´åŠ›äºåŸ¹å…»é¢å‘æœªæ¥çš„å­©å­ï¼Œè§†è‡ªä¸»å­¦ä¹ åŠ›ä¸ºæ ¸å¿ƒæ­¦å™¨ï¼Œé€šè¿‡åé¦ˆé©±åŠ¨å’Œæœ€è¿‘å‘å±•åŒºç†è®ºï¼Œé¼“åŠ±å­©å­æ³¨é‡è¿‡ç¨‹ï¼ŒæŒç»­è‡ªæˆ‘è¿­ä»£ã€‚")
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  // Relations
  teachers     Teacher[]
  students     Student[]
  lessonPlans  LessonPlan[]
  taskRecords  TaskRecord[]
  pkMatches    PKMatch[]
  mistakes     Mistake[]
  habits       Habit[]
  challenges   Challenge[]
  badges       Badge[]
  habitLogs    HabitLog[]

  @@map("schools")
}

// Teachers/Admin Users
model Teacher {
  id        String   @id @default(uuid())
  schoolId  String
  username  String   @unique
  password  String   // hashed
  name      String
  displayName String? // æ˜¾ç¤ºåï¼Œå¦‚"å§œè€å¸ˆ"
  email     String?  @unique
  role      Role     @default(TEACHER)
  primaryClassName String? // ç»‘å®šçš„ä¸»ç­çº§ï¼Œå¦‚"å§œè€å¸ˆç­"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students    Student[]    // ğŸ†• æ–°å¢ï¼šè€å¸ˆåä¸‹çš„å­¦ç”Ÿå…³ç³»
  lessonPlans LessonPlan[]
  createdChallenges Challenge[] @relation("ChallengeCreator")

  @@map("teachers")
}

// Students Model (migrated from legacy)
model Student {
  id        String   @id @default(uuid())
  schoolId  String
  name      String
  className String?  // ç­çº§åæ”¹ä¸ºå¯é€‰ï¼Œä»…ä½œä¸ºæ˜¾ç¤ºæ ‡ç­¾
  level     Int      @default(1)
  points    Int      @default(0)  // mapped from legacy 'score'
  exp       Int      @default(0)  // mapped from legacy 'total_exp'
  avatarUrl String?
  teamId    String?  // ç”¨äºå¤§å±æ˜¾ç¤ºçš„å›¢é˜ŸID
  teacherId String?  // ğŸ†• æ–°å¢ï¼šç›´æ¥å½’å±è€å¸ˆID (æ ¸å¿ƒå˜æ›´)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school      School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher     Teacher?      @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  taskRecords TaskRecord[]
  pkMatchesA  PKMatch[]     @relation("StudentA")
  pkMatchesB  PKMatch[]     @relation("StudentB")
  pkWins      PKMatch[]     @relation("Winner")
  mistakes    Mistake[]
  habitLogs   HabitLog[]
  challengeParticipants ChallengeParticipant[]
  studentBadges StudentBadge[]

  @@unique([schoolId, name]) // Unique name within school
  @@map("students")
}

// Lesson Plans / Curriculum
model LessonPlan {
  id        String   @id @default(uuid())
  schoolId  String
  teacherId String
  title     String
  content   Json     // flexible content structure
  date      DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher     Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  taskRecords TaskRecord[]

  @@map("lesson_plans")
}

// Task Records (homework, assignments, etc)
model TaskRecord {
  id           String     @id @default(uuid())
  schoolId     String
  studentId    String
  lessonPlanId String?    // å…³è”æ•™å­¦è®¡åˆ’
  type         TaskType
  title        String
  content      Json?      // flexible task data
  status       TaskStatus @default(PENDING)
  expAwarded   Int        @default(0)
  submittedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  school      School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lessonPlan  LessonPlan? @relation(fields: [lessonPlanId], references: [id], onDelete: SetNull)

  @@map("task_records")
}

// PK Battles between students
model PKMatch {
  id       String      @id @default(uuid())
  schoolId String
  studentA String
  studentB String
  winnerId String?     // null for draw
  status   PKStatus    @default(ONGOING)
  topic    String
  metadata Json?       // match details, questions, etc.
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  school   School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  playerA  Student  @relation("StudentA", fields: [studentA], references: [id], onDelete: Cascade)
  playerB  Student  @relation("StudentB", fields: [studentB], references: [id], onDelete: Cascade)
  winner   Student? @relation("Winner", fields: [winnerId], references: [id], onDelete: SetNull)

  @@map("pk_matches")
}

// Mistake/Error Tracking
model Mistake {
  id         String      @id @default(uuid())
  schoolId   String
  studentId  String
  imageUrl   String?
  ocrText    String?
  aiAnalysis Json?       // AIåˆ†æç»“æœ
  status     MistakeStatus @default(PENDING)
  category   String?
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("mistakes")
}

// Enums
enum Role {
  ADMIN
  TEACHER
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum TaskType {
  QC       // è´¨æ£€
  TASK     // ä»»åŠ¡
  SPECIAL  // ç‰¹æ®Šä»»åŠ¡
  HOMEWORK
  QUIZ
  PROJECT
  CHALLENGE
  DAILY
}

enum TaskStatus {
  PENDING
  SUBMITTED
  REVIEWED
  COMPLETED
}

enum PKStatus {
  ONGOING
  COMPLETED
  CANCELLED
}

enum MistakeStatus {
  PENDING
  REVIEWING
  RESOLVED
  IGNORED
}

enum ChallengeType {
  PERSONAL  // ä¸ªäººæŒ‘æˆ˜
  GROUP     // å›¢é˜ŸæŒ‘æˆ˜
  CLASS     // ç­çº§æŒ‘æˆ˜
}

enum ChallengeStatus {
  DRAFT     // è‰ç¨¿
  ACTIVE    // è¿›è¡Œä¸­
  COMPLETED // å·²å®Œæˆ
  CANCELLED // å·²å–æ¶ˆ
}

enum ParticipantStatus {
  JOINED    // å·²å‚ä¸
  WITHDRAWN // å·²é€€å‡º
  DISQUALIFIED // å–æ¶ˆèµ„æ ¼
}

enum ParticipantResult {
  WINNER    // èƒœåˆ©è€…
  COMPLETED // å®Œæˆä½†æœªè·èƒœ
  FAILED    // å¤±è´¥
}

// Task Library for LMS - é¢„è®¾ä»»åŠ¡åº“
model TaskLibrary {
  id         String   @id @default(uuid())
  category   String   // ä»»åŠ¡ç±»åˆ«ï¼šå¦‚"åŸºç¡€æ ¸å¿ƒ"ã€"æ•°å­¦å·©å›º"ç­‰
  name       String   // ä»»åŠ¡åç§°
  description String?  // ä»»åŠ¡æè¿°
  defaultExp Int      @default(0) // é»˜è®¤ç»éªŒå€¼
  type       TaskType @default(TASK) // ä»»åŠ¡ç±»å‹
  difficulty Int?     // éš¾åº¦ç­‰çº§ 1-5
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([category, name])
  @@map("task_library")
}

// Habits - ä¹ æƒ¯å®šä¹‰
model Habit {
  id        String   @id @default(uuid())
  schoolId  String
  name      String   // ä¹ æƒ¯åç§°ï¼Œå¦‚"æ—©èµ·"ã€"é˜…è¯»"ã€"è¿åŠ¨"ç­‰
  description String?  // ä¹ æƒ¯æè¿°
  icon      String?  // ä¹ æƒ¯å›¾æ ‡
  expReward Int     @default(5) // æ‰“å¡å¥–åŠ±ç»éªŒå€¼
  pointsReward Int?  // æ‰“å¡å¥–åŠ±ç§¯åˆ†ï¼ˆå¯é€‰ï¼‰
  isActive  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  habitLogs HabitLog[]

  @@unique([schoolId, name])
  @@map("habits")
}

// Habit Logs - ä¹ æƒ¯æ‰“å¡è®°å½•
model HabitLog {
  id         String   @id @default(uuid())
  schoolId   String
  habitId    String
  studentId  String
  checkedAt  DateTime @default(now()) // æ‰“å¡æ—¶é—´
  streakDays Int      @default(1)     // è¿ç»­æ‰“å¡å¤©æ•°
  notes      String?             // å¤‡æ³¨

  // Relations
  school     School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  habit      Habit      @relation(fields: [habitId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("habit_logs")
}

// Challenges - æŒ‘æˆ˜ä»»åŠ¡
model Challenge {
  id          String   @id @default(uuid())
  schoolId    String
  title       String   // æŒ‘æˆ˜æ ‡é¢˜
  description String?  // æŒ‘æˆ˜æè¿°
  type        ChallengeType @default(PERSONAL) // æŒ‘æˆ˜ç±»å‹
  status      ChallengeStatus @default(DRAFT) // æŒ‘æˆ˜çŠ¶æ€
  creatorId   String   // åˆ›å»ºè€…IDï¼ˆteacherIdï¼‰
  startDate   DateTime @default(now()) // å¼€å§‹æ—¶é—´
  endDate     DateTime? // ç»“æŸæ—¶é—´
  rewardPoints Int      @default(0) // å®Œæˆå¥–åŠ±ç§¯åˆ†
  rewardExp   Int      @default(0) // å®Œæˆå¥–åŠ±ç»éªŒ
  maxParticipants Int      @default(2) // æœ€å¤§å‚ä¸äººæ•°
  metadata    Json?     // æŒ‘æˆ˜å…ƒæ•°æ®ï¼ˆè§„åˆ™ã€é¢˜ç›®ç­‰ï¼‰
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  creator         Teacher         @relation("ChallengeCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants     ChallengeParticipant[]

  @@map("challenges")
}

// Challenge Participants - æŒ‘æˆ˜å‚ä¸è€…
model ChallengeParticipant {
  id           String   @id @default(uuid())
  challengeId  String
  studentId    String
  joinedAt      DateTime @default(now()) // å‚ä¸æ—¶é—´
  status       ParticipantStatus @default(JOINED) // å‚ä¸çŠ¶æ€
  result       ParticipantResult? // å‚ä¸ç»“æœ
  score        Int?      // å¾—åˆ†
  notes        String?    // å¤‡æ³¨
  completedAt   DateTime? // å®Œæˆæ—¶é—´

  // Relations
  challenge    Challenge    @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([challengeId, studentId])
  @@map("challenge_participants")
}

// Badges - å‹‹ç« å®šä¹‰
model Badge {
  id          String   @id @default(uuid())
  schoolId    String
  name        String   // å‹‹ç« åç§°
  description String?  // å‹‹ç« æè¿°
  icon        String?  // å‹‹ç« å›¾æ ‡
  category    String   // å‹‹ç« ç±»åˆ«
  requirement  Json?    // è·å¾—æ¡ä»¶
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentBadges StudentBadge[]

  @@unique([schoolId, name])
  @@map("badges")
}

// Student Badges - å­¦ç”Ÿè·å¾—å‹‹ç« è®°å½•
model StudentBadge {
  id           String   @id @default(uuid())
  studentId    String
  badgeId      String
  awardedBy    String?   // æˆäºˆè€…IDï¼ˆteacherIdï¼‰
  awardedAt    DateTime @default(now())
  reason       String?  // æˆäºˆåŸå› 

  // Relations
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  badge        Badge        @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@map("student_badges")
}