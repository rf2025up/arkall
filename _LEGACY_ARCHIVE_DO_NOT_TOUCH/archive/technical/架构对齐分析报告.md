# StarJourney (æ˜Ÿé€”ä¸ä¼´) æ ¸å¿ƒé‡æ„ - æ¶æ„å¯¹é½åˆ†ææŠ¥å‘Š

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ†ææ—¶é—´**: 2025-12-11
**æ¶æ„å¸ˆ**: Claude Code (Senior Full-Stack Architect)
**é‡æ„ç›®æ ‡**: å®ç° v13.0 Ultimate UI ä¸åç«¯ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ•°æ®æµé—­ç¯

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### å½“å‰æŠ€æœ¯æ ˆæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (React + TypeScript)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ PrepView.tsx (v13.0 Ultimate) - ä¸‰ç§‘åŒå±å¤‡è¯¾é¡µé¢           â”‚
â”‚ â€¢ QCView.tsx - è´¨æ£€é¡µé¢                                    â”‚
â”‚ â€¢ SettleView.tsx - ç»“ç®—é¡µé¢                                  â”‚
â”‚ â€¢ mobile/ - ç§»åŠ¨ç«¯åº”ç”¨                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“ API Calls
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (Node.js + Express)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ arkok/server.js (ç«¯å£3000) - ä¸»æœåŠ¡å™¨                      â”‚
â”‚ â€¢ starj/star-server.js (ç«¯å£3001) - StarJourneyæœåŠ¡å™¨        â”‚
â”‚ â€¢ RESTful API æ¥å£                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“ PostgreSQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å…±äº«æ•°æ®åº“                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ students (æ ¸å¿ƒä¸šåŠ¡è¡¨)                                      â”‚
â”‚ â€¢ teams/groups/challenges/pk-matches (æ¸¸æˆåŒ–è¡¨)              â”‚
â”‚ â€¢ lms_lesson_plans (å·²å­˜åœ¨)                                  â”‚
â”‚ â€¢ lms_student_record (å·²å­˜åœ¨)                                â”‚
â”‚ â€¢ lms_mistakes/lms_academic_reports (å·²å­˜åœ¨)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å‘ç°ï¼šæ¶æ„é”™ä½åˆ†æ

#### âŒ å‰ç«¯ vs æ•°æ®åº“ç»“æ„å·®å¼‚

| å‰ç«¯æ•°æ®ç»“æ„ (PrepView.tsx) | ç°æœ‰æ•°æ®åº“å­—æ®µ | å·®å¼‚åˆ†æ | å‡çº§ä¼˜å…ˆçº§ |
|------------------------------|----------------|----------|-----------|
| `CourseInfo` (ä¸‰ç§‘å·®å¼‚åŒ–) | `lms_lesson_plans` æŒ‰ç§‘ç›®åˆ†è¡¨å­˜å‚¨ | ğŸ”´ **ä¸¥é‡ä¸åŒ¹é…** | P0 |
| `QC_CONFIG` (é¢œè‰²é…ç½®) | âŒ **ç¼ºå¤±** | âš ï¸ UIé…ç½®æœªæŒä¹…åŒ– | P2 |
| `TASK_LIBRARY` (11å¤§ç±»ç¡¬ç¼–ç ) | âŒ **ç¼ºå¤±** | ğŸ”´ **æ ¸å¿ƒåŠŸèƒ½æœªæŒä¹…åŒ–** | P0 |
| `publishPlan()` â†’ console.log | âŒ **æ— API** | ğŸ”´ **æ ¸å¿ƒåŠŸèƒ½é˜»å¡** | P0 |
| `specialTasks` (ä¸ªæ€§åŒ–åŠ é¤) | `lms_lesson_plans.special_tasks` | âœ… **å·²æ”¯æŒ** | P1 |
| `students.individual_progress` | âŒ **ç¼ºå¤±** | ğŸ”´ **å…³é”®ä¸šåŠ¡é€»è¾‘ç¼ºå¤±** | P0 |

---

## ğŸ› ï¸ æ•°æ®åº“å‡çº§æ–¹æ¡ˆ (Step 1)

### æ–‡ä»¶åˆ—è¡¨
- `database/migrations/001_add_lms_task_library.sql`
- `database/migrations/002_upgrade_lms_tables.sql`
- `database/migrations/003_add_student_progress.sql`

### 1. æ–°å¢ lms_task_library è¡¨
```sql
-- æ–‡ä»¶: database/migrations/001_add_lms_task_library.sql
-- ç›®çš„: å°†å‰ç«¯11å¤§ç±»ä»»åŠ¡åº“æŒä¹…åŒ–

CREATE TABLE IF NOT EXISTS lms_task_library (
  id SERIAL PRIMARY KEY,
  category VARCHAR(100) NOT NULL,           -- "ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)"
  name VARCHAR(200) NOT NULL,               -- "å®Œæˆæ•°å­¦ä¹¦é¢ä½œä¸š"
  default_exp INTEGER DEFAULT 10,          -- é»˜è®¤ç»éªŒå€¼
  is_active BOOLEAN DEFAULT TRUE,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥å‰ç«¯å†™æ­»çš„11å¤§ç±»ä»»åŠ¡
INSERT INTO lms_task_library (category, name, default_exp, sort_order) VALUES
-- åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'å®Œæˆæ•°å­¦ä¹¦é¢ä½œä¸š', 15, 1),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'å®Œæˆè¯­æ–‡ä¹¦é¢ä½œä¸š', 15, 2),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'å®Œæˆè‹±è¯­ä¹¦é¢ä½œä¸š', 15, 3),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'ä½œä¸šçš„è‡ªä¸»æ£€æŸ¥', 10, 4),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'é”™é¢˜çš„çº¢ç¬”è®¢æ­£', 12, 5),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'é”™é¢˜çš„æ‘˜æŠ„ä¸å½’å› ', 10, 6),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'ç”¨ä¸‰è‰²ç¬”æ³•æ•´ç†ä½œä¸š', 15, 7),
('ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)', 'è‡ªè¯„å½“æ—¥ä½œä¸šè´¨é‡(1-5æ˜Ÿ)', 5, 8),

-- æ•°å­¦å·©å›º
('äºŒã€æ•°å­¦å·©å›º', '100é“å£ç®—ç»ƒä¹ ', 20, 9),
('äºŒã€æ•°å­¦å·©å›º', '5é“æ—§é”™é¢˜(1æ˜Ÿ)çš„é‡åš', 25, 10),
('äºŒã€æ•°å­¦å·©å›º', 'ä¸€é¡¹è€å¸ˆå®šåˆ¶çš„æ•°å­¦æ‹“å±•', 30, 11),
('äºŒã€æ•°å­¦å·©å›º', 'ä¸€é“è¯´é¢˜ç»ƒä¹ (è®²æ€è·¯)', 20, 12),
('äºŒã€æ•°å­¦å·©å›º', 'æ‰¾ä¸€é“ç”Ÿæ´»ä¸­çš„æ•°å­¦é—®é¢˜', 25, 13),
('äºŒã€æ•°å­¦å·©å›º', 'é«˜é˜¶ï¼šæ‰¾1ç±»æ¯é¢˜', 35, 14),
('äºŒã€æ•°å­¦å·©å›º', 'é«˜é˜¶ï¼šä¸»åŠ¨é‡åšæ˜¨å¤©é”™é¢˜', 25, 15),
('äºŒã€æ•°å­¦å·©å›º', 'é«˜é˜¶ï¼šç”¨è§£é¢˜æ¨¡å‹ç‹¬ç«‹ç»ƒé¢˜', 30, 16),

-- è¯­æ–‡å·©å›º
('ä¸‰ã€è¯­æ–‡å·©å›º', 'ç”Ÿå­—/è¯è¯­çš„å¬å†™ç»ƒä¹ ', 15, 17),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'å¬å†™é”™å­—çš„è¡¥å†™(3é)', 10, 18),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'ä¸€ç»„çœ‹æ‹¼éŸ³å†™è¯è¯­', 15, 19),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'è¯¾æ–‡é‡ç‚¹çŸ¥è¯†çš„é—®ç­”è¿‡å…³', 20, 20),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'è¯¾æ–‡å¡«ç©ºä¸é˜…è¯»èƒŒè¯µ', 20, 21),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'è¯¾å†…é˜…è¯»ç†è§£/å¤è¯—é»˜å†™', 25, 22),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'ä»¿å†™è¯¾æ–‡ä¸­çš„ä¸€ä¸ªå¥½å¥', 15, 23),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'ä¸ºç”Ÿå­—ç¼–é¡ºå£æºœæˆ–å°æ•…äº‹', 20, 24),
('ä¸‰ã€è¯­æ–‡å·©å›º', 'è¿ç”¨ä¸€ç§é˜…è¯»ç†è§£æ¨¡æ¿', 15, 25),

-- è¯­æ–‡æ‹“å±•
('å››ã€è¯­æ–‡æ‹“å±•', 'æŸ¥å­—å…¸/è®¤éƒ¨é¦–/åœˆé‡Šä¹‰', 10, 26),
('å››ã€è¯­æ–‡æ‹“å±•', 'ç»„ä¸€ç»„Â·è¾¨ä¸€è¾¨(å½¢è¿‘å­—)', 12, 27),
('å››ã€è¯­æ–‡æ‹“å±•', 'æƒ³ä¸€æƒ³Â·è®°ä¸€è®°(æˆè¯­æ¥é¾™)', 15, 28),

-- è‹±è¯­å·©å›º
('äº”ã€è‹±è¯­å·©å›º', 'å•è¯çš„é»˜å†™ç»ƒä¹ ', 15, 29),
('äº”ã€è‹±è¯­å·©å›º', 'è¯¾æ–‡çš„æœ—è¯»ç»ƒä¹ (10åˆ†é’Ÿ)', 12, 30),
('äº”ã€è‹±è¯­å·©å›º', 'ç”¨ä»Šæ—¥å•è¯ç¼–3å¥å°å¯¹è¯', 18, 31),
('äº”ã€è‹±è¯­å·©å›º', 'åˆ¶ä½œä¸€å¼ å•è¯å¡', 10, 32),

-- é˜…è¯»ä»»åŠ¡
('å…­ã€é˜…è¯»ä»»åŠ¡', 'å¹´çº§åŒæ­¥é˜…è¯»', 20, 33),
('å…­ã€é˜…è¯»ä»»åŠ¡', 'è¯¾å¤–é˜…è¯»30åˆ†é’Ÿ', 15, 34),
('å…­ã€é˜…è¯»ä»»åŠ¡', 'å¡«å†™é˜…è¯»è®°å½•å•', 10, 35),
('å…­ã€é˜…è¯»ä»»åŠ¡', 'æ‘˜æŠ„å¥½è¯é‡‘å¥å¹¶ç®€è¿°', 15, 36),
('å…­ã€é˜…è¯»ä»»åŠ¡', 'ç”»äººç‰©å…³ç³»å›¾æˆ–é¢„æµ‹æƒ…èŠ‚', 18, 37),
('å…­ã€é˜…è¯»ä»»åŠ¡', 'å½•åˆ¶é˜…è¯»å°åˆ†äº«', 20, 38),
('å…­ã€é˜…è¯»ä»»åŠ¡', 'é˜…è¯»æˆè¯­æ•…äº‹å¹¶é€ å¥', 15, 39),

-- è‡ªä¸»è§„åˆ’
('ä¸ƒã€è‡ªä¸»è§„åˆ’', 'è‡ªä¸»è§„åˆ’å¤ä¹ ä»»åŠ¡', 10, 40),
('ä¸ƒã€è‡ªä¸»è§„åˆ’', 'è‡ªä¸»è§„åˆ’é¢„ä¹ ä»»åŠ¡', 10, 41),
('ä¸ƒã€è‡ªä¸»è§„åˆ’', 'åˆ¶å®šä¸€ä¸ªå­¦ä¹ å°è®¡åˆ’', 15, 42),
('ä¸ƒã€è‡ªä¸»è§„åˆ’', 'è®¾å®šæ”¹è¿›ç›®æ ‡å¹¶æ‰“å¡', 12, 43),

-- æ•´ç†ä¸è´¡çŒ®
('å…«ã€æ•´ç†ä¸è´¡çŒ®', 'ç¦»æ ¡å‰çš„ä¸ªäººå«ç”Ÿæ¸…ç†', 8, 44),
('å…«ã€æ•´ç†ä¸è´¡çŒ®', 'ç¦»æ ¡å‰çš„ä¹¦åŒ…æ•´ç†', 8, 45),
('å…«ã€æ•´ç†ä¸è´¡çŒ®', 'é›†ä½“è´¡çŒ®ä»»åŠ¡(æµ‡èŠ±ç­‰)', 10, 46),
('å…«ã€æ•´ç†ä¸è´¡çŒ®', 'å…‰ç›˜è¡ŒåŠ¨ï¼Œç»´æŠ¤ç§©åº', 8, 47),
('å…«ã€æ•´ç†ä¸è´¡çŒ®', 'æ¨èä¸€æœ¬ä¹¦å¹¶å†™æ¨èè¯­', 15, 48),

-- äº’åŠ©ä¸åˆ›æ–°
('ä¹ã€äº’åŠ©ä¸åˆ›æ–°', 'å¸®åŠ©åŒå­¦(è®²è§£/æ‰“å°)', 12, 49),
('ä¹ã€äº’åŠ©ä¸åˆ›æ–°', 'åˆ›æ„è¡¨è¾¾(ç”»ç”»/æ‰‹å·¥)', 15, 50),
('ä¹ã€äº’åŠ©ä¸åˆ›æ–°', 'å¥åº·æ´»åŠ›ä»»åŠ¡(è¿åŠ¨)', 10, 51),
('ä¹ã€äº’åŠ©ä¸åˆ›æ–°', 'å½•åˆ¶å°è€å¸ˆè®²é¢˜è§†é¢‘', 20, 52),

-- è¯¾å ‚æˆé•¿
('åã€è¯¾å ‚æˆé•¿', 'è¯¾å ‚ä¸¾æ‰‹å›ç­”1æ¬¡é—®é¢˜', 8, 53),
('åã€è¯¾å ‚æˆé•¿', 'å‡†å¤‡1ä¸ªæ€è€ƒçš„é—®é¢˜', 5, 54),
('åã€è¯¾å ‚æˆé•¿', 'ç”³è¯·æ¿æ¼”/é¢†è¯»/æ±‡æŠ¥', 10, 55),
('åã€è¯¾å ‚æˆé•¿', 'è®°å½•è€å¸ˆçš„é‡‘å¥', 8, 56),
('åã€è¯¾å ‚æˆé•¿', 'å¸®åŒæ¡Œç†è§£çŸ¥è¯†ç‚¹', 12, 57),

-- å®¶åº­è”ç»“
('åä¸€ã€å®¶åº­è”ç»“', 'ä¸å®¶äººå…±è¯»30åˆ†é’Ÿ', 15, 58),
('åä¸€ã€å®¶åº­è”ç»“', 'å‘å®¶é•¿è®²è§£å­¦ä¹ æ–¹æ³•', 12, 59),
('åä¸€ã€å®¶åº­è”ç»“', 'å¸®å®¶é‡Œåšä¸€é¡¹å®¶åŠ¡', 10, 60),
('åä¸€ã€å®¶åº­è”ç»“', 'æ•™å®¶äººæ–°è¯/æˆè¯­/å¥å­', 15, 61),
('åä¸€ã€å®¶åº­è”ç»“', 'å¤ä¹ åŸºç¡€çŸ¥è¯†ç»™çˆ¸å¦ˆçœ‹', 12, 62),
('åä¸€ã€å®¶åº­è”ç»“', 'åˆ†äº«æ”¹è¿›ç›®æ ‡æƒ…å†µ', 10, 63),
('åä¸€ã€å®¶åº­è”ç»“', 'ç”¨æ•°å­¦è§£å†³å®¶åº­é—®é¢˜', 20, 64);

CREATE INDEX IF NOT EXISTS idx_lms_task_library_category ON lms_task_library(category);
CREATE INDEX IF NOT EXISTS idx_lms_task_library_active ON lms_task_library(is_active);
```

### 2. å‡çº§ lms_lesson_plans è¡¨ç»“æ„
```sql
-- æ–‡ä»¶: database/migrations/002_upgrade_lms_tables.sql
-- ç›®çš„: æ”¯æŒä¸‰ç§‘å·®å¼‚åŒ–è¿›åº¦ç»“æ„å’ŒQCé…ç½®

ALTER TABLE lms_lesson_plans
ADD COLUMN IF NOT EXISTS course_progress JSONB DEFAULT '{}',
ADD COLUMN IF NOT EXISTS qc_config JSONB DEFAULT '{}',
ADD COLUMN IF NOT EXISTS publish_date DATE DEFAULT CURRENT_DATE;

-- è¯´æ˜:
-- course_progress ç»“æ„ç¤ºä¾‹:
-- {
--   "chinese": {"unit": "3", "lesson": "2", "title": "å¤è¯—äºŒé¦–"},
--   "math": {"unit": "4", "lesson": "1", "title": "é™¤æ³•"},
--   "english": {"unit": "2", "title": "Hello World"}  -- è‹±è¯­æ— lesson
-- }

-- qc_config ç»“æ„ç¤ºä¾‹:
-- {
--   "chinese": ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ"],
--   "math": ["å£ç®—è¾¾æ ‡", "ç«–å¼è®¡ç®—"],
--   "english": ["å•è¯é»˜å†™"]
-- }

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_lms_lesson_plans_publish_date ON lms_lesson_plans(publish_date);
CREATE INDEX IF NOT EXISTS idx_lms_lesson_plans_course_progress ON lms_lesson_plans USING GIN(course_progress);
```

### 3. å‡çº§ lms_student_record è¡¨ç»“æ„
```sql
-- ç»§ç»­åœ¨ 002_upgrade_lms_tables.sql ä¸­æ·»åŠ 

ALTER TABLE lms_student_record
ADD COLUMN IF NOT EXISTS task_category VARCHAR(20) DEFAULT 'TASK' CHECK (task_category IN ('QC', 'TASK', 'SPECIAL')),
ADD COLUMN IF NOT EXISTS exp_awarded INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS is_special BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS completed_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS batch_id VARCHAR(100) DEFAULT NULL;

-- é‡å‘½å/è°ƒæ•´ç°æœ‰å­—æ®µ
-- å°†ç°æœ‰çš„ task_type å­—æ®µå«ä¹‰è°ƒæ•´ä¸º task_category
-- å¦‚æœ task_type å·²å­˜åœ¨ä¸”å«ä¹‰ä¸åŒï¼Œéœ€è¦æ•°æ®è¿ç§»
DO $$
BEGIN
    -- æ£€æŸ¥å¹¶æ‰§è¡Œæ•°æ®è¿ç§»
    IF EXISTS (SELECT 1 FROM information_schema.columns
               WHERE table_name = 'lms_student_record' AND column_name = 'task_type') THEN
        UPDATE lms_student_record
        SET task_category = CASE
            WHEN task_type = 'QC' THEN 'QC'
            WHEN task_type = 'TASK' THEN 'TASK'
            ELSE 'TASK'
        END;
    END IF;
END $$;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_lms_student_record_category ON lms_student_record(task_category);
CREATE INDEX IF NOT EXISTS idx_lms_student_record_batch_id ON lms_student_record(batch_id);
```

### 4. å‡çº§ students è¡¨ç»“æ„
```sql
-- æ–‡ä»¶: database/migrations/003_add_student_progress.sql
-- ç›®çš„: æ”¯æŒä¸ªäººè¿›åº¦è¦†ç›–å…¨ç­è¿›åº¦çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

ALTER TABLE students
ADD COLUMN IF NOT EXISTS individual_progress JSONB DEFAULT '{}',
ADD COLUMN IF NOT EXISTS teacher_id VARCHAR(100) DEFAULT 'default_teacher',
ADD COLUMN IF NOT EXISTS class_id INTEGER REFERENCES groups(id) ON DELETE SET NULL,
ADD COLUMN IF NOT EXISTS current_grade_level INTEGER DEFAULT 3;  -- å‡è®¾ä¸‰å¹´çº§

-- individual_progress ç»“æ„ç¤ºä¾‹:
-- {
--   "chinese": {"unit": "2", "lesson": "1", "title": "ç§‹å¤©çš„å›¾ç”»", "is_override": true},
--   "math": {"unit": "3", "lesson": "2", "title": "åŠ æ³•", "is_override": true},
--   "english": null  -- ä½¿ç”¨ç­çº§é»˜è®¤è¿›åº¦
-- }

-- æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_students_teacher_id ON students(teacher_id);
CREATE INDEX IF NOT EXISTS idx_students_class_id ON students(class_id);
CREATE INDEX IF NOT EXISTS idx_students_individual_progress ON students USING GIN(individual_progress);
```

---

## ğŸ”§ åç«¯APIå®ç°æ–¹æ¡ˆ (Step 2)

### æ–‡ä»¶åˆ—è¡¨
- `arkok/server.js` - æ·»åŠ  LMS ç›¸å…³è·¯ç”±
- `arkok/services/lms-service.js` - ä¸šåŠ¡é€»è¾‘å±‚ (æ–°å»º)
- `arkok/middleware/validation.js` - æ•°æ®éªŒè¯ä¸­é—´ä»¶ (æ–°å»º)

### 1. å‘å¸ƒå¤‡è¯¾æ¥å£å®ç°è®¡åˆ’
```javascript
// æ–‡ä»¶: arkok/server.js - æ–°å¢è·¯ç”±

// LMSç›¸å…³è·¯ç”±
app.post('/api/plans/publish', lmsService.publishPlan);
app.get('/api/plans/today', lmsService.getTodayPlan);
app.get('/api/students/:id/academic-map', lmsService.getStudentAcademicMap);
app.get('/api/meta/tasks', lmsService.getTaskLibrary);
app.patch('/api/students/:id/progress', lmsService.updateStudentProgress);
app.get('/api/students/:id/progress', lmsService.getStudentProgress);
```

### 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¶æ„
```javascript
// æ–‡ä»¶: arkok/services/lms-service.js (æ–°å»º)

class LMSService {
  // ğŸ”¥ æ ¸å¿ƒ: å‘å¸ƒå¤‡è¯¾é€»è¾‘
  async publishPlan(planData) {
    // 1. éªŒè¯æ•°æ®æ ¼å¼
    // 2. å†™å…¥ lms_lesson_plans (course_progress, qc_config)
    // 3. Fan-out: ä¸ºå…¨ç­å­¦ç”Ÿç”Ÿæˆ lms_student_record
    // 4. å¤„ç†ä¸ªæ€§åŒ–åŠ é¤ (specialTasks)
    // 5. è¿”å›å‘å¸ƒç»“æœç»Ÿè®¡
  }

  // ğŸ”¥ æ ¸å¿ƒ: å­¦ç”Ÿå­¦ä¸šåœ°å›¾
  async getStudentAcademicMap(studentId) {
    // 1. è¯»å–ä¸ªäººè¿›åº¦ (students.individual_progress)
    // 2. è¯»å–ç­çº§è¿›åº¦ (lms_lesson_plans)
    // 3. åˆå¹¶ç”Ÿæˆä¸ªäººå­¦ä¸šåœ°å›¾
    // 4. æŸ¥è¯¢å·²å®Œæˆä»»åŠ¡å†å²
    // 5. è¿”å›ç»“æ„åŒ–å­¦ä¸šæ•°æ®
  }

  // ğŸ”¥ æ ¸å¿ƒ: ä¸ªäººè¿›åº¦ç®¡ç†
  async updateStudentProgress(studentId, progressData) {
    // 1. éªŒè¯æƒé™
    // 2. æ›´æ–° students.individual_progress
    // 3. è§¦å‘ç›¸å…³ lms_student_record æ›´æ–°
    // 4. è®°å½•æ“ä½œæ—¥å¿—
  }
}
```

### 3. APIæ¥å£è¯¦ç»†è®¾è®¡

#### POST /api/plans/publish
```javascript
// è¯·æ±‚æ•°æ®ç»“æ„ (æ¥è‡ª PrepView.tsx)
{
  "publishDate": "2025-12-11",
  "courseInfo": {
    "chinese": {"unit": "3", "lesson": "2", "title": "å¤è¯—äºŒé¦–"},
    "math": {"unit": "4", "lesson": "1", "title": "é™¤æ³•"},
    "english": {"unit": "2", "title": "Hello World"}
  },
  "qcItems": {
    "chinese": ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ"],
    "math": ["å£ç®—è¾¾æ ‡", "ç«–å¼è®¡ç®—"],
    "english": ["å•è¯é»˜å†™"]
  },
  "tasks": ["å®Œæˆæ•°å­¦ä¹¦é¢ä½œä¸š", "è¯¾å¤–é˜…è¯»30åˆ†é’Ÿ"],
  "specialTasks": [
    {
      "students": ["å¼ å°æ˜", "æå°èŠ±"],  // å­¦ç”Ÿå§“åæ•°ç»„
      "tasks": ["ç½šæŠ„é”™é¢˜", "æœ—è¯»è¯¾æ–‡"]
    }
  ],
  "teacherId": "teacher_001"
}

// å“åº”æ•°æ®ç»“æ„
{
  "success": true,
  "data": {
    "planId": "uuid-123",
    "createdRecords": 25,        // åˆ›å»ºçš„è®°å½•æ€»æ•°
    "affectedStudents": 8,        // å½±å“çš„å­¦ç”Ÿæ•°
    "specialTaskCount": 6,        // ä¸ªæ€§åŒ–ä»»åŠ¡æ•°é‡
    "estimatedTotalExp": 320      // é¢„ä¼°æ€»ç»éªŒå€¼
  }
}
```

#### GET /api/students/{id}/academic-map
```javascript
// å“åº”æ•°æ®ç»“æ„
{
  "success": true,
  "data": {
    "studentInfo": {
      "id": 123,
      "name": "å¼ å°æ˜",
      "class_name": "ä¸‰å¹´çº§1ç­"
    },
    "currentProgress": {
      "chinese": {"unit": "3", "lesson": "2", "title": "å¤è¯—äºŒé¦–", "is_override": true},
      "math": {"unit": "4", "lesson": "1", "title": "é™¤æ³•", "is_override": false},
      "english": {"unit": "2", "title": "Hello World", "is_override": false}
    },
    "academicMap": [
      {
        "subject": "chinese",
        "lessons": [
          {
            "unit": 1, "lesson": 1, "title": "æˆ‘ä»¬çš„æ°‘æ—å°å­¦",
            "status": "completed",  // completed, current, pending
            "qcItems": ["æ‹¼éŸ³è®¤è¯»", "è¯¾æ–‡æœ—è¯»"],
            "completedDate": "2025-11-28"
          },
          {
            "unit": 2, "lesson": 1, "title": "ç§‹å¤©çš„å›¾ç”»",
            "status": "completed",
            "qcItems": ["ç”Ÿå­—å¬å†™", "è¯è¯­ç†è§£"],
            "completedDate": "2025-12-05"
          },
          {
            "unit": 3, "lesson": 2, "title": "å¤è¯—äºŒé¦–",
            "status": "current",
            "qcItems": ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ", "å¤è¯—é»˜å†™"],
            "pendingCount": 2,
            "completedCount": 1
          }
        ]
      }
    ],
    "taskHistory": [
      {
        "date": "2025-12-11",
        "category": "SPECIAL",
        "taskName": "ç½šæŠ„é”™é¢˜",
        "expAwarded": 30,
        "completedAt": "2025-12-11T14:30:00Z"
      },
      {
        "date": "2025-12-10",
        "category": "TASK",
        "taskName": "å®Œæˆæ•°å­¦ä¹¦é¢ä½œä¸š",
        "expAwarded": 15,
        "completedAt": "2025-12-10T16:20:00Z"
      }
    ]
  }
}
```

---

## ğŸ¨ å‰ç«¯æ•°æ®å¯¹æ¥æ–¹æ¡ˆ (Step 3)

### æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨
- `arkok/mobile/pages/PrepView.tsx` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `arkok/mobile/services/api.ts` - APIå°è£… (æ–°å¢/ä¿®æ”¹)
- `arkok/mobile/hooks/useTaskLibrary.ts` - è‡ªå®šä¹‰Hook (æ–°å¢)

### 1. PrepView.tsx å…³é”®ä¿®æ”¹ç‚¹

#### A. ç§»é™¤Mockæ•°æ®ï¼Œæ”¹ä¸ºAPIè·å–
```typescript
// åŸä»£ç  (ç¬¬38-51è¡Œ)
const TASK_LIBRARY = [
  { category: "ä¸€ã€åŸºç¡€å­¦ä¹ (æ ¸å¿ƒ)", items: [...] },
  // ... ç¡¬ç¼–ç æ•°æ®
];

// æ–°ä»£ç 
const [taskLibrary, setTaskLibrary] = useState<TaskCategory[]>([]);
const [isLoading, setIsLoading] = useState(false);

useEffect(() => {
  const loadTaskLibrary = async () => {
    try {
      setIsLoading(true);
      const response = await fetch('/api/meta/tasks');
      const data = await response.json();
      setTaskLibrary(data.data);
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡åº“å¤±è´¥:', error);
      // é™çº§ï¼šä½¿ç”¨é»˜è®¤ä»»åŠ¡åº“
      setTaskLibrary(getDefaultTaskLibrary());
    } finally {
      setIsLoading(false);
    }
  };

  loadTaskLibrary();
}, []);
```

#### B. publishPlan å‡½æ•°é‡æ„
```typescript
// åŸä»£ç  (ç¬¬199-210è¡Œ)
const publishPlan = () => {
  const plan = {
    date: dateStr,
    courseInfo,
    qc: selectedQC,
    tasks: selectedTasks,
    specialTasks
  };
  console.log("å‘å¸ƒæ•°æ®:", plan);
  alert("ä»Šæ—¥è®¡åˆ’å‘å¸ƒæˆåŠŸï¼");
};

// æ–°ä»£ç 
const publishPlan = async () => {
  if (isLoading) {
    alert("æ­£åœ¨åŠ è½½ä»»åŠ¡åº“ï¼Œè¯·ç¨å€™...");
    return;
  }

  setIsLoading(true);

  try {
    // 1. æ„å»ºå‘å¸ƒæ•°æ®
    const planData = {
      publishDate: dateStr,
      courseInfo,
      qcItems: selectedQC,
      tasks: selectedTasks,
      specialTasks,
      teacherId: getCurrentTeacherId() // éœ€è¦å®ç°
    };

    // 2. APIè°ƒç”¨
    const response = await fetch('/api/plans/publish', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(planData)
    });

    const result = await response.json();

    if (result.success) {
      // 3. æˆåŠŸå¤„ç†
      alert(`å‘å¸ƒæˆåŠŸï¼å·²ä¸º${result.data.affectedStudents}åå­¦ç”Ÿåˆ›å»º${result.data.createdRecords}é¡¹å­¦ä¹ ä»»åŠ¡`);

      // 4. å¯é€‰ï¼šé‡ç½®è¡¨å•æˆ–è·³è½¬é¡µé¢
      resetForm(); // éœ€è¦å®ç°

      // 5. å¯é€‰ï¼šè·³è½¬åˆ°è´¨æ£€é¡µé¢
      // window.location.href = '/qc';

    } else {
      throw new Error(result.error || 'å‘å¸ƒå¤±è´¥');
    }

  } catch (error) {
    console.error('å‘å¸ƒå¤±è´¥:', error);
    alert(`å‘å¸ƒå¤±è´¥: ${error.message}`);
  } finally {
    setIsLoading(false);
  }
};
```

#### C. UIçŠ¶æ€ç®¡ç†å¢å¼º
```typescript
// æ–°å¢çŠ¶æ€
const [publishStatus, setPublishStatus] = useState<'idle' | 'publishing' | 'success' | 'error'>('idle');
const [publishMessage, setPublishMessage] = useState('');

// UIä¼˜åŒ–
return (
  <div className="min-h-screen bg-[#F2F4F7] text-[#1E293B] pb-40 font-sans">
    {/* Header */}
    <div className="px-6 pt-14 pb-4 sticky top-0 z-30 bg-[#F2F4F7]/95 backdrop-blur-md flex justify-between items-center border-b border-slate-200/50">
      <div className="flex items-baseline gap-3">
        <h1 className="text-2xl font-bold tracking-tight text-slate-900">ä»Šæ—¥å¤‡è¯¾</h1>
        <p className="text-xs font-semibold text-slate-400">{dateStr}</p>
      </div>
      <button
        onClick={publishPlan}
        disabled={isLoading || publishStatus === 'publishing'}
        className={`px-5 py-2.5 rounded-2xl text-sm font-bold shadow-lg shadow-slate-200/50 transition-all ${
          isLoading || publishStatus === 'publishing'
            ? 'bg-slate-400 text-gray-200 cursor-not-allowed'
            : 'bg-slate-900 text-white hover:bg-slate-800 active:scale-95'
        }`}
      >
        {publishStatus === 'publishing' ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ'}
      </button>
    </div>

    {/* çŠ¶æ€æç¤º */}
    {publishStatus === 'success' && (
      <div className="px-6 py-3 bg-green-50 border border-green-200 mx-6 mt-4 rounded-xl">
        <p className="text-green-800 text-sm font-medium">âœ… {publishMessage}</p>
      </div>
    )}

    {publishStatus === 'error' && (
      <div className="px-6 py-3 bg-red-50 border border-red-200 mx-6 mt-4 rounded-xl">
        <p className="text-red-800 text-sm font-medium">âŒ {publishMessage}</p>
      </div>
    )}

    {/* åŸæœ‰å†…å®¹ä¿æŒä¸å˜ */}
    {/* ... */}
  </div>
);
```

### 2. APIæœåŠ¡å°è£…
```typescript
// æ–‡ä»¶: arkok/mobile/services/api.ts (æ–°å¢æˆ–ä¿®æ”¹)

interface TaskLibraryResponse {
  success: boolean;
  data: TaskCategory[];
}

interface PublishPlanResponse {
  success: boolean;
  data: {
    planId: string;
    createdRecords: number;
    affectedStudents: number;
    specialTaskCount: number;
    estimatedTotalExp: number;
  };
  message?: string;
}

class LMSService {
  // è·å–ä»»åŠ¡åº“
  static async getTaskLibrary(): Promise<TaskCategory[]> {
    const response = await fetch('/api/meta/tasks');
    const result: TaskLibraryResponse = await response.json();
    return result.data;
  }

  // å‘å¸ƒå¤‡è¯¾è®¡åˆ’
  static async publishPlan(planData: any): Promise<PublishPlanResponse> {
    const response = await fetch('/api/plans/publish', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(planData)
    });
    return await response.json();
  }

  // è·å–å­¦ç”Ÿå­¦ä¸šåœ°å›¾
  static async getStudentAcademicMap(studentId: number) {
    const response = await fetch(`/api/students/${studentId}/academic-map`);
    return await response.json();
  }
}

export default LMSService;
```

---

## ğŸš¨ é£é™©åˆ†æä¸æ§åˆ¶æªæ–½

### ğŸ”´ P0çº§é£é™© (é˜»å¡æ€§)

#### 1. æ•°æ®åº“è¿ç§»é£é™©
**é£é™©**: ç°æœ‰ç”Ÿäº§æ•°æ®åœ¨è¡¨ç»“æ„å˜æ›´è¿‡ç¨‹ä¸­å¯èƒ½ä¸¢å¤±æˆ–ä¸ä¸€è‡´
**æ§åˆ¶æªæ–½**:
```sql
-- è¿ç§»å‰æ•°æ®å¤‡ä»½
CREATE TABLE lms_lesson_plans_backup_20251211 AS SELECT * FROM lms_lesson_plans;
CREATE TABLE lms_student_record_backup_20251211 AS SELECT * FROM lms_student_record;
CREATE TABLE students_backup_20251211 AS SELECT * FROM students;

-- è¿ç§»è„šæœ¬äº‹åŠ¡åŒ–æ‰§è¡Œ
BEGIN;
-- æ‰§è¡ŒALTER TABLEè¯­å¥
-- éªŒè¯æ•°æ®å®Œæ•´æ€§
COMMIT;
```

#### 2. APIå…¼å®¹æ€§é£é™©
**é£é™©**: æ–°APIä¸ç°æœ‰å‰ç«¯ç»„ä»¶ä¸å…¼å®¹ï¼Œå¯¼è‡´åŠŸèƒ½ä¸­æ–­
**æ§åˆ¶æªæ–½**:
```javascript
// æ¸è¿›å¼APIéƒ¨ç½²
app.post('/api/plans/publish-v2', lmsService.publishPlan); // æ–°API
app.post('/api/plans/publish', (req, res) => {          // ä¿æŒæ—§APIå…¼å®¹
  console.log('Legacy publish API called');
  res.json({ success: true, message: 'Legacy endpoint' });
});
```

### ğŸŸ¡ P1çº§é£é™© (é‡è¦)

#### 3. å­¦ç”Ÿåç§°è½¬æ¢é£é™©
**é£é™©**: å‰ç«¯ä¼ é€’å­¦ç”Ÿå§“åï¼Œåç«¯éœ€è¦è½¬æ¢ä¸ºIDï¼Œè½¬æ¢å¤±è´¥å¯¼è‡´æ•°æ®ä¸¢å¤±
**æ§åˆ¶æªæ–½**:
```javascript
// æ‰¹é‡åç§°è½¬IDçš„å®¹é”™å¤„ç†
async function convertNamesToIds(studentNames: string[]): Promise<number[]> {
  const ids = [];
  const notFound = [];

  for (const name of studentNames) {
    const student = await Student.findOne({ where: { name } });
    if (student) {
      ids.push(student.id);
    } else {
      notFound.push(name);
    }
  }

  if (notFound.length > 0) {
    console.warn(`å­¦ç”Ÿæœªæ‰¾åˆ°: ${notFound.join(', ')}`);
    // å‘é€å‘Šè­¦æˆ–è®°å½•æ—¥å¿—
  }

  return ids;
}
```

#### 4. å‰ç«¯çŠ¶æ€ç®¡ç†å¤æ‚åº¦
**é£é™©**: APIè°ƒç”¨å¤±è´¥æ—¶ï¼Œå‰ç«¯çŠ¶æ€å¯èƒ½å‡ºç°ä¸ä¸€è‡´
**æ§åˆ¶æªæ–½**:
```typescript
// çŠ¶æ€ç®¡ç†æ¨¡å¼
class StateManager {
  private pendingUpdates = new Map();

  async updateWithRollback(key: string, updateFn: Function) {
    const backup = this.getBackup(key);

    try {
      const result = await updateFn();
      this.pendingUpdates.delete(key);
      return result;
    } catch (error) {
      this.restoreBackup(key, backup);
      throw error;
    }
  }
}
```

---

## ğŸ“… å®æ–½æ—¶é—´çº¿

### Phase 1: æ•°æ®åº“å‡çº§ (Day 1)
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§
- [ ] åˆ›å»ºå¤‡ä»½ç­–ç•¥

### Phase 2: åç«¯APIå¼€å‘ (Day 2-3)
- [ ] å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚
- [ ] å¼€å‘å¸ƒè¯¾å‘å¸ƒæ¥å£
- [ ] å®ç°å­¦ä¸šåœ°å›¾æ¥å£
- [ ] æ·»åŠ æ•°æ®éªŒè¯ä¸­é—´ä»¶

### Phase 3: å‰ç«¯é›†æˆ (Day 4)
- [ ] ä¿®æ”¹PrepView.tsx
- [ ] å®ç°APIæœåŠ¡å°è£…
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

### Phase 4: æµ‹è¯•ä¸ä¼˜åŒ– (Day 5)
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

---

## ğŸ“ éœ€è¦ç¡®è®¤çš„é—®é¢˜

1. **æ•™å¸ˆèº«ä»½ç®¡ç†**: `getCurrentTeacherId()` çš„å®ç°æ–¹å¼
2. **ç­çº§æ•°æ®ç»“æ„**: å½“å‰ `groups` è¡¨çš„ç»„ç»‡æ–¹å¼
3. **å­¦ç”ŸIDæ˜ å°„**: æ˜¯å¦éœ€è¦å»ºç«‹åç§°åˆ°IDçš„ç¼“å­˜æœºåˆ¶
4. **å‘å¸ƒæˆåŠŸæµç¨‹**: å‘å¸ƒåæ˜¯å¦è‡ªåŠ¨è·³è½¬åˆ°è´¨æ£€é¡µé¢
5. **é”™è¯¯å¤„ç†ç­–ç•¥**: éƒ¨åˆ†å­¦ç”Ÿåˆ›å»ºå¤±è´¥æ—¶çš„å¤„ç†æ–¹å¼

---

**å‡†å¤‡çŠ¶æ€**: âœ… åˆ†æå®Œæˆï¼Œç­‰å¾…ç¡®è®¤åå¼€å§‹å®æ–½
**é¢„è®¡å·¥ä½œé‡**: 5ä¸ªå·¥ä½œæ—¥
**é£é™©ç­‰çº§**: ä¸­ç­‰ (æœ‰å®Œæ•´çš„å›æ»šæ–¹æ¡ˆ)

è¯·ç¡®è®¤ä»¥ä¸Šåˆ†ææ— è¯¯ï¼Œæˆ‘å°†å¼€å§‹ç”Ÿæˆå…·ä½“çš„ä»£ç å®ç°ã€‚