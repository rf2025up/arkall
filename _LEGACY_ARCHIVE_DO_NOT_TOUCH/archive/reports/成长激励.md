# æˆé•¿æ¿€åŠ±åŠŸèƒ½å®Œæ•´æ–‡æ¡£

## åˆ›å»ºæ—¶é—´
2025-12-10 23:15

## åŠŸèƒ½æ¦‚è¿°
æˆé•¿æ¿€åŠ±å¡æ˜¯StarJourneyç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼Œä»¥ä¸‰Tabæ¶æ„ï¼ˆæˆé•¿æ¿€åŠ±ã€å­¦ä¸šæ”»å…‹ã€é”™é¢˜ç®¡ç†ï¼‰ä¸ºå­¦ç”Ÿæä¾›å…¨æ–¹ä½çš„å­¦ä¹ æˆé•¿å±•ç¤ºå’Œç®¡ç†ã€‚è¯¥åŠŸèƒ½é›†æˆäº†å®æ—¶æ•°æ®åŒæ­¥ã€æ™ºèƒ½åˆ†æå’Œä¸ªæ€§åŒ–æ¿€åŠ±ç³»ç»Ÿã€‚

## æ ¸å¿ƒç»„ä»¶æ¶æ„

### 1. ä¸»è¦ç»„ä»¶æ–‡ä»¶
- **ç»„ä»¶ä½ç½®**: `mobile/components/StarJourneyModal.tsx` (530è¡Œä»£ç )
- **è§¦å‘æ–¹å¼**: ç­çº§ç®¡ç†é¡µé¢ç‚¹å‡»å­¦ç”Ÿå¤´åƒ
- **Z-Index**: `z-[60]` ç¡®ä¿æœ€é«˜å±‚çº§æ˜¾ç¤º
- **å“åº”å¼è®¾è®¡**: ç§»åŠ¨ç«¯åº•éƒ¨å¼¹å‡ºï¼Œæ¡Œé¢ç«¯å±…ä¸­æ˜¾ç¤º

### 2. ç»„ä»¶æ¥å£å®šä¹‰
```typescript
interface StarJourneyModalProps {
  studentId: string;        // å­¦ç”ŸID
  studentName: string;      // å­¦ç”Ÿå§“å
  student?: Student;        // å®Œæ•´å­¦ç”Ÿå¯¹è±¡ï¼ˆå¯é€‰ï¼‰
  isOpen: boolean;          // å¼¹çª—å¼€å¯çŠ¶æ€
  onClose: () => void;      // å…³é—­å›è°ƒ
  onStudentSelect?: (student: any) => void; // å­¦ç”Ÿé€‰æ‹©å›è°ƒï¼ˆå¯é€‰ï¼‰
}
```

### 3. å†…éƒ¨æ•°æ®ç±»å‹å®šä¹‰
```typescript
// è¿‡å…³ä»»åŠ¡æ•°æ®ç»“æ„
interface TimelineTask {
  id: number;
  name: string;
  status: 'pending' | 'passed';
  attempts: number;
  date?: string;
}

// è¯¾ç¨‹å•å…ƒæ•°æ®ç»“æ„
interface TimelineLesson {
  id: number;
  unit: number;
  lesson: number;
  title: string;
  status: 'done' | 'pending' | 'locked';
  tasks: TimelineTask[];
}
```

## ä¸‰TabåŠŸèƒ½è¯¦è§£

### Tab 1: æˆé•¿æ¿€åŠ± (Growth)

#### 1.1 æ‰€è·å‹‹ç« å±•ç¤º
**ä½ç½®**: `StarJourneyModal.tsx:251-266`
```typescript
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
  <div className="flex justify-between items-center mb-3">
    <h3 className="font-bold text-gray-700 flex items-center gap-2">
      <Medal className="w-4 h-4 text-yellow-500" /> æ‰€è·å‹‹ç« 
    </h3>
    <span className="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">3 æš</span>
  </div>
  <div className="grid grid-cols-2 gap-2">
    {growthData.badges.map(badge => (
      <div key={badge} className="bg-yellow-50 border border-yellow-100 rounded-lg p-2 text-xs font-bold text-yellow-700 text-center">
        {badge}
      </div>
    ))}
  </div>
</div>
```

#### 1.2 ä¹ æƒ¯ç»Ÿè®¡æ˜¾ç¤º
**ä½ç½®**: `StarJourneyModal.tsx:268-289`
**APIé›†æˆ**: å®æ—¶åŒæ­¥ä¹ æƒ¯æ‰“å¡æ•°æ®
```typescript
// APIè°ƒç”¨ (ç¬¬118-140è¡Œ)
useEffect(() => {
  if (isOpen && studentId) {
    const fetchHabitStats = async () => {
      try {
        const response = await habitAPI.getStats(studentId);
        if (response.success) {
          const stats: Record<string, number> = {};
          response.data.forEach((stat: any) => {
            stats[stat.habit_name] = stat.checkin_count;
          });
          setHabitStats(stats);
        }
      } catch (error) {
        console.error('è·å–ä¹ æƒ¯ç»Ÿè®¡å¤±è´¥:', error);
        // Fallbackæ•°æ®
        setHabitStats({ 'æ—©èµ·': 3, 'é˜…è¯»': 0, 'è¿åŠ¨': 1, 'æ€è€ƒ': 0, 'å«ç”Ÿ': 0, 'åŠ©äºº': 0 });
      }
    };
    fetchHabitStats();
  }
}, [isOpen, studentId]);

// UIæ¸²æŸ“ (ç¬¬273-288è¡Œ)
<div className="grid grid-cols-3 gap-2">
  {Object.keys(growthData.habits).length > 0 ? (
    Object.entries(growthData.habits).map(([name, count]) => (
      <div key={name} className="border border-gray-100 rounded-xl p-2 flex flex-col items-center">
        <span className="text-xs text-gray-500 mb-1">{name}</span>
        <span className={`text-lg font-bold ${count > 0 ? 'text-blue-600' : 'text-gray-300'}`}>
          {count}
        </span>
      </div>
    ))
  ) : (
    <div className="col-span-3 text-center py-4 text-gray-400 text-xs">
      æš‚æ— ä¹ æƒ¯æ‰“å¡è®°å½•
    </div>
  )}
</div>
```

#### 1.3 PKå¯¹å†³è®°å½•
**ä½ç½®**: `StarJourneyModal.tsx:291-309`
```typescript
<div className="space-y-2">
  {growthData.pkRecords.map((pk, idx) => (
    <div key={idx} className="flex justify-between items-center p-2 rounded-lg bg-gray-50">
      <div className="flex items-center gap-2">
        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${pk.result==='win'?'bg-yellow-400':'bg-gray-300'}`}>
          {pk.result === 'win' ? 'èƒœ' : 'è´¥'}
        </div>
        <span className="text-sm font-medium text-gray-700">vs {pk.opponent}</span>
      </div>
      <span className="text-[10px] text-gray-400">{pk.date}</span>
    </div>
  ))}
</div>
```

### Tab 2: å­¦ä¸šæ”»å…‹ (Academic)

#### 2.1 AIå­¦æƒ…åˆ†æé¢æ¿
**ä½ç½®**: `StarJourneyModal.tsx:318-331`
```typescript
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 relative overflow-hidden">
  <div className="absolute top-0 right-0 bg-purple-100 text-purple-600 text-[10px] px-2 py-1 rounded-bl-lg font-bold">AI å®æ—¶åˆ†æ</div>
  <div className="flex items-center gap-4">
    <div className="shrink-0"><RadarChart /></div>
    <div className="flex-1">
      <div className="text-sm font-bold text-gray-800 mb-2">çŠ¶æ€: <span className="text-green-500">ç¨³æ­¥ä¸Šå‡ â†—</span></div>
      <div className="bg-gray-50 p-2 rounded-lg text-xs text-gray-600 leading-relaxed border border-gray-100">
        <Bot className="inline w-3 h-3 text-purple-500 mr-1 -mt-0.5" />
        <span dangerouslySetInnerHTML={{ __html: academicData.aiComment }}></span>
      </div>
    </div>
  </div>
</div>
```

#### 2.2 ä»Šæ—¥è¿‡å…³ä»»åŠ¡
**ä½ç½®**: `StarJourneyModal.tsx:333-353`
```typescript
<div className="space-y-2">
  {academicData.pendingTasks.map(task => (
    <div key={task.id} className="bg-white p-3 rounded-xl border-l-4 border-orange-400 shadow-sm flex justify-between items-center">
      <div>
        <div className="text-sm font-bold text-gray-800">{task.title}</div>
        {task.attempts > 0 && <div className="text-[10px] text-orange-500 font-bold mt-1">ğŸ”¥ è¾…å¯¼: {task.attempts} æ¬¡</div>}
      </div>
      <div className="flex gap-2">
        <button className="w-8 h-8 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center active:bg-orange-200">
          <Plus size={16} />
        </button>
        <button className="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center active:bg-green-200">
          <Check size={16} />
        </button>
      </div>
    </div>
  ))}
</div>
```

#### 2.3 å…¨å­¦æœŸè¿‡å…³åœ°å›¾ (Timeline)
**ä½ç½®**: `StarJourneyModal.tsx:355-471`
**åŠŸèƒ½ç‰¹æ€§**:
- å­¦ç§‘åˆ‡æ¢ï¼šè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­
- è¿›åº¦ç­›é€‰ï¼šåªçœ‹æœªå®Œæˆé€‰é¡¹
- å±•å¼€/æŠ˜å ï¼šè¯¾ç¨‹ä»»åŠ¡è¯¦æƒ…
- è¡¥è¿‡æ“ä½œï¼šå•ä¸ªä»»åŠ¡è¡¥è¿‡åŠŸèƒ½

```typescript
// å­¦ç§‘åˆ‡æ¢ (ç¬¬360-371è¡Œ)
<div className="flex bg-white p-0.5 rounded-lg border border-gray-200">
  {['chinese', 'math', 'english'].map(sub => (
    <button
      key={sub}
      onClick={() => setTimelineSubject(sub as any)}
      className={`px-3 py-1 text-[10px] rounded-md font-bold transition-all ${timelineSubject===sub ? 'bg-purple-100 text-purple-600' : 'text-gray-400'}`}
    >
      {sub === 'chinese' ? 'è¯­æ–‡' : sub === 'math' ? 'æ•°å­¦' : 'è‹±è¯­'}
    </button>
  ))}
</div>

// ä»»åŠ¡è¡¥è¿‡åŠŸèƒ½ (ç¬¬449-461è¡Œ)
{task.status === 'pending' ? (
  <button
    id={`btn-pass-${task.id}`}
    onClick={() => handlePassTask(lesson.id, task.id)}
    className="bg-orange-50 text-orange-600 text-xs px-3 py-1.5 rounded-lg font-bold border border-orange-100 active:bg-orange-100"
  >
    è¡¥è¿‡
  </button>
) : (
  <span className="text-[10px] text-gray-400">{task.date} å®Œæˆ</span>
)}
```

### Tab 3: é”™é¢˜ç®¡ç† (Mistakes)

#### 3.1 é”™é¢˜æ”»å…‹ä¸­å¿ƒ
**ä½ç½®**: `StarJourneyModal.tsx:485-521`
```typescript
<div className="space-y-4 animate-in slide-in-from-right-4 fade-in duration-300">
  <div className="bg-red-50 p-4 rounded-xl border border-red-100 flex items-start gap-3">
    <AlertCircle className="w-5 h-5 text-red-500 shrink-0 mt-0.5" />
    <div>
      <div className="font-bold text-red-700 text-sm">é”™é¢˜æ”»å…‹ä¸­å¿ƒ</div>
      <div className="text-xs text-red-500 mt-1">æœ¬å‘¨å…±å½•å…¥ {mistakeData.recent.length} é“é”™é¢˜ï¼Œå»ºè®®ä¼˜å…ˆå¤„ç†æ•°å­¦åº”ç”¨é¢˜ã€‚</div>
    </div>
  </div>

  <div className="grid grid-cols-2 gap-3">
    <button className="bg-gradient-to-br from-red-500 to-rose-600 text-white p-4 rounded-2xl shadow-lg shadow-red-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform">
      <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
        <Camera size={20} />
      </div>
      <span className="font-bold text-sm">å½•å…¥é”™é¢˜</span>
    </button>
    <button className="bg-white border border-red-100 text-red-600 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform">
      <div className="w-10 h-10 bg-red-50 rounded-full flex items-center justify-center">
        <Printer size={20} />
      </div>
      <span className="font-bold text-sm">ç”Ÿæˆæ”»å…‹å•</span>
    </button>
  </div>
</div>
```

## APIæ¥å£ä½“ç³»

### 1. ä¹ æƒ¯æ‰“å¡API (habitAPI)
**æ–‡ä»¶ä½ç½®**: `mobile/services/api.ts:188-205`
```typescript
export const habitAPI = {
  // è·å–æ‰€æœ‰ä¹ æƒ¯åˆ—è¡¨
  async getAllHabits() {
    return fetchWithAuth(`${API_BASE_URL}/habits`);
  },

  // ä¹ æƒ¯æ‰“å¡
  async checkIn(studentId: string, habitId: string) {
    return fetchWithAuth(`${API_BASE_URL}/habits/${habitId}/checkin`, {
      method: 'POST',
      body: JSON.stringify({ studentId })
    });
  },

  // è·å–å­¦ç”Ÿä¹ æƒ¯ç»Ÿè®¡ - **æˆé•¿æ¿€åŠ±æ ¸å¿ƒAPI**
  async getStats(studentId: string) {
    return fetchWithAuth(`${API_BASE_URL}/habits/stats/${studentId}`);
  }
};
```

### 2. StarJourney API (starJourneyAPI)
**æ–‡ä»¶ä½ç½®**: `mobile/services/api.ts:208-359`

#### 2.1 é”™é¢˜ç®¡ç†API
```typescript
// è·å–é”™é¢˜åˆ—è¡¨
async getMistakes(studentId?: string, subject?: string, status?: string) {
  const params = new URLSearchParams();
  if (studentId) params.append('student_id', studentId);
  if (subject) params.append('subject', subject);
  if (status) params.append('status', status);

  return fetchWithAuth(`${STARJOURNEY_API_BASE_URL}/mistakes?${params.toString()}`);
}

// åˆ›å»ºé”™é¢˜è®°å½•
async createMistake(data: {
  student_id: string;
  image_url?: string;
  ocr_text?: string;
  subject?: string;
  tags?: string;
  difficulty_level?: number;
}) {
  return fetchWithAuth(`${STARJOURNEY_API_BASE_URL}/mistakes`, {
    method: 'POST',
    body: JSON.stringify(data)
  });
}
```

#### 2.2 è¿‡å…³ç®¡ç†API
```typescript
// è·å–è¿‡å…³è®°å½•
async getRecords(studentId?: string, taskType?: string, status?: string) {
  const params = new URLSearchParams();
  if (studentId) params.append('student_id', studentId);
  if (taskType) params.append('task_type', taskType);
  if (status) params.append('status', status);

  return fetchWithAuth(`${STARJOURNEY_API_BASE_URL}/records?${params.toString()}`);
}

// è®°å½•è¾…å¯¼å°è¯• - **æ ¸å¿ƒåŠŸèƒ½**
async recordAttempt(recordId: string) {
  return fetchWithAuth(`${STARJOURNEY_API_BASE_URL}/records/${recordId}/attempt`, {
    method: 'PATCH'
  });
}

// æ ‡è®°ä»»åŠ¡é€šè¿‡
async markAsPassed(recordId: string, expBonus?: number) {
  return fetchWithAuth(`${STARJOURNEY_API_BASE_URL}/records/${recordId}/pass`, {
    method: 'PATCH',
    body: JSON.stringify({ exp_bonus: expBonus || 0 })
  });
}
```

#### 2.3 ç»¼åˆæ•°æ®API
```typescript
// è·å–å­¦ç”Ÿå®Œæ•´StarJourneyæ•°æ® - **æ•°æ®é›†æˆæ ¸å¿ƒ**
async getStudentStarJourneyData(studentId: string) {
  const [mistakesRes, recordsRes, statsRes] = await Promise.all([
    starJourneyAPI.getMistakes(studentId),
    starJourneyAPI.getRecords(studentId),
    starJourneyAPI.getStudentStats(studentId)
  ]);

  return {
    mistakes: mistakesRes.data || [],
    records: recordsRes.data || [],
    stats: statsRes.data || null,
    success: mistakesRes.success && recordsRes.success && statsRes.success
  };
}
```

## æ•°æ®åº“è®¾è®¡

### 1. Growarkæ•°æ®åº“è¡¨ (æˆé•¿æ¿€åŠ±ç›¸å…³)

#### 1.1 å­¦ç”ŸåŸºç¡€è¡¨ (students)
```sql
CREATE TABLE IF NOT EXISTS students (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,
  score INTEGER DEFAULT 0,              -- ç§¯åˆ†
  total_exp INTEGER DEFAULT 0,          -- æ€»ç»éªŒå€¼
  level INTEGER DEFAULT 1,              -- ç­‰çº§
  avatar_url VARCHAR(500),              -- å¤´åƒURL
  team_id INTEGER REFERENCES teams(id), -- æˆ˜é˜ŸID
  group_id INTEGER REFERENCES groups(id), -- åˆ†ç»„ID
  class_name VARCHAR(50),               -- ç­çº§åç§°
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.2 å‹‹ç« ç³»ç»Ÿè¡¨
```sql
-- å‹‹ç« è¡¨
CREATE TABLE IF NOT EXISTS badges (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,   -- å‹‹ç« åç§°
  icon VARCHAR(20),                    -- å‹‹ç« å›¾æ ‡
  description TEXT,                    -- å‹‹ç« æè¿°
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å­¦ç”Ÿå‹‹ç« å…³è”è¡¨
CREATE TABLE IF NOT EXISTS student_badges (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  badge_id INTEGER NOT NULL REFERENCES badges(id) ON DELETE CASCADE,
  awarded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(student_id, badge_id)
);
```

#### 1.3 PKå¯¹æˆ˜è¡¨
```sql
CREATE TABLE IF NOT EXISTS pk_matches (
  id SERIAL PRIMARY KEY,
  student_a_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  student_b_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  topic VARCHAR(200),                   -- å¯¹å†³ä¸»é¢˜
  status VARCHAR(20) DEFAULT 'pending', -- pending, completed
  winner_id INTEGER REFERENCES students(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.4 ä¹ æƒ¯æ‰“å¡è¡¨
```sql
-- ä¹ æƒ¯å®šä¹‰è¡¨
CREATE TABLE IF NOT EXISTS habits (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,   -- ä¹ æƒ¯åç§°
  icon VARCHAR(20),                    -- ä¹ æƒ¯å›¾æ ‡
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¹ æƒ¯æ‰“å¡è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS habit_checkins (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  habit_id INTEGER NOT NULL REFERENCES habits(id) ON DELETE CASCADE,
  checked_in_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. StarJourneyæ•°æ®åº“è¡¨ (å­¦ä¸šç›¸å…³)

#### 2.1 é”™é¢˜è®°å½•è¡¨ (lms_mistakes)
```sql
CREATE TABLE IF NOT EXISTS lms_mistakes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  image_url VARCHAR(500),              -- é”™é¢˜å›¾ç‰‡URL
  ocr_text TEXT,                       -- OCRè¯†åˆ«çš„æ–‡æœ¬
  ai_analysis JSONB,                   -- AIåˆ†æç»“æœ
  subject VARCHAR(50) DEFAULT 'math',  -- å­¦ç§‘
  status VARCHAR(20) DEFAULT 'pending', -- pending, solved, reviewed
  tags TEXT[],                         -- çŸ¥è¯†ç‚¹æ ‡ç­¾
  difficulty_level INTEGER DEFAULT 1,   -- éš¾åº¦ç­‰çº§ 1-5
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2 è¿‡å…³è®°å½•è¡¨ (lms_student_record) - **æ ¸å¿ƒä¸šåŠ¡è¡¨**
```sql
CREATE TABLE IF NOT EXISTS lms_student_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  task_name VARCHAR(200) NOT NULL,     -- ä»»åŠ¡åç§°
  task_type VARCHAR(20) NOT NULL,      -- QC (è´¨æ£€) / TASK (è¿‡ç¨‹ä»»åŠ¡)
  status VARCHAR(20) DEFAULT 'pending', -- pending, passed
  exp_value INTEGER DEFAULT 10,        -- ç»éªŒå€¼å¥–åŠ±
  attempt_count INTEGER DEFAULT 0,     -- å°è¯•æ¬¡æ•° (æ ¸å¿ƒæŒ‡æ ‡)
  difficulty_flag BOOLEAN DEFAULT FALSE, -- æ˜¯å¦ä¸º"ç¡¬éª¨å¤´"ä»»åŠ¡
  is_special BOOLEAN DEFAULT FALSE,    -- æ˜¯å¦ä¸ºä¸ªæ€§åŒ–åŠ é¤

  -- è¯¾ç¨‹è¿›åº¦ä¿¡æ¯
  lesson_unit INTEGER,                 -- å½“å‰å•å…ƒ
  lesson_lesson INTEGER,               -- å½“å‰è¯¾æ¬¡
  lesson_title VARCHAR(200),           -- è¯¾ç¨‹æ ‡é¢˜
  lesson_subject VARCHAR(50),          -- å­¦ç§‘

  -- æ—¶é—´æˆ³
  first_attempt_at TIMESTAMP,          -- é¦–æ¬¡å°è¯•æ—¶é—´
  completed_at TIMESTAMP,              -- å®Œæˆæ—¶é—´
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.3 å­¦æƒ…æŠ¥å‘Šè¡¨ (lms_academic_reports)
```sql
CREATE TABLE IF NOT EXISTS lms_academic_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  report_type VARCHAR(20) NOT NULL,     -- weekly, monthly, custom
  start_date DATE NOT NULL,             -- æŠ¥å‘Šå¼€å§‹æ—¥æœŸ
  end_date DATE NOT NULL,               -- æŠ¥å‘Šç»“æŸæ—¥æœŸ

  -- äº”ç»´èƒ½åŠ›é›·è¾¾å›¾æ•°æ®
  radar_data JSONB NOT NULL,            -- {calculation: 80, concept: 60, ...}

  -- AIåˆ†æç»“æœ
  ai_comment TEXT,                      -- AIç”Ÿæˆçš„è¯„è¯­
  total_mistakes INTEGER DEFAULT 0,    -- é”™é¢˜æ€»æ•°
  weak_points JSONB,                    -- è–„å¼±çŸ¥è¯†ç‚¹åˆ†æ
  action_plan TEXT[],                  -- æ”¹è¿›å»ºè®®

  -- æŠ¥å‘Šæ–‡ä»¶
  pdf_url VARCHAR(500),                -- ç”Ÿæˆçš„PDFæŠ¥å‘Šé“¾æ¥
  html_content TEXT,                    -- HTMLæŠ¥å‘Šå†…å®¹

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.4 å­¦ç”Ÿå­¦ä¸šç»Ÿè®¡è§†å›¾
```sql
CREATE OR REPLACE VIEW v_student_academic_stats AS
SELECT
  s.id as student_id,
  s.name as student_name,
  s.class_name,
  COUNT(DISTINCT CASE WHEN lr.task_type = 'QC' AND lr.status = 'passed' THEN lr.id END) as qc_passed,
  COUNT(DISTINCT CASE WHEN lr.task_type = 'QC' AND lr.status = 'pending' THEN lr.id END) as qc_pending,
  COUNT(DISTINCT CASE WHEN lr.task_type = 'TASK' AND lr.status = 'passed' THEN lr.id END) as task_passed,
  COUNT(DISTINCT CASE WHEN lr.task_type = 'TASK' AND lr.status = 'pending' THEN lr.id END) as task_pending,
  COALESCE(SUM(lr.attempt_count), 0) as total_attempts,
  COALESCE(SUM(lr.exp_value), 0) as total_earned_exp,
  COUNT(DISTINCT m.id) as total_mistakes,
  COUNT(DISTINCT CASE WHEN m.status = 'solved' THEN m.id END) as solved_mistakes
FROM students s
LEFT JOIN lms_student_record lr ON s.id = lr.student_id
LEFT JOIN lms_mistakes m ON s.id = m.student_id
GROUP BY s.id, s.name, s.class_name;
```

## çŠ¶æ€ç®¡ç†å’Œæ•°æ®æµ

### 1. ç»„ä»¶å†…éƒ¨çŠ¶æ€ç®¡ç†
```typescript
// Tabåˆ‡æ¢çŠ¶æ€
const [activeTab, setActiveTab] = useState<'growth' | 'academic' | 'mistakes'>('academic');

// è¿‡å…³åœ°å›¾çŠ¶æ€
const [timelineSubject, setTimelineSubject] = useState<'chinese' | 'math' | 'english'>('chinese');
const [showPendingOnly, setShowPendingOnly] = useState(false);
const [expandedLessons, setExpandedLessons] = useState<Record<number, boolean>>({ 101: true });

// ä¹ æƒ¯æ•°æ®çŠ¶æ€ - **APIé›†æˆçŠ¶æ€**
const [habitStats, setHabitStats] = useState<Record<string, number>>({});
```

### 2. å®æ—¶æ•°æ®åŒæ­¥æœºåˆ¶
```typescript
// ä¹ æƒ¯æ•°æ®å®æ—¶è·å–å’ŒåŒæ­¥
useEffect(() => {
  if (isOpen && studentId) {
    const fetchHabitStats = async () => {
      try {
        const response = await habitAPI.getStats(studentId);
        if (response.success) {
          // æ•°æ®æ ¼å¼è½¬æ¢
          const stats: Record<string, number> = {};
          response.data.forEach((stat: any) => {
            stats[stat.habit_name] = stat.checkin_count;
          });
          setHabitStats(stats);
        }
      } catch (error) {
        console.error('è·å–ä¹ æƒ¯ç»Ÿè®¡å¤±è´¥:', error);
        // é”™è¯¯å®¹é”™å¤„ç†
        setHabitStats({ 'æ—©èµ·': 3, 'é˜…è¯»': 0, 'è¿åŠ¨': 1, 'æ€è€ƒ': 0, 'å«ç”Ÿ': 0, 'åŠ©äºº': 0 });
      }
    };

    fetchHabitStats();
  }
}, [isOpen, studentId]); // ä¾èµ–é¡¹ï¼šå¼¹çª—å¼€å¯çŠ¶æ€å’Œå­¦ç”ŸID
```

### 3. æ•°æ®ç»‘å®šå’Œæ¸²æŸ“æµç¨‹
```typescript
// æˆé•¿æ¿€åŠ±æ•°æ®ç»‘å®š
const growthData = {
  badges: ['é˜…è¯»è¾¾äºº', 'å°ç”»å®¶', 'å…¨å¯¹å‰å®³'],
  habits: habitStats, // å®æ—¶APIæ•°æ®
  pkRecords: [
    { result: 'win', opponent: 'å®‹å­æ™¨', date: '2025/12/10' },
    { result: 'win', opponent: 'ç‹å½¦èˆ’', date: '2025/12/10' },
    { result: 'lose', opponent: 'åºå­ç¥', date: '2025/12/10' },
  ]
};
```

### 4. äº¤äº’å¤„ç†é€»è¾‘
```typescript
// è¯¾ç¨‹å±•å¼€/æŠ˜å 
const toggleLessonExpand = (id: number) => {
  setExpandedLessons(prev => ({ ...prev, [id]: !prev[id] }));
};

// ä»»åŠ¡è¡¥è¿‡å¤„ç†
const handlePassTask = (lessonId: number, taskId: number) => {
  // UIä¹è§‚æ›´æ–°
  const btn = document.getElementById(`btn-pass-${taskId}`);
  if(btn) {
    btn.innerHTML = '<span class="text-green-600 font-bold text-xs">åˆšè¡¥è¿‡</span>';
    btn.parentElement!.style.opacity = '0.5';
    btn.parentElement!.style.backgroundColor = '#F9FAFB';
  }
  // TODO: è°ƒç”¨APIè¿›è¡Œåç«¯æ•°æ®æ›´æ–°
};
```

## å®æ—¶æ•°æ®é›†æˆæœºåˆ¶

### 1. APIä»£ç†æ¶æ„
**æ–‡ä»¶ä½ç½®**: `arkok/server.js:1381-1409`
```javascript
// é”™é¢˜APIä»£ç†
app.get('/api/mistakes', async (req, res) => {
  try {
    const response = await axios.get(`http://localhost:3001/api/mistakes`, {
      params: req.query,
      timeout: 5000
    });
    res.json(response.data);
  } catch (error) {
    console.error('ä»£ç†mistakesè¯·æ±‚å¤±è´¥:', error.message);
    res.status(500).json({ success: false, error: error.message });
  }
});

// è¿‡å…³è®°å½•APIä»£ç†
app.get('/api/records', async (req, res) => {
  try {
    const response = await axios.get(`http://localhost:3001/api/records`, {
      params: req.query,
      timeout: 5000
    });
    res.json(response.data);
  } catch (error) {
    console.error('ä»£ç†recordsè¯·æ±‚å¤±è´¥:', error.message);
    res.status(500).json({ success: false, error: error.message });
  }
});
```

### 2. åŒæœåŠ¡æ¶æ„
- **GrowarkæœåŠ¡** (ç«¯å£3000): å­¦ç”Ÿç®¡ç†ã€ç§¯åˆ†ç³»ç»Ÿã€ä¹ æƒ¯æ‰“å¡
- **StarJourneyæœåŠ¡** (ç«¯å£3001): é”™é¢˜ç®¡ç†ã€è¿‡å…³è®°å½•ã€å­¦æƒ…åˆ†æ
- **APIç½‘å…³**: é€šè¿‡GrowarkæœåŠ¡å™¨ä»£ç†StarJourney APIè¯·æ±‚

### 3. æ•°æ®åŒæ­¥æµç¨‹
```
ç”¨æˆ·æ“ä½œ â†’ å‰ç«¯ç»„ä»¶ â†’ APIè°ƒç”¨ â†’ æ•°æ®åº“æ›´æ–° â†’ å®æ—¶åŒæ­¥è¿”å› â†’ UIæ›´æ–°
    â†“           â†“         â†“           â†“              â†“
ç‚¹å‡»è¡¥è¿‡ â†’ optimistic â†’ PATCH API â†’ attempt_count++ â†’ æ–°çŠ¶æ€æ˜¾ç¤º
         UIæ›´æ–°      /api/records/:id/attempt
```

## ç³»ç»Ÿé›†æˆç‰¹æ€§

### 1. å¤´åƒç³»ç»Ÿç»Ÿä¸€
- **æ¥æº**: ä½¿ç”¨ `student?.avatar` æˆ– DiceBear API ç”Ÿæˆ
- **æ ·å¼**: ç»Ÿä¸€ `w-20 h-20 rounded-full border-4 border-white`
- **ç‚¹å‡»é˜²æŠ¤**: æ·»åŠ  `select-none pointer-events-none draggable={false}` å±æ€§

### 2. ç­‰çº§å’Œç»éªŒç³»ç»Ÿ
```typescript
// ç­‰çº§å¾½ç« æ˜¾ç¤º
<div className="absolute bottom-0 right-0 bg-yellow-400 text-white text-[10px] font-bold px-2 py-0.5 rounded-full border-2 border-white shadow-sm">
  Lv.{student?.level || 1}
</div>

// ç§¯åˆ†ç»éªŒå±•ç¤º
<div className="bg-orange-50 px-4 py-2 rounded-xl border border-orange-100 min-w-[100px]">
  <div className="text-[10px] text-orange-400 font-bold uppercase">ç§¯åˆ†</div>
  <div className="text-xl font-black text-orange-600">{student?.points || 0}</div>
</div>
```

### 3. ç­çº§ä¿¡æ¯é›†æˆ
```typescript
<div className="text-xs text-gray-400 mt-1">{student?.className || 'æœªåˆ†ç­'}</div>
```

## å“åº”å¼è®¾è®¡

### 1. ç§»åŠ¨ç«¯ä¼˜åŒ–
- **å¼¹å‡ºæ–¹å¼**: `items-end` åº•éƒ¨æ»‘å‡º
- **é«˜åº¦æ§åˆ¶**: `h-[92vh]` å ç”¨92%è§†å£é«˜åº¦
- **è§¦æ‘¸äº¤äº’**: æŒ‰é’®å°ºå¯¸ä¼˜åŒ–ï¼Œ`active:scale-95` è§¦æ‘¸åé¦ˆ

### 2. æ¡Œé¢ç«¯é€‚é…
- **å¼¹å‡ºæ–¹å¼**: `items-center` å±…ä¸­æ˜¾ç¤º
- **å®½åº¦æ§åˆ¶**: `sm:max-w-[480px]` æœ€å¤§å®½åº¦é™åˆ¶
- **åœ†è§’è®¾è®¡**: `sm:rounded-3xl` æ¡Œé¢ç«¯åœ†è§’

### 3. åŠ¨ç”»æ•ˆæœ
- **è¿›å…¥åŠ¨ç”»**: `animate-in slide-in-from-bottom duration-300`
- **åˆ‡æ¢åŠ¨ç”»**: `animate-in slide-in-from-right-4 fade-in duration-300`
- **æŒ‰é’®åé¦ˆ**: `active:scale-95 transition-transform`

## æ€§èƒ½ä¼˜åŒ–

### 1. ç»„ä»¶çº§åˆ«ä¼˜åŒ–
- **æ¡ä»¶æ¸²æŸ“**: åªæœ‰åœ¨ `isOpen` æ—¶æ¸²æŸ“å†…å®¹
- **æ‡’åŠ è½½**: Tabå†…å®¹æŒ‰éœ€æ¸²æŸ“
- **é˜²æŠ–å¤„ç†**: é¢‘ç¹åˆ‡æ¢æ“ä½œçš„æ€§èƒ½ä¼˜åŒ–

### 2. æ•°æ®åŠ è½½ä¼˜åŒ–
- **å¹¶å‘è¯·æ±‚**: ä½¿ç”¨ `Promise.all` å¹¶è¡Œè·å–æ•°æ®
- **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤APIè°ƒç”¨
- **é”™è¯¯å®¹é”™**: Fallbackæ•°æ®ä¿è¯UIå¯ç”¨æ€§

### 3. æ¸²æŸ“ä¼˜åŒ–
- **è™šæ‹Ÿæ»šåŠ¨**: é•¿åˆ—è¡¨çš„æ€§èƒ½ä¼˜åŒ–
- **çŠ¶æ€ç®¡ç†**: ç²¾ç¡®çš„çŠ¶æ€æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- **æ ·å¼ä¼˜åŒ–**: ä½¿ç”¨Tailwind CSSçš„utility classes

## é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

### 1. APIé”™è¯¯å¤„ç†
```typescript
try {
  const response = await habitAPI.getStats(studentId);
  if (response.success) {
    // æ­£å¸¸æ•°æ®å¤„ç†
  }
} catch (error) {
  console.error('è·å–ä¹ æƒ¯ç»Ÿè®¡å¤±è´¥:', error);
  // ä½¿ç”¨é»˜è®¤æ•°æ®ä½œä¸ºfallback
  setHabitStats({ 'æ—©èµ·': 3, 'é˜…è¯»': 0, 'è¿åŠ¨': 1, 'æ€è€ƒ': 0, 'å«ç”Ÿ': 0, 'åŠ©äºº': 0 });
}
```

### 2. æ•°æ®å®‰å…¨å¤„ç†
- **ç©ºå€¼æ£€æŸ¥**: `student?.className || 'æœªåˆ†ç­'`
- **æ•°ç»„å®‰å…¨**: `Object.keys(growthData.habits).length > 0`
- **ç±»å‹å®‰å…¨**: TypeScriptæ¥å£å®šä¹‰ä¿è¯æ•°æ®ç±»å‹æ­£ç¡®

### 3. ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- **ç©ºçŠ¶æ€æç¤º**: "æš‚æ— ä¹ æƒ¯æ‰“å¡è®°å½•"
- **åŠ è½½çŠ¶æ€**: å¯æ‰©å±•çš„loadingçŠ¶æ€
- **ç½‘ç»œå¼‚å¸¸**: ä¼˜é›…çš„é™çº§å¤„ç†

## æ€»ç»“

æˆé•¿æ¿€åŠ±åŠŸèƒ½æ˜¯StarJourneyç³»ç»Ÿçš„æ ¸å¿ƒåˆ›æ–°ï¼Œé€šè¿‡ä¸‰Tabæ¶æ„å®Œç¾æ•´åˆäº†ï¼š

### æŠ€æœ¯äº®ç‚¹
1. **å®æ—¶æ•°æ®åŒæ­¥**: ä¹ æƒ¯æ‰“å¡æ•°æ®ä¸æˆé•¿æ¿€åŠ±å¡æ— ç¼é›†æˆ
2. **åŒæœåŠ¡æ¶æ„**: Growark + StarJourneyååŒå·¥ä½œ
3. **å“åº”å¼è®¾è®¡**: ç§»åŠ¨ç«¯ä¼˜å…ˆçš„äº¤äº’ä½“éªŒ
4. **æ€§èƒ½ä¼˜åŒ–**: å¤šå±‚çº§ä¼˜åŒ–ç¡®ä¿æµç•…ä½“éªŒ

### ä¸šåŠ¡ä»·å€¼
1. **å…¨é¢çš„å­¦ç”Ÿç”»åƒ**: æ•´åˆå­¦ä¸šã€ä¹ æƒ¯ã€ç¤¾äº¤ç­‰å¤šç»´åº¦æ•°æ®
2. **ä¸ªæ€§åŒ–æ¿€åŠ±**: åŸºäºçœŸå®æ•°æ®çš„ç²¾å‡†æ¿€åŠ±ç³»ç»Ÿ
3. **æ•™å­¦è¾…åŠ©**: ä¸ºæ•™å¸ˆæä¾›å®Œæ•´çš„å­¦ç”Ÿæˆé•¿è§†å›¾
4. **å®¶é•¿å‚ä¸**: é€æ˜çš„æˆé•¿è¿‡ç¨‹å±•ç¤º

### ç³»ç»Ÿç‰¹è‰²
1. **æ•°æ®å®Œæ•´æ€§**: è¦†ç›–å­¦ä¹ å…¨æµç¨‹çš„æ•°æ®è®°å½•
2. **ç”¨æˆ·ä½“éªŒ**: ç§»åŠ¨ç«¯ä¼˜åŒ–çš„æµç•…äº¤äº’
3. **æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•
4. **ç¨³å®šæ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

è¿™ä¸ªæˆé•¿æ¿€åŠ±ç³»ç»Ÿä»£è¡¨äº†ç°ä»£æ•™è‚²ç§‘æŠ€çš„æœ€æ–°å‘å±•æ–¹å‘ï¼Œé€šè¿‡æŠ€æœ¯åˆ›æ–°æ¨åŠ¨ä¸ªæ€§åŒ–æ•™è‚²çš„å®ç°ã€‚