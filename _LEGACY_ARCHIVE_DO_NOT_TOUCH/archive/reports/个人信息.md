# 个人信息面板功能详细文档

## 概述
在班级管理页面（勋章标签页）中点击学生头像，会弹出个人详细信息面板。该面板是学生管理的核心功能入口，集成了学生的各类数据展示、管理和操作功能。

## 功能入口
- **位置**: 班级管理页面（底部导航"勋章"标签）
- **触发方式**: 点击任意学生头像
- **触发代码**: `mobile/pages/ClassManage.tsx:1614` - `setSelectedStudent(s)`

## 核心组件

### 1. 主要组件文件
- **文件位置**: `mobile/pages/ClassManage.tsx`
- **主函数**: `renderStudentDetailModal()` (第1205-1550行)
- **状态管理**: `selectedStudent` (第49行)

### 2. 相关依赖导入
```typescript
import * as XLSX from 'xlsx';  // Excel导出功能
import { Student, Challenge, PKMatch, Badge, Task, ScoreCategory, PointPreset, Habit } from '../types';
```

## 界面结构

### 1. 头部区域
```typescript
// 头部渐变背景和关闭按钮 (第1231-1240行)
<div className="h-28 bg-gradient-to-br from-primary to-orange-300 relative flex-shrink-0">
  <div className="absolute bottom-0 left-0 right-0 h-12 bg-white rounded-t-[2.5rem]"></div>
  <button onClick={() => setSelectedStudent(null)} className="absolute top-4 right-4 bg-black/20 backdrop-blur-md p-2 rounded-full">
    <X size={20} />
  </button>
</div>
```

### 2. 学生基本信息区域
```typescript
// 学生头像、姓名、等级、积分、经验 (第1242-1310行)
<div className="px-8 -mt-20 pb-8 flex-1 overflow-y-auto">
  <div className="flex flex-col items-center">
    // 头像和等级
    <img src={selectedStudent.avatar} className="w-24 h-24 rounded-full border-4 border-white shadow-xl" />
    <div className="absolute bottom-0 right-0 bg-yellow-400 text-yellow-900 text-[10px] px-2 py-0.5 rounded-full">Lv.{selectedStudent.level}</div>

    // 姓名和编辑
    <h2 className="text-2xl font-bold text-gray-900">{selectedStudent.name}</h2>
    <button onClick={() => setEditingStudent(selectedStudent)}>
      <Edit2 size={18} className="text-primary" />
    </button>

    // 积分和经验展示
    <div className="flex items-center gap-3">
      <div className="bg-orange-50 px-4 py-1 rounded-xl">
        <span className="text-xs text-orange-400">积分</span>
        <span className="text-lg font-black text-orange-600">{selectedStudent.points}</span>
      </div>
      <div className="bg-blue-50 px-4 py-1 rounded-xl">
        <span className="text-xs text-blue-400">经验</span>
        <span className="text-lg font-black text-blue-600">{selectedStudent.exp}</span>
      </div>
    </div>

    // 班级和战队选择
    <div className="px-4 py-1 rounded-xl bg-primary/10 border border-primary/20 text-primary">
      {(teams || []).find(t=>t.id===selectedStudent.teamId)?.name || '未分队'}
    </div>
    <div className="px-4 py-1 rounded-xl bg-primary/10 border border-primary/20 text-primary">
      {selectedStudent.className || '未分班'}
    </div>
  </div>
</div>
```

## 功能模块

### 1. 勋章管理
**位置**: 第1312-1380行
```typescript
// 勋章展示卡片
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
  <h3 className="text-sm font-bold text-gray-800 flex items-center">
    <Trophy size={16} className="mr-2 text-purple-600"/> 勋章墙
  </h3>
  <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">
    {selectedStudent.badgeHistory ? selectedStudent.badgeHistory.length : 0} 个
  </span>

  // 勋章分页展示
  <div className="grid grid-cols-3 gap-2">
    {pageItems.map(badge => (
      <div key={badge.id} className="bg-white border border-purple-100 p-2 rounded-xl shadow-sm">
        <span className="text-sm text-gray-800 font-bold mb-0.5">{badge.name}</span>
        <span className="text-xs text-gray-400">{badge.awardedDate}</span>
      </div>
    ))}
  </div>
</div>
```

**相关API**: `mobile/services/api.ts:174-189`
```typescript
export const badgeAPI = {
  async getAllBadges() {
    return fetchWithAuth(`${API_BASE_URL}/badges`);
  },
  async createBadge(data: { name: string; description: string; icon?: string }) {
    return fetchWithAuth(`${API_BASE_URL}/badges`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  },
  async grantBadge(studentId: string, badgeId: string) {
    return fetchWithAuth(`${API_BASE_URL}/badges/${badgeId}/grant`, {
      method: 'POST',
      body: JSON.stringify({ studentId })
    });
  }
};
```

### 2. 习惯打卡统计
**位置**: 第1340-1365行
```typescript
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
  <h3 className="text-sm font-bold text-gray-800 flex items-center">
    <CheckCircle size={16} className="mr-2 text-green-600"/> 习惯统计
  </h3>

  <div className="grid grid-cols-3 gap-2">
    {pageItems.length > 0 ? pageItems.map(h => (
      <div key={h.id} className="bg-white border border-blue-100 p-2 rounded-xl shadow-sm">
        <span className="text-sm text-gray-800 font-bold mb-0.5">{h.name}</span>
        <span className="text-lg font-black text-blue-600">{selectedStudent.habitStats?.[h.id] || 0}</span>
      </div>
    )) : (
      <div className="col-span-3 text-center text-xs text-gray-400 py-3 bg-gray-50 rounded-xl">
        暂无习惯数据
      </div>
    )}
  </div>
</div>
```

**相关API**: `mobile/services/api.ts:190-205`
```typescript
export const habitAPI = {
  async getAllHabits() {
    return fetchWithAuth(`${API_BASE_URL}/habits`);
  },
  async checkIn(studentId: string, habitId: string) {
    return fetchWithAuth(`${API_BASE_URL}/habits/${habitId}/checkin`, {
      method: 'POST',
      body: JSON.stringify({ studentId })
    });
  },
  async getStats(studentId: string) {
    return fetchWithAuth(`${API_BASE_URL}/habits/stats/${studentId}`);
  }
};
```

### 3. PK对决记录
**位置**: 第1381-1430行
```typescript
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
  <h3 className="text-sm font-bold text-gray-800 flex items-center">
    <Swords size={16} className="mr-2 text-red-500"/> PK 对决记录
  </h3>
  <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">
    {selectedStudent.pkHistory ? selectedStudent.pkHistory.length : 0} 场
  </span>

  // PK记录列表
  <div className="max-h-[300px] overflow-y-auto space-y-2.5">
    {selectedStudent.pkHistory
      .filter(pk => // 显示最近一个月的记录)
      .map(pk => (
        <div key={pk.id} className="bg-gray-50 rounded-xl p-3 border border-gray-100">
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs font-bold text-gray-600">vs {pk.opponentName || pk.opponentId}</span>
            <span className="text-xs text-gray-400">{pk.date}</span>
          </div>
          <div className="text-xs text-gray-700 font-medium">{pk.topic}</div>
          <div className="text-xs text-center mt-2">
            <span className={`px-2 py-0.5 rounded-full font-bold ${
              pk.result === 'win' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
            }`}>
              {pk.result === 'win' ? '胜利' : '失败'}
            </span>
          </div>
        </div>
      ))}
  </div>
</div>
```

**相关API**: `mobile/services/api.ts:128-143`
```typescript
export const pkAPI = {
  async getAllMatches() {
    return fetchWithAuth(`${API_BASE_URL}/pk-matches`);
  },
  async createMatch(data: { studentA: string; studentB: string; topic: string }) {
    return fetchWithAuth(`${API_BASE_URL}/pk-matches`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  },
  async setWinner(matchId: string, winner: string) {
    return fetchWithAuth(`${API_BASE_URL}/pk-matches/${matchId}/winner`, {
      method: 'POST',
      body: JSON.stringify({ winner })
    });
  },
  async deleteMatch(matchId: string) {
    return fetchWithAuth(`${API_BASE_URL}/pk-matches/${matchId}`, {
      method: 'DELETE'
    });
  }
};
```

### 4. 任务记录
**位置**: 第1431-1475行
```typescript
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
  <h3 className="text-sm font-bold text-gray-800 flex items-center">
    <ScrollText size={16} className="mr-2 text-green-600"/> 任务记录
  </h3>
  <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">
    {selectedStudent.taskHistory ? selectedStudent.taskHistory.length : 0} 个
  </span>

  // 任务列表
  <div className="max-h-[300px] overflow-y-auto space-y-2.5">
    {selectedStudent.taskHistory
      .filter(rec => // 显示最近一个月的记录)
      .map(rec => (
        <div key={rec.id} className="bg-green-50 rounded-xl p-3 border border-green-100">
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs font-bold text-gray-600">{rec.title}</span>
            <span className="text-xs text-gray-400">{rec.date}</span>
          </div>
          <div className="flex items-center justify-between">
            <span className="text-xs text-green-600 font-medium">已完成</span>
            <span className="text-xs text-green-600 font-bold">+{rec.exp} EXP</span>
          </div>
        </div>
      ))}
  </div>
</div>
```

**相关API**: `mobile/services/api.ts:151-166`
```typescript
export const taskAPI = {
  async getAllTasks() {
    return fetchWithAuth(`${API_BASE_URL}/tasks`);
  },
  async createTask(data: { title: string; description: string; expValue: number }) {
    return fetchWithAuth(`${API_BASE_URL}/tasks`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  },
  async completeTask(studentId: string, taskId: string) {
    return fetchWithAuth(`${API_BASE_URL}/tasks/${taskId}/complete`, {
      method: 'POST',
      body: JSON.stringify({ studentId })
    });
  }
};
```

### 5. 挑战记录
**位置**: 第1476-1520行
```typescript
<div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
  <h3 className="text-sm font-bold text-gray-800 flex items-center">
    <Trophy size={16} className="mr-2 text-purple-600"/> 挑战记录
  </h3>
  <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">
    {selectedStudent.challengeHistory ? selectedStudent.challengeHistory.length : 0} 个
  </span>

  // 挑战记录列表
  <div className="max-h-[300px] overflow-y-auto space-y-2.5">
    {selectedStudent.challengeHistory
      .filter(rec => // 显示最近一个月的记录)
      .map(rec => (
        <div key={rec.id} className="bg-purple-50 rounded-xl p-3 border border-purple-100">
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs font-bold text-gray-600">{rec.title}</span>
            <span className="text-xs text-gray-400">{rec.date}</span>
          </div>
          <div className="text-xs text-center">
            <span className={`px-2 py-0.5 rounded-full font-bold ${
              rec.result === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
            }`}>
              {rec.result === 'success' ? '成功' : '失败'}
            </span>
          </div>
        </div>
      ))}
  </div>
</div>
```

**相关API**: `mobile/services/api.ts:105-120`
```typescript
export const challengeAPI = {
  async getAllChallenges() {
    return fetchWithAuth(`${API_BASE_URL}/challenges`);
  },
  async createChallenge(data: { title: string; description: string; rewardPoints: number; rewardExp: number }) {
    return fetchWithAuth(`${API_BASE_URL}/challenges`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  },
  async completeChallenge(studentId: string, challengeId: string) {
    return fetchWithAuth(`${API_BASE_URL}/challenges/${challengeId}/complete`, {
      method: 'POST',
      body: JSON.stringify({ studentId })
    });
  }
};
```

## 数据导出功能

### 1. Excel导出
**函数**: `handleExportStudentXlsx(student: Student)` (第1007-1024行)
```typescript
const handleExportStudentXlsx = (student: Student) => {
  const range = getRange(exportPeriod);

  // 创建各工作表数据
  const infoRows = [['字段','值'], ['姓名', student.name], ['班级', student.className],
                   ['积分', String(student.points)], ['经验', String(student.exp)]];

  const badgeRows = [['荣誉名称','授予日期'],
    ...student.badgeHistory.filter(b=>inRange(b.date)).map(b=>[b.name, toDateStr(b.date)])];

  const taskRows = [['任务名称','参与日期','完成','经验值'],
    ...student.taskHistory.filter(r=>inRange(r.date)).map(r=>[r.title, toDateStr(r.date), '是', String(r.exp||0)])];

  const challengeRows = [['挑战名称','挑战日期','结果'],
    ...student.challengeHistory.filter(c=>inRange(c.date)).map(c=>[c.title, toDateStr(c.date), c.result||''])];

  const pkRows = [['对手','主题','结果','日期'],
    ...student.pkHistory.filter(p=>inRange(p.date)).map(p=>[p.opponentName, p.topic, p.result, toDateStr(p.date)])];

  const habitRows = [['习惯名称','打卡天数'],
    ...habits.map(h=>[h.name, String(student.habitStats?.[h.id]||0)])];

  // 创建工作簿
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(infoRows), '个人信息');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(badgeRows), '荣誉数据');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(taskRows), '任务数据');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(challengeRows), '挑战数据');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pkRows), 'PK数据');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(habitRows), '习惯打卡');

  XLSX.writeFile(wb, `${student.name}-综合记录.xlsx`);
};
```

### 2. 时间维度选择
**UI组件**: 第1528-1542行
```typescript
{exportPickerOpen && (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6">
    <div className="bg-white w-full max-w-xs rounded-2xl p-5 shadow-xl">
      <h3 className="font-bold text-lg text-gray-800 mb-4 text-center">选择导出时间维度</h3>
      <div className="grid grid-cols-3 gap-2">
        <button onClick={() => { setExportPeriod('week'); handleExportStudentXlsx(selectedStudent!); setExportPickerOpen(false); }}
                className="p-2 rounded-xl bg-primary text-white text-sm font-bold">
          本周
        </button>
        <button onClick={() => { setExportPeriod('month'); handleExportStudentXlsx(selectedStudent!); setExportPickerOpen(false); }}
                className="p-2 rounded-xl bg-primary text-white text-sm font-bold">
          本月
        </button>
        <button onClick={() => { setExportPeriod('term'); handleExportStudentXlsx(selectedStudent!); setExportPickerOpen(false); }}
                className="p-2 rounded-xl bg-primary text-white text-sm font-bold">
          本学期
        </button>
      </div>
    </div>
  </div>
)}
```

## 学生信息编辑功能

### 1. 姓名编辑
**触发**: 点击姓名旁的编辑图标 (第1251-1256行)
**组件**: StudentNameEditor (第7行导入)
```typescript
<button onClick={() => setEditingStudent(selectedStudent)}>
  <Edit2 size={18} className="text-primary" />
</button>
```

### 2. 班级分配
**功能**: 动态选择学生班级 (第1274-1295行)
```typescript
<div onClick={() => setShowClassPicker(true)} className="cursor-pointer">
  {selectedStudent.className || '未分班'}
</div>

{showClassPicker && (
  <select value={selectedStudent.className || ''}
          onChange={e => handleSelectStudentClass(selectedStudent.id, e.target.value)}
          className="w-full p-2 rounded-xl bg-gray-50 text-sm outline-none">
    {(classes || []).map(c => <option key={c} value={c}>{c}</option>)}
  </select>
)}
```

**相关API**: `mobile/services/api.ts:55-60`
```typescript
// 更新学生信息
async updateStudent(studentId: string, data: any) {
  return fetchWithAuth(`${API_BASE_URL}/students/${studentId}`, {
    method: 'PUT',
    body: JSON.stringify(data)
  });
}
```

### 3. 战队分配
**功能**: 动态选择学生战队 (第1269-1284行)
```typescript
<div onClick={() => setShowTeamPicker(true)} className="cursor-pointer">
  {(teams || []).find(t => t.id === selectedStudent.teamId)?.name || '未分队'}
</div>

{showTeamPicker && (
  <select value={selectedStudent.teamId || ''}
          onChange={e => handleSelectStudentTeam(selectedStudent.id, e.target.value)}
          className="w-full p-2 rounded-xl bg-gray-50 text-sm outline-none">
    {(teams || []).map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
  </select>
)}
```

## 分页功能

### 勋章分页
**位置**: 第1345-1352行
```typescript
// 分页状态
const [badgePage, setBadgePage] = useState(0);
const [habitPage, setHabitPage] = useState(0);

// 分页计算
const PAGE_SIZE = 9;
const startIndex = badgePage * PAGE_SIZE;
const endIndex = startIndex + PAGE_SIZE;
const pageItems = studentBadges.slice(startIndex, endIndex);

// 分页控制
<div className="flex justify-between items-center">
  <button disabled={badgePage === 0} onClick={() => setBadgePage(badgePage - 1)}>
    上一页
  </button>
  <button disabled={endIndex >= studentBadges.length} onClick={() => setBadgePage(badgePage + 1)}>
    下一页
  </button>
</div>
```

### 习惯打卡分页
**位置**: 第1330-1340行
```typescript
const habitStartIndex = habitPage * PAGE_SIZE;
const habitEndIndex = habitStartIndex + PAGE_SIZE;
const pageItems = safeHabits.slice(habitStartIndex, habitEndIndex);
```

## 数据同步机制

### 1. 学生状态同步
**位置**: 第198-206行
```typescript
// 同步 selectedStudent 与 students 的更新（包括 habitStats）
React.useEffect(() => {
  if (selectedStudent) {
    const updatedStudent = students.find(s => s.id === selectedStudent.id);
    if (updatedStudent) {
      setSelectedStudent(updatedStudent);
    }
  }
}, [students]);
```

### 2. 自动状态更新
当以下操作发生时，selectedStudent会自动更新：
- 学生积分/经验变更
- 班级/战队分配变更
- 姓名修改
- 习惯打卡数据更新
- 任务/挑战/PK记录变更

## 错误处理

### 1. 加载失败处理
**位置**: 第1550-1565行
```typescript
// 渲染错误时的fallback
return (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
    <div className="bg-white w-full max-w-md rounded-3xl p-8 text-center">
      <h3 className="text-lg font-bold text-red-600 mb-4">加载失败</h3>
      <p className="text-sm text-gray-600 mb-4">学生信息加载出错，请稍后重试</p>
      <button onClick={() => setSelectedStudent(null)} className="px-4 py-2 rounded-xl bg-primary text-white text-sm font-bold">
        关闭
      </button>
    </div>
  </div>
);
```

### 2. 数据容错机制
- 空数据检查：`selectedStudent.badgeHistory || []`
- 数组安全处理：`Array.isArray(habits) ? habits : []`
- 默认值处理：`selectedStudent.habitStats?.[h.id] || 0`

## 用户交互

### 1. 长按删除功能
**应用**: 所有记录卡片（勋章、PK、任务等）
**功能**: 长按500ms后显示删除确认对话框

### 2. 触摸优化
- 移动端适配的触摸反馈
- 适当的点击区域大小
- 滑动和滚动的优化处理

### 3. 动画效果
- 面板打开/关闭动画：`animate-in zoom-in-95`
- 按钮点击反馈：`active:scale-95`
- 状态切换动画：`transition-colors`

## 性能优化

### 1. 虚拟滚动
**长列表处理**:
- PK记录：`max-h-[300px] overflow-y-auto`
- 任务记录：`max-h-[300px] overflow-y-auto`
- 挑战记录：`max-h-[300px] overflow-y-auto`

### 2. 懒加载
- 只显示最近一个月的记录
- 分页加载勋章和习惯数据

### 3. 缓存机制
- 学生数据的本地缓存
- API响应结果的临时存储

## 总结

个人信息面板是移动端应用的核心功能模块，提供了完整的学生数据管理功能：

### 主要特点：
1. **全面的的学生信息展示**：基本信息、积分、经验、等级
2. **丰富的数据记录**：勋章、习惯、PK、任务、挑战
3. **便捷的管理功能**：编辑姓名、分配班级/战队
4. **强大的导出功能**：Excel格式，多时间维度选择
5. **优秀的用户体验**：移动端优化、动画效果、错误处理

### 技术亮点：
- 模块化的组件设计
- 完善的API集成
- 实时数据同步
- 响应式UI设计
- 容错机制完善

这个面板为教师提供了全面了解和管理学生数据的便捷入口，是移动端教学管理的重要组成部分。