star-è¿‡å…³ç®¡ç†ä»£ç 
æ–‡æ¡£ä¸­æ‰€æœ‰å…³äºç§¯åˆ†éƒ¨åˆ†çš„æè¿°å…¨éƒ¨å®šä¹‰ä¸ºç»éªŒå€¼ï¼Œä¸ä»£ç ä¸­ç»éªŒå€¼çš„å®šä¹‰ä¿æŒä¸€è‡´ã€‚


æ‚¨æåˆ°çš„**â€œè¿‡å…³å¤šæ¬¡å°è¯•ï¼ˆRetries & Effortï¼‰â€**ï¼Œå®é™…ä¸Šæ˜¯æ‰˜ç®¡æœåŠ¡ä¸­**â€œè¿‡ç¨‹ä»·å€¼â€**çš„ä½“ç°ã€‚å¯¹äºå®¶é•¿è€Œè¨€ï¼Œå­©å­ä¸€æ¬¡è¿‡å…³æ˜¯èªæ˜ï¼Œä½†**â€œè€å¸ˆé™ªç€å­©å­è¯•äº†4æ¬¡ç»ˆäºè¿‡å…³â€**ï¼Œæ‰æ˜¯æœ€èƒ½ä½“ç°æ‰˜ç®¡ç­**è€å¿ƒã€è´Ÿè´£ã€ç²¾ç»†åŒ–æœåŠ¡**çš„æ—¶åˆ»ã€‚

æˆ‘å·²å°†æ­¤åŠŸèƒ½æ·±åº¦èå…¥æŠ€æœ¯æ¶æ„ä¸ä»£ç ä¸­ï¼Œå½¢æˆ**v8.0 ç»ˆææœåŠ¡ç‰ˆ**ã€‚

---

# ğŸ“˜ ç¬¬ä¸€éƒ¨åˆ†ï¼šæŠ€æœ¯è§„æ ¼è¯´æ˜ä¹¦ (v5.0 Effort Edition)

**æ ¸å¿ƒç†å¿µå‡çº§**: **ç»Ÿä¸€è°ƒåº¦ Â· åŒè½¨æ‰§è¡Œ Â· åŠªåŠ›å¯è§ (Effort Visible)**

## 1. ä¸šåŠ¡é€»è¾‘å‡çº§ï¼šè¿‡å…³çŠ¶æ€æœºçš„é‡æ„

æˆ‘ä»¬ä¸å†ä»…ä»…å…³æ³¨ç»“æœï¼ˆè¿‡/ä¸è¿‡ï¼‰ï¼Œè€Œæ˜¯å…³æ³¨**è¿‡ç¨‹ï¼ˆå°è¯•æ¬¡æ•°ï¼‰**ã€‚

*   **æ—§é€»è¾‘**: `Pending` (å¾…å®š) $\leftrightarrow$ `Passed` (é€šè¿‡)
*   **æ–°é€»è¾‘ (çŠ¶æ€æœº)**:
    1.  **Initial**: `Pending` (Attempt: 0)
    2.  **Action**: è€å¸ˆè¾…å¯¼åå‘ç°æœªè¿‡ $\to$ ç‚¹å‡» **"âš ï¸ è¾…å¯¼/é‡è¯•"**
    3.  **State**: `Pending` (Attempt: 1, 2, 3...)
    4.  **Action**: ç»ˆäºä¼šäº† $\to$ ç‚¹å‡» **"âœ“ é€šè¿‡"**
    5.  **Final**: `Passed` (Attempt: 4) $\to$ **é«˜å…‰æ—¶åˆ»**

## 2. æ•°æ®åº“è®¾è®¡å˜æ›´ (Schema Update)

åœ¨æ ¸å¿ƒæµæ°´è¡¨ä¸­å¢åŠ è®¡æ•°å™¨ä¸éš¾åº¦æ ‡è®°ã€‚

```sql
ALTER TABLE lms_student_record 
ADD COLUMN attempt_count INTEGER DEFAULT 0,  -- å°è¯•æ¬¡æ•° (0è¡¨ç¤ºä¸€æ¬¡è¿‡ï¼Œ>0è¡¨ç¤ºæœ‰é‡è¯•)
ADD COLUMN difficulty_flag BOOLEAN DEFAULT FALSE; -- æ ‡è®°ä¸º"ç¡¬éª¨å¤´"ä»»åŠ¡
```

## 3. æ ¸å¿ƒ API å˜æ›´

*   **PATCH** `/api/records/{id}/attempt` **(æ–°å¢)**
    *   **åŠŸèƒ½**: è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯•ï¼ˆæˆ–è¾…å¯¼è®°å½•ï¼‰ã€‚
    *   **é€»è¾‘**: `attempt_count = attempt_count + 1`, `status` ä¿æŒ `PENDING`ã€‚
*   **PATCH** `/api/records/{id}/qc_pass` **(å‡çº§)**
    *   **é€»è¾‘**: æ›´æ–° `status = PASSED`ã€‚å¦‚æœ `attempt_count > 2`ï¼Œè‡ªåŠ¨æ ‡è®°ä¸ºâ€œé¡½å›ºé”™é¢˜â€ï¼Œå»ºè®®æ¨é€åˆ°å‘¨æŠ¥çš„é‡ç‚¹å¤ä¹ åŒºã€‚

---

# ğŸ“± ç¬¬äºŒéƒ¨åˆ†ï¼šç»ˆæå…¨åŠŸèƒ½èåˆç‰ˆä»£ç  (v8.0)

**æ–°å¢åŠŸèƒ½é«˜äº®**ï¼š
1.  **è´¨æ£€å°-è¾…å¯¼è®°å½•**ï¼šåœ¨è¿‡å…³é¡¹æ—è¾¹å¢åŠ äº† **`âš ï¸ è¾…å¯¼`** æŒ‰é’®ã€‚ç‚¹ä¸€æ¬¡ï¼Œå°è¯•æ¬¡æ•°+1ã€‚
2.  **ç»“ç®—å°-åŠªåŠ›å¤–æ˜¾**ï¼šå¦‚æœä¸€ä¸ªä»»åŠ¡æ˜¯å°è¯•å¤šæ¬¡æ‰è¿‡çš„ï¼Œç»“ç®—é¡µä¼šæ˜¾ç¤º **`ğŸ”¥ Næ¬¡è¿‡å…³`** æ ‡ç­¾ï¼Œå½°æ˜¾æœåŠ¡ä»·å€¼ã€‚
3.  **æ‰€æœ‰ä¹‹å‰åŠŸèƒ½å…¨ä¿ç•™**ï¼šå¤‡è¯¾è®°å¿†ã€CMSã€ä¸€é”®è¿‡å…³ã€è¿›åº¦ä¿®æ”¹ç­‰ã€‚

è¯·ä¿å­˜è¿è¡Œï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ˜Ÿé€”ä¸ä¼´ - æ·±åº¦æœåŠ¡ç»ˆæç‰ˆ (v8.0)</title>
    <style>
        /* --- 1. æ ¸å¿ƒè§†è§‰å˜é‡ --- */
        :root {
            --qc-color: #EF4444;    /* è´¨æ£€çº¢ */
            --qc-bg: #FEF2F2;
            --task-color: #3B82F6;  /* ä»»åŠ¡è“ */
            --task-bg: #EFF6FF;
            --primary: #4F46E5;     /* ä¸»è‰²ç´« */
            --success: #10B981;     /* æˆåŠŸç»¿ */
            --warning: #F59E0B;     /* è­¦å‘Šæ©™ */
            --bg: #F1F5F9;
            --card: #FFFFFF;
            --text: #0F172A;
            --gray: #64748B;
            --border: #E2E8F0;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #e5e7eb; display: flex; justify-content: center; height: 100vh; }
        .phone { width: 375px; height: 100%; background: var(--bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* --- å¤´éƒ¨ä¸å¯¼èˆª --- */
        .header { background: var(--card); padding: 44px 16px 0; border-bottom: 1px solid var(--border); z-index: 10; display: flex; flex-direction: column; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .page-title { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 12px; }
        
        .sub-tabs { display: flex; gap: 24px; }
        .sub-tab { padding-bottom: 10px; font-size: 15px; color: var(--gray); font-weight: 600; cursor: pointer; position: relative; transition: 0.2s; }
        .sub-tab.active { color: var(--primary); }
        .sub-tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--primary); border-radius: 2px; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; }
        .card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* --- å¤‡è¯¾é¡µç»„ä»¶ --- */
        .dynamic-input-row { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; background: #F8FAFC; padding: 12px 8px; border-radius: 8px; border: 1px solid var(--border); }
        .input-label { font-size: 14px; font-weight: 600; color: var(--gray); white-space: nowrap; }
        .inline-input { border: none; background: transparent; border-bottom: 1px dashed #ccc; width: 40px; text-align: center; font-weight: 700; font-size: 15px; color: var(--primary); padding: 0 2px; outline: none; }
        .inline-input.long { width: 100px; text-align: left; }
        .inline-input:focus { border-bottom-color: var(--primary); }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-label { font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        /* èƒ¶å›Šæ ‡ç­¾ */
        .selected-chips-area { display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; margin-bottom: 12px; }
        .chip { display: flex; align-items: center; font-size: 13px; padding: 6px 10px; border-radius: 6px; font-weight: 500; }
        .chip-qc { background: var(--qc-bg); color: var(--qc-color); border: 1px solid rgba(239,68,68,0.2); }
        .chip-task { background: var(--task-bg); color: var(--task-color); border: 1px solid rgba(59,130,246,0.2); }
        .chip-empty { color: #9CA3AF; font-size: 13px; padding: 6px 0; font-style: italic; }

        .btn-dropdown { width: 100%; padding: 10px; border: 1px dashed var(--border); background: #F8FAFC; color: var(--gray); border-radius: 8px; font-size: 13px; font-weight: 600; text-align: center; cursor: pointer; transition: 0.2s; }
        .btn-dropdown:active { background: #E2E8F0; }

        /* ä¸ªæ€§åŒ–åŠ é¤åˆ—è¡¨é¡¹ */
        .special-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 8px; border-left: 3px solid var(--warning); margin-bottom: 8px; }
        .sp-info { flex: 1; }
        .sp-stu { font-size: 12px; font-weight: 700; color: var(--text); }
        .sp-task { font-size: 13px; color: var(--gray); margin-top: 2px; }
        .sp-del { padding: 8px; color: #cbd5e1; cursor: pointer; }

        /* --- åº•éƒ¨å¯¼èˆª --- */
        .tab-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 60px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 20; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #94A3B8; font-size: 10px; cursor: pointer; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 22px; margin-bottom: 2px; }
        
        .btn-main { width: 100%; padding: 14px; background: var(--text); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* --- å¼¹çª—ä¸æŠ½å±‰ç³»ç»Ÿ --- */
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: flex-end; backdrop-filter: blur(2px); }
        .drawer-overlay.show { display: flex; }
        .drawer-content { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s; max-height: 85vh; display: flex; flex-direction: column; }
        
        .drawer-right { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: flex-end; }
        .drawer-right.show { display: flex; }
        .drawer-panel { background: #fff; width: 85%; height: 100%; padding: 20px; animation: slideLeft 0.3s; display: flex; flex-direction: column; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideLeft { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- å¤‡è¯¾é¡µé€‰æ‹©å™¨ --- */
        .selector-list { overflow-y: auto; max-height: 300px; margin-bottom: 10px; }
        .selector-item { padding: 12px; border-bottom: 1px solid #F1F5F9; display: flex; align-items: center; cursor: pointer; }
        .selector-checkbox { width: 20px; height: 20px; border: 2px solid #CBD5E1; border-radius: 4px; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: white; }
        .selector-item.selected .selector-checkbox { background: var(--primary); border-color: var(--primary); }
        .add-new-row { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .mini-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn-mini { padding: 0 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; }

        /* --- ä¸ªæ€§åŒ–å¼¹çª— (å†å²è®°å¿†+å¤šé€‰) --- */
        .history-area { margin-bottom: 20px; max-height: 150px; overflow-y: auto; flex:1; }
        .history-tag { padding: 8px 12px; border-radius: 8px; font-size: 13px; background: #F1F5F9; color: #475569; cursor: pointer; display: flex; align-items: center; gap: 8px; border: 1px solid transparent; transition: all 0.2s; margin-bottom: 6px; display: inline-flex; margin-right: 6px;}
        .history-tag.selected { background: #EEF2FF; color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .tag-delete { font-size: 14px; color: #CBD5E1; padding: 2px 4px; }
        .st-select-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .st-item { text-align: center; padding: 10px 0; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px; color: var(--gray); transition:0.2s; }
        .st-item.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- è´¨æ£€å°æ ·å¼ --- */
        .roster-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .student-card { background: var(--card); padding: 16px 8px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; border: 1px solid transparent; transition: 0.1s; }
        .student-card:active { transform: scale(0.96); }
        .avatar { width: 44px; height: 44px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 8px; }
        .progress-bar { width: 80%; height: 4px; background: #F1F5F9; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .progress-val { height: 100%; background: var(--qc-color); transition: width 0.3s; }
        
        .lesson-edit-box { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 13px; color: var(--gray); display: flex; justify-content: space-between; align-items: center; }
        .lesson-edit-btn { color: var(--primary); font-weight: 600; font-size: 12px; cursor: pointer; white-space: nowrap; margin-left: 8px; border: 1px solid var(--primary); padding: 4px 8px; border-radius: 4px;}
        
        /* æ ¸å¿ƒï¼šè¿‡å…³å¤šæ¬¡å°è¯•äº¤äº’ */
        .qc-item { display: flex; padding: 12px 8px; border-bottom: 1px solid #eee; align-items: center; transition: background 0.2s; position: relative; overflow: hidden;}
        .qc-item:active { background: #FEF2F2; } 
        .checkbox { width: 24px; height: 24px; border: 2px solid #CBD5E1; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; transition: 0.2s; flex-shrink: 0; margin-right: 8px;}
        .checkbox.checked { background: var(--success); border-color: var(--success); }
        
        .btn-retry { padding: 4px 8px; background: #FFF1F2; color: #E11D48; border: 1px solid #FECDD3; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 12px; display: flex; align-items: center; gap: 2px; cursor: pointer;}
        .attempt-tag { font-size: 10px; color: #94A3B8; margin-left: 4px; background: #F1F5F9; padding: 2px 4px; border-radius: 4px;}
        
        .btn-pass-all { padding: 6px 12px; background: var(--success); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.2); }

        /* --- ç»“ç®—å° & CMSæŠ½å±‰ --- */
        .settle-group { margin-bottom: 16px; background: var(--card); border-radius: 16px; overflow: hidden; }
        .group-header { padding: 12px 16px; background: #F8FAFC; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-add-claim { padding: 6px 12px; background: var(--primary); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); cursor: pointer; }
        
        .task-row { padding: 12px 16px; border-bottom: 1px solid #F1F5F9; display: flex; align-items: center; }
        .magic-check { width: 22px; height: 22px; background: var(--success); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 12px; }
        
        .badge { font-size: 10px; padding: 1px 4px; border-radius: 4px; font-weight: 600; margin-left: 4px; }
        .badge-qc { background: #ECFDF5; color: #10B981; }
        .badge-auto { background: #FFF7ED; color: var(--warning); }
        .badge-special { background: #EFF6FF; color: var(--primary); }
        .badge-effort { background: #FEF2F2; color: #DC2626; display: inline-flex; align-items: center; gap: 2px;} /* åŠªåŠ›æ ‡ç­¾ */
        
        /* CMS æŠ½å±‰æ ·å¼ */
        .drawer-content-up { background: #fff; width: 100%; height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s; }
        .drawer-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .selector-body { flex: 1; display: flex; overflow: hidden; }
        .category-sidebar { width: 95px; background: #F8FAFC; overflow-y: auto; display: flex; flex-direction: column; }
        .cat-item { padding: 16px 10px; font-size: 12px; color: var(--gray); border-left: 3px solid transparent; cursor: pointer; transition: 0.2s; position: relative;}
        .cat-item.active { background: #fff; color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        .task-list-area { flex: 1; overflow-y: auto; padding: 10px; background: #fff; }
        .task-option { padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .manage-btn { padding: 4px 10px; border-radius: 12px; font-size: 12px; border: 1px solid #ccc; background: white; color: #666; display: flex; align-items: center; gap: 4px;}
        .manage-btn.active { background: var(--text); color: white; border-color: var(--text); }
        .edit-mode-border { border: 1px dashed #F59E0B !important; background: #FFFBEB !important; }
        .delete-icon { color: #EF4444; font-size: 18px; padding: 5px; }
        .manual-entry-area { padding: 12px 16px; background: #fff; border-bottom: 1px solid #F1F5F9; }
        .manual-input { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; background: #fff; }
        .btn-manual-add { padding: 0 16px; height: 40px; background: var(--text); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }

        /* é¡µé¢æ˜¾ç¤ºæ§åˆ¶ */
        .page { display: none; height: 100%; flex-direction: column; }
        .page.active { display: flex; }

    </style>
</head>
<body>

<div class="phone">

    <!-- ==================== PAGE 1: ç»Ÿä¸€å¤‡è¯¾ ==================== -->
    <div id="page-prep" class="page active">
        <div class="header">
            <div class="page-title">ä»Šæ—¥å¤‡è¯¾</div>
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="switchSubject('chinese', this)">è¯­æ–‡</div>
                <div class="sub-tab" onclick="switchSubject('math', this)">æ•°å­¦</div>
                <div class="sub-tab" onclick="switchSubject('english', this)">è‹±è¯­</div>
            </div>
        </div>
        
        <div class="scroll-area">
            <div id="subject-content">
                <!-- åŠ¨æ€è¿›åº¦è¾“å…¥ -->
                <div id="dynamic-input-area" class="dynamic-input-row"></div>

                <!-- è´¨æ£€è¿‡å…³é¡¹ -->
                <div class="card" style="border-left: 4px solid var(--qc-color);">
                    <div class="section-header">
                        <div class="section-label" style="color:var(--qc-color)">ğŸ›¡ï¸ è´¨æ£€è¿‡å…³é¡¹</div>
                        <div style="font-size:11px; color:#999;">åŒæ­¥è‡³èŠ±åå†Œ</div>
                    </div>
                    <div class="selected-chips-area" id="qc-chips-area"></div>
                    <div class="btn-dropdown" onclick="openSelector('QC')">+ é€‰æ‹© / æ–°å¢è¿‡å…³é¡¹</div>
                </div>

                <!-- è¿‡ç¨‹ä»»åŠ¡é¡¹ -->
                <div class="card" style="border-left: 4px solid var(--task-color);">
                    <div class="section-header">
                        <div class="section-label" style="color:var(--task-color)">ğŸŒ± å­¦ä¹ è¿‡ç¨‹ä»»åŠ¡</div>
                        <div style="font-size:11px; color:#999;">åŒæ­¥è‡³ç»“ç®—é¡µ</div>
                    </div>
                    <div class="selected-chips-area" id="task-chips-area"></div>
                    <div class="btn-dropdown" onclick="openSelector('TASK')">+ é€‰æ‹© / æ–°å¢ä»»åŠ¡</div>
                </div>
            </div>

            <!-- å…¨å±€ä¸ªæ€§åŒ–åŠ é¤ -->
            <div class="card" style="border: 2px dashed #E2E8F0; margin-top:20px;">
                <div class="section-header"><div class="section-label">ğŸŒŸ ä¸ªæ€§åŒ–åŠ é¤ (å…¨ç§‘é€šç”¨)</div></div>
                <div id="special-list"></div>
                <button onclick="showSpecialModal()" style="width:100%; padding:10px; background:#F8FAFC; border:1px solid #E2E8F0; color:var(--gray); border-radius:8px;">+ ä¸ºç‰¹å®šå­¦ç”Ÿæ·»åŠ ä»»åŠ¡ (å¸¦è®°å¿†)</button>
            </div>
            
            <button class="btn-main" onclick="publishPlan()">ä¸€é”®å‘å¸ƒä»Šæ—¥è®¡åˆ’</button>
        </div>
    </div>

    <!-- ==================== PAGE 2: è´¨æ£€å° ==================== -->
    <div id="page-qc" class="page">
        <div class="header" style="padding-bottom:12px;">
            <div class="page-title">è¿‡å…³è´¨æ£€å°</div>
            <div style="font-size:12px; color:var(--gray); margin-top:4px;">è®°å½•è¾…å¯¼è¿‡ç¨‹ï¼Œä½“ç°æ·±åº¦æœåŠ¡</div>
        </div>
        <div class="scroll-area">
            <div class="roster-grid" id="roster-container"></div>
        </div>
    </div>

    <!-- ==================== PAGE 3: ç»“ç®—å° ==================== -->
    <div id="page-settle" class="page">
        <div class="header" style="padding-bottom:12px; display:flex; justify-content:space-between;">
            <div>
                <div class="page-title">ä»»åŠ¡ç»“ç®—å°</div>
                <div style="font-size:12px; color:var(--gray); margin-top:4px;">ç¡®è®¤å®Œæˆ & å‘æ”¾EXP</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:24px; font-weight:800; color:var(--primary);" id="total-exp">0</div>
                <div style="font-size:10px; color:#999;">TOTAL EXP</div>
            </div>
        </div>
        <div class="scroll-area" id="settle-container"></div>
        <div style="padding:16px; background:white; border-top:1px solid #eee;">
            <button class="btn-main" onclick="alert('ç»“ç®—å®Œæˆï¼')">ç¡®è®¤ä»Šæ—¥ç»“ç®—</button>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchPage('prep', this)"><div class="tab-icon">ğŸ“</div>å¤‡è¯¾</div>
        <div class="tab-item" onclick="switchPage('qc', this)"><div class="tab-icon">ğŸ›¡ï¸</div>è´¨æ£€</div>
        <div class="tab-item" onclick="switchPage('settle', this)"><div class="tab-icon">ğŸ’°</div>ç»“ç®—</div>
    </div>

    <!-- === å¼¹çª—1: å¤‡è¯¾-åŸºç¡€é¡¹é€‰æ‹©å™¨ === -->
    <div class="drawer-overlay" id="selectorDrawer">
        <div class="drawer-content">
            <div style="font-weight:700; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <span id="selector-title">é€‰æ‹©é¡¹</span> <span onclick="closeSelector()" style="color:#999; font-size:24px; line-height:1;">âœ•</span>
            </div>
            <div class="selector-list" id="selector-list-container"></div>
            <div class="add-new-row">
                <input type="text" id="new-item-input" class="mini-input" placeholder="è¾“å…¥æ²¡åœ¨åˆ—è¡¨é‡Œçš„æ–°é¡¹...">
                <button class="btn-mini" onclick="addNewItemToSelector()">æ·»åŠ </button>
            </div>
            <button class="btn-main" style="margin-top:15px;" onclick="closeSelector()">ç¡®å®š</button>
        </div>
    </div>

    <!-- === å¼¹çª—2: å¤‡è¯¾-ä¸ªæ€§åŒ–åŠ é¤ (è®°å¿†+å¤šé€‰) === -->
    <div class="drawer-overlay" id="specialModal">
        <div class="drawer-content">
            <div style="font-weight:700; margin-bottom:15px; display:flex; justify-content:space-between;">
                æ·»åŠ ä¸ªæ€§åŒ–ä»»åŠ¡ <span onclick="closeModals()" style="color:#999;">âœ•</span>
            </div>
            <div style="font-size:12px; color:#666; margin-bottom:8px;">1. é€‰æ‹©å­¦ç”Ÿ (å¤šé€‰)</div>
            <div class="st-select-grid">
                <div class="st-item" onclick="this.classList.toggle('selected')">å¼ å°æ˜</div>
                <div class="st-item" onclick="this.classList.toggle('selected')">æå°èŠ±</div>
                <div class="st-item" onclick="this.classList.toggle('selected')">ç‹å¤§åŠ›</div>
            </div>
            <div style="font-size:12px; color:#666; margin-bottom:8px;">2. ä»»åŠ¡å†…å®¹ (å†å²æ ‡ç­¾ + æ‰‹åŠ¨è¾“å…¥)</div>
            <div class="history-area"><div id="special-history-tags"></div></div>
            <input type="text" id="prepInput" placeholder="æ‰‹åŠ¨è¾“å…¥æ–°ä»»åŠ¡..." class="mini-input" style="width:100%; margin-bottom:15px;">
            <button class="btn-main" onclick="confirmAddSpecial()">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>

    <!-- === æŠ½å±‰3: è´¨æ£€-å­¦ç”Ÿè¯¦æƒ… (å‡çº§ï¼šè¾…å¯¼æ¬¡æ•°è®°å½•) === -->
    <div class="drawer-right" id="qcDetailDrawer">
        <div class="drawer-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span class="page-title" id="qc-drawer-name" style="margin:0; font-size:18px;">å­¦ç”Ÿ</span>
                <div style="display:flex; align-items:center; gap:12px;">
                    <button class="btn-pass-all" onclick="passAllQC()">âœ¨ ä¸€é”®è¿‡å…³</button>
                    <span onclick="closeQcDetail()" style="font-size:24px; color:#999; cursor:pointer;">âœ•</span>
                </div>
            </div>
            <div class="lesson-edit-box">
                <div>
                    <div style="font-size:10px; color:#94A3B8; margin-bottom:2px;">å½“å‰è¿›åº¦:</div>
                    <div id="student-current-lesson" style="color:#0F172A; font-weight:600; line-height:1.4;">--</div>
                </div>
                <div class="lesson-edit-btn" onclick="openEditLessonModal()">âœ ä¿®æ”¹</div>
            </div>
            <div class="section-label" style="margin-bottom:10px; color:var(--qc-color);">éœ€è¿‡å…³é¡¹ç›® (âš ï¸ ç‚¹ä¸€æ¬¡è®°å½•ä¸€æ¬¡åŠªåŠ›)</div>
            <div id="qc-detail-list"></div>
            <div style="font-size:10px; color:#ccc; text-align:center; margin-top:20px;">ğŸ’¡ é•¿æŒ‰ä»»æ„æ¡ç›®å¯åˆ é™¤</div>
        </div>
    </div>

    <!-- === å¼¹çª—4: è´¨æ£€-è¿›åº¦ä¿®æ”¹ === -->
    <div class="drawer-overlay" id="editLessonModal">
        <div class="drawer-content">
            <div style="font-weight:700; margin-bottom:20px;">ä¿®æ”¹è¯¥ç”Ÿè¿›åº¦</div>
            <div id="modal-input-area" class="dynamic-input-row" style="margin-bottom:30px;"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-main" style="background:#F1F5F9; color:#64748B;" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn-main" onclick="confirmEditLesson()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- === æŠ½å±‰5: ç»“ç®—-CMSä»»åŠ¡åº“ (ç®¡ç†+è¡¥å½•) === -->
    <div class="drawer-overlay" id="autoTaskDrawer">
        <div class="drawer-content-up">
            <div class="drawer-header">
                <div>
                    <div style="font-size:16px; font-weight:700;">è‡ªä¸»ä»»åŠ¡ç”³æŠ¥</div>
                    <div style="font-size:12px; color:#64748B;">å­¦ç”Ÿï¼š<span id="autoStudentName" style="color:#4F46E5; font-weight:bold;">--</span></div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="manage-btn" id="btnManage" onclick="toggleManageMode()">âš™ï¸ ç®¡ç†åº“</button>
                    <div onclick="closeAutoDrawer()" style="padding:5px; cursor:pointer; font-size:18px;">âœ•</div>
                </div>
            </div>
            <div class="manual-entry-area">
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" id="manualName" class="manual-input" placeholder="âœ¨ æ‰‹åŠ¨è¾“å…¥ç‰¹æ®Šä»»åŠ¡..." style="flex:1;">
                    <div style="display:flex; align-items:center; background:#F1F5F9; border-radius:8px; padding:0 8px;">
                        <span style="font-size:12px; color:#64748B; font-weight:bold;">+</span>
                        <input type="number" id="manualExp" class="manual-input" value="10" style="width:45px; text-align:center; background:transparent; border:none; padding:8px 0;">
                    </div>
                    <button class="btn-manual-add" onclick="addManualTask()">æ·»åŠ </button>
                </div>
            </div>
            <div class="selector-body">
                <div class="category-sidebar" id="categoryList"></div>
                <div class="task-list-area" id="taskList"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. æ•°æ®ä¸­å¿ƒ ---
    const SUBJECT_DB = {
        chinese: { inputs: { unit: "1", lesson: "2", title: "å¤è¯—äºŒé¦–" }, qc_options: ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ", "å¤è¯—é»˜å†™", "è¯¾æ–‡ç†è§£"], task_options: ["è¯¾æ–‡æœ—è¯»", "ä¹¦å†™è§„èŒƒ", "é˜…è¯»æ‰“å¡"], selected_qc: ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ"], selected_task: ["è¯¾æ–‡æœ—è¯»"] },
        math: { inputs: { unit: "1", lesson: "3", title: "é™¤æ³•è®¡ç®—" }, qc_options: ["å£ç®—è¾¾æ ‡", "ç«–å¼è®¡ç®—", "å…¬å¼èƒŒè¯µ"], task_options: ["è®²é¢˜å°è€å¸ˆ", "åº”ç”¨é¢˜å®¡é¢˜", "é”™é¢˜è®¢æ­£"], selected_qc: ["å£ç®—è¾¾æ ‡"], selected_task: ["é”™é¢˜è®¢æ­£"] },
        english: { inputs: { unit: "1", title: "Hello World" }, qc_options: ["å•è¯é»˜å†™", "å¥å‹èƒŒè¯µ"], task_options: ["æƒ…æ™¯å¯¹è¯", "ç»˜æœ¬é˜…è¯»"], selected_qc: ["å•è¯é»˜å†™"], selected_task: ["æƒ…æ™¯å¯¹è¯"] }
    };
    
    // CMS ä»»åŠ¡åº“
    const DEFAULT_TASK_DB = {
        "åŸºç¡€æ ¸å¿ƒ": [{name:"å®Œæˆæ•°å­¦ä½œä¸š",exp:5}, {name:"å®Œæˆè¯­æ–‡ä½œä¸š",exp:5}, {name:"é”™é¢˜çº¢ç¬”è®¢æ­£",exp:10}, {name:"ä½œä¸šè‡ªä¸»æ£€æŸ¥",exp:10}],
        "æ•°å­¦å·©å›º": [{name:"100é“å£ç®—",exp:10}, {name:"è¯´é¢˜ç»ƒä¹ ",exp:30}, {name:"æ‰¾æ¯é¢˜/å˜å¼",exp:100}],
        "è¯­æ–‡æ‹“å±•": [{name:"å¬å†™ç»ƒä¹ ",exp:10}, {name:"å¥½å¥ä»¿å†™",exp:30}, {name:"é˜…è¯»æ‰“å¡30åˆ†",exp:25}],
        "è‹±è¯­å·©å›º": [{name:"å•è¯é»˜å†™",exp:15}, {name:"è¯¾æ–‡è·Ÿè¯»",exp:10}, {name:"åˆ¶ä½œå•è¯å¡",exp:30}],
        "ä¹ æƒ¯å…»æˆ": [{name:"æ•´ç†ä¹¦åŒ…",exp:20}, {name:"å…‰ç›˜è¡ŒåŠ¨",exp:20}, {name:"åˆ¶å®šæ˜æ—¥è®¡åˆ’",exp:20}],
        "äº’åŠ©è´¡çŒ®": [{name:"æ•™åŒå­¦é¢˜ç›®",exp:50}, {name:"ç­çº§å«ç”Ÿæ‰“æ‰«",exp:15}]
    };
    let TASK_DB = JSON.parse(JSON.stringify(DEFAULT_TASK_DB));

    // å­¦ç”Ÿæ•°æ®ç»“æ„ï¼šæ–°å¢ attempts å­—æ®µ
    let students = [ { id: 1, name: 'å¼ å°æ˜', avatar: 'ğŸ‘¦', tasks: [], lesson: {} }, { id: 2, name: 'æå°èŠ±', avatar: 'ğŸ‘§', tasks: [], lesson: {} }, { id: 3, name: 'ç‹å¤§åŠ›', avatar: 'ğŸ¤ ', tasks: [], lesson: {} } ];
    let specialHistory = ["ç½šæŠ„é”™é¢˜", "æœ—è¯»è¯¾æ–‡", "èƒŒè¯µå¤è¯—", "æ•´ç†é”™é¢˜æœ¬"];
    let currentSubject = 'chinese';
    let selectorType = '', isPublished = false, currentStudentId = null, currentAutoStudentId = null, currentCategory = "åŸºç¡€æ ¸å¿ƒ", isManageMode = false;

    // --- 2. å¤‡è¯¾é€»è¾‘ ---
    function switchSubject(sub, el) { saveCurrentInputs(); currentSubject = sub; document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); renderSubjectView(); }
    function renderSubjectView() {
        const data = SUBJECT_DB[currentSubject];
        renderInputRow('dynamic-input-area', data.inputs, 'inp-prep');
        renderChips('qc-chips-area', data.selected_qc, 'chip-qc');
        renderChips('task-chips-area', data.selected_task, 'chip-task');
    }
    function renderInputRow(cid, obj, pre) {
        document.getElementById(cid).innerHTML = currentSubject==='english' 
            ? `<span class="input-label">Unit</span><input class="inline-input" id="${pre}-unit" value="${obj.unit}"><span class="input-label">Name:</span><input class="inline-input long" id="${pre}-title" value="${obj.title}">`
            : `<span class="input-label">ç¬¬</span><input class="inline-input" id="${pre}-unit" value="${obj.unit}"><span class="input-label">${currentSubject==='math'?'ç« ':'å•å…ƒ'} ç¬¬</span><input class="inline-input" id="${pre}-lesson" value="${obj.lesson}"><span class="input-label">${currentSubject==='math'?'èŠ‚':'è¯¾'} åç§°:</span><input class="inline-input long" id="${pre}-title" value="${obj.title}">`;
    }
    function saveCurrentInputs() {
        const u=document.getElementById('inp-prep-unit'), l=document.getElementById('inp-prep-lesson'), t=document.getElementById('inp-prep-title');
        if(u) SUBJECT_DB[currentSubject].inputs.unit = u.value;
        if(l) SUBJECT_DB[currentSubject].inputs.lesson = l.value;
        if(t) SUBJECT_DB[currentSubject].inputs.title = t.value;
    }
    function renderChips(cid, list, cls) { document.getElementById(cid).innerHTML = list.length ? list.map(i=>`<div class="chip ${cls}">${i}</div>`).join('') : `<div class="chip-empty">æœªé€‰æ‹©</div>`; }

    // é€‰æ‹©å™¨
    function openSelector(type) {
        selectorType = type;
        const data = SUBJECT_DB[currentSubject], list = type==='QC'?data.qc_options:data.task_options, sel = type==='QC'?data.selected_qc:data.selected_task;
        document.getElementById('selector-title').innerText = type==='QC'?'é€‰æ‹©è´¨æ£€é¡¹':'é€‰æ‹©ä»»åŠ¡é¡¹';
        document.getElementById('selector-list-container').innerHTML = list.map(opt => `<div class="selector-item ${sel.includes(opt)?'selected':''}" onclick="toggleSelectOpt(this, '${opt}')"><div class="selector-checkbox">${sel.includes(opt)?'âœ“':''}</div><div style="font-size:14px;">${opt}</div></div>`).join('');
        document.getElementById('selectorDrawer').classList.add('show');
    }
    function closeSelector() { document.getElementById('selectorDrawer').classList.remove('show'); renderSubjectView(); }
    function toggleSelectOpt(el, opt) {
        const sel = selectorType==='QC' ? SUBJECT_DB[currentSubject].selected_qc : SUBJECT_DB[currentSubject].selected_task;
        if(sel.includes(opt)) { sel.splice(sel.indexOf(opt), 1); el.classList.remove('selected'); el.querySelector('.selector-checkbox').innerText=''; }
        else { sel.push(opt); el.classList.add('selected'); el.querySelector('.selector-checkbox').innerText='âœ“'; }
    }
    function addNewItemToSelector() {
        const val = document.getElementById('new-item-input').value.trim();
        if(!val) return;
        const data = SUBJECT_DB[currentSubject];
        (selectorType==='QC'?data.qc_options:data.task_options).push(val);
        (selectorType==='QC'?data.selected_qc:data.selected_task).push(val);
        document.getElementById('new-item-input').value = '';
        openSelector(selectorType);
    }

    // ä¸ªæ€§åŒ–å¼¹çª—
    function showSpecialModal() { document.getElementById('specialModal').classList.add('show'); renderHistoryTags(); }
    function closeModals() { document.querySelectorAll('.drawer-overlay').forEach(d=>d.classList.remove('show')); }
    function renderHistoryTags() {
        const con = document.getElementById('special-history-tags'); con.innerHTML = '';
        specialHistory.forEach((t, i) => {
            const tag = document.createElement('div'); tag.className = 'history-tag'; tag.dataset.task = t;
            tag.onclick = (e) => { if(!e.target.classList.contains('tag-delete')) tag.classList.toggle('selected'); };
            tag.innerHTML = `<span>${t}</span><span class="tag-delete" onclick="delHistory(event, ${i})">âœ•</span>`;
            con.appendChild(tag);
        });
    }
    function delHistory(e, i) { e.stopPropagation(); specialHistory.splice(i, 1); renderHistoryTags(); }
    function confirmAddSpecial() {
        const sts = Array.from(document.querySelectorAll('.st-item.selected')).map(e=>e.innerText);
        const input = document.getElementById('prepInput').value.trim();
        const tags = Array.from(document.querySelectorAll('.history-tag.selected')).map(e=>e.dataset.task);
        let tasks = [...tags]; if(input) { tasks.push(input); if(!specialHistory.includes(input)) specialHistory.unshift(input); }
        if(!sts.length || !tasks.length) return;
        document.getElementById('special-list').innerHTML += `<div class="special-item" data-sts='${JSON.stringify(sts)}' data-tasks='${JSON.stringify(tasks)}'><div class="sp-info"><div class="sp-stu">${sts.join(', ')}</div><div class="sp-task">â• ${tasks.join(' + ')}</div></div><div class="sp-del" onclick="this.parentElement.remove()">âœ•</div></div>`;
        closeModals(); document.querySelectorAll('.st-item').forEach(e=>e.classList.remove('selected')); document.getElementById('prepInput').value = '';
    }

    // å‘å¸ƒ
    function publishPlan() {
        saveCurrentInputs();
        const currLesson = JSON.parse(JSON.stringify(SUBJECT_DB[currentSubject].inputs));
        students.forEach(st => {
            st.lesson = JSON.parse(JSON.stringify(currLesson)); 
            st.tasks = [];
            // åˆå§‹åŒ– tasksï¼Œå¢åŠ  attempts: 0
            SUBJECT_DB[currentSubject].selected_qc.forEach(n => st.tasks.push({name:n, type:'QC', status:'PENDING', exp:20, attempts: 0}));
            SUBJECT_DB[currentSubject].selected_task.forEach(n => st.tasks.push({name:n, type:'TASK', status:'PENDING', exp:10, attempts: 0}));
            document.querySelectorAll('.special-item').forEach(node => {
                const names = JSON.parse(node.dataset.sts);
                if(names.includes(st.name)) JSON.parse(node.dataset.tasks).forEach(t => st.tasks.push({name:t, type:'TASK', status:'PENDING', exp:30, isSpecial:true, attempts: 0}));
            });
        });
        isPublished = true; alert('å‘å¸ƒæˆåŠŸï¼'); switchPage('qc', document.querySelectorAll('.tab-item')[1]);
    }
    function getLessonStr(d) { return currentSubject==='english' ? `Unit ${d.unit} ${d.title}` : `ç¬¬${d.unit}${currentSubject==='math'?'ç« ':'å•å…ƒ'} ç¬¬${d.lesson}${currentSubject==='math'?'èŠ‚':'è¯¾'} ${d.title}`; }

    // --- 3. è´¨æ£€é€»è¾‘ (å‡çº§ï¼šåŠªåŠ›å€¼è®°å½•) ---
    function renderQC() {
        const con = document.getElementById('roster-container'); con.innerHTML = '';
        students.forEach(st => {
            const tot=st.tasks.filter(t=>t.type==='QC').length, done=st.tasks.filter(t=>t.type==='QC'&&t.status==='PASSED').length, pct=tot?(done/tot)*100:0;
            con.innerHTML += `<div class="student-card" onclick="openQCDrawer(${st.id})"><div class="avatar">${st.avatar}</div><div style="font-weight:700;">${st.name}</div><div style="font-size:10px; color:#999; margin-bottom:4px;">${getLessonStr(st.lesson)}</div><div class="progress-bar"><div class="progress-val" style="width:${pct}%; background:${pct===100?'var(--success)':'var(--qc-color)'}"></div></div></div>`;
        });
    }
    function openQCDrawer(sid) {
        currentStudentId = sid;
        const st = students.find(s=>s.id===sid);
        document.getElementById('qc-drawer-name').innerText = st.name;
        document.getElementById('student-current-lesson').innerText = getLessonStr(st.lesson);
        renderQCList();
        document.getElementById('qcDetailDrawer').classList.add('show');
    }
    function closeQcDetail() { document.getElementById('qcDetailDrawer').classList.remove('show'); renderQC(); }
    
    function renderQCList() {
        const st = students.find(s=>s.id===currentStudentId), con = document.getElementById('qc-detail-list'); con.innerHTML = '';
        st.tasks.filter(t=>t.type==='QC').forEach((t, i) => {
            const isPass = t.status==='PASSED';
            // æ˜¾ç¤ºå°è¯•æ¬¡æ•°
            const attemptTag = t.attempts > 0 ? `<span class="attempt-tag">${t.attempts}æ¬¡å°è¯•</span>` : '';
            
            const div = document.createElement('div'); div.className = 'qc-item';
            div.addEventListener('touchstart', (e)=>handleStart(e, i)); div.addEventListener('mousedown', (e)=>handleStart(e, i));
            div.addEventListener('touchend', (e)=>handleEnd(e, i)); div.addEventListener('mouseup', (e)=>handleEnd(e, i));
            
            // å¢åŠ è¾…å¯¼æŒ‰é’®
            div.innerHTML = `
                <div class="btn-retry" onclick="recordAttempt(event, ${i})">âš ï¸ è¾…å¯¼</div>
                <div class="checkbox ${isPass?'checked':''}" onclick="togglePass(${i})">${isPass?'âœ“':''}</div>
                <div style="flex:1; color:${isPass?'#ccc':''}; text-decoration:${isPass?'line-through':''};">
                    ${t.name} ${attemptTag}
                </div>
            `;
            con.appendChild(div);
        });
    }
    
    // æ ¸å¿ƒé€»è¾‘ï¼šè®°å½•è¾…å¯¼/å°è¯•
    function recordAttempt(e, i) {
        e.stopPropagation(); // é˜²æ­¢è§¦å‘ togglePass
        const t = students.find(s=>s.id===currentStudentId).tasks.filter(t=>t.type==='QC')[i];
        if(t.status === 'PASSED') return; // å·²è¿‡çš„ä¸å†è®°å½•
        t.attempts++;
        renderQCList();
        // ç®€å•éœ‡åŠ¨
        if(navigator.vibrate) navigator.vibrate(50);
    }

    // é•¿æŒ‰åˆ é™¤ & ç‚¹å‡»è¿‡å…³
    let lpTimer, isLp = false;
    function handleStart(e, i) { 
        if(e.target.classList.contains('btn-retry') || e.target.classList.contains('checkbox')) return;
        isLp=false; lpTimer=setTimeout(()=>{isLp=true; if(confirm('åˆ é™¤æ­¤é¡¹ï¼Ÿ')){students.find(s=>s.id===currentStudentId).tasks.splice(i,1); renderQCList();}}, 600); 
    }
    function handleEnd(e, i) { clearTimeout(lpTimer); } // æ³¨æ„ï¼šç‚¹å‡»è§¦å‘ç§»åˆ°äº† checkbox onclick ä¸Šï¼Œé˜²æ­¢å†²çª
    
    function togglePass(i) {
        const t = students.find(s=>s.id===currentStudentId).tasks.filter(t=>t.type==='QC')[i];
        t.status = t.status==='PASSED'?'PENDING':'PASSED'; 
        renderQCList();
    }
    
    function passAllQC() {
        students.find(s=>s.id===currentStudentId).tasks.filter(t=>t.type==='QC').forEach(t=>t.status='PASSED');
        renderQCList();
    }

    // è¿›åº¦ä¿®æ”¹
    function openEditLessonModal() { renderInputRow('modal-input-area', students.find(s=>s.id===currentStudentId).lesson, 'inp-mod'); document.getElementById('editLessonModal').classList.add('show'); }
    function confirmEditLesson() {
        const st = students.find(s=>s.id===currentStudentId);
        st.lesson.unit = document.getElementById('inp-mod-unit').value;
        if(currentSubject!=='english') st.lesson.lesson = document.getElementById('inp-mod-lesson').value;
        st.lesson.title = document.getElementById('inp-mod-title').value;
        document.getElementById('student-current-lesson').innerText = getLessonStr(st.lesson);
        document.getElementById('editLessonModal').classList.remove('show');
    }
    function closeEditModal() { document.getElementById('editLessonModal').classList.remove('show'); }

    // --- 4. ç»“ç®—é€»è¾‘ & CMS (å‡çº§ï¼šå±•ç¤ºåŠªåŠ›å€¼) ---
    function renderSettle() {
        const con = document.getElementById('settle-container'); con.innerHTML = ''; let total = 0;
        students.forEach(st => {
            let rows = '';
            st.tasks.forEach(t => {
                const done = (t.type==='QC'&&t.status==='PASSED') || (t.type!=='QC'&&t.status==='COMPLETED');
                if(done) total += t.exp;
                let icon = t.type==='QC' 
                    ? (done ? `<div class="magic-check">âœ“</div>` : `<div class="magic-check" style="background:#fee2e2;color:#ef4444;">âœ•</div>`)
                    : `<div class="checkbox ${done?'checked':''}">${done?'âœ“':''}</div>`;
                let click = t.type==='QC' ? `onclick="alert('è¯·å»è´¨æ£€å°æ“ä½œ')"` : `onclick="toggleTask(${st.id}, '${t.name}')"`;
                
                // åŠªåŠ›æ ‡ç­¾é€»è¾‘
                let effortTag = '';
                if(t.type === 'QC' && t.attempts > 0 && done) {
                    effortTag = `<span class="badge badge-effort">ğŸ”¥ ${t.attempts+1}æ¬¡è¿‡å…³</span>`;
                }

                rows += `<div class="task-row" ${click}>${icon}<div style="flex:1;"><span style="${done?'color:#ccc':''}">${t.isSpecial?'ğŸŒŸ ':''}${t.name}</span>${t.type==='QC'?'<span class="badge badge-qc">è´¨æ£€</span>':''}${t.isAuto?'<span class="badge badge-auto">è‡ªä¸»</span>':''}${effortTag}</div><div style="font-weight:bold; color:#F59E0B; font-size:12px;">+${t.exp}</div></div>`;
            });
            con.innerHTML += `<div class="settle-group"><div class="group-header"><div style="display:flex;align-items:center;gap:8px;">${st.avatar}<b>${st.name}</b></div><div class="btn-add-claim" onclick="openAutoDrawer(${st.id})">+ ä»»åŠ¡</div></div>${rows}</div>`;
        });
        document.getElementById('total-exp').innerText = total;
    }
    function toggleTask(sid, name) { const t=students.find(s=>s.id===sid).tasks.find(x=>x.name===name); t.status = t.status==='COMPLETED'?'PENDING':'COMPLETED'; renderSettle(); }

    function openAutoDrawer(sid) {
        currentAutoStudentId = sid;
        document.getElementById('autoStudentName').innerText = students.find(s=>s.id===sid).name;
        document.getElementById('autoTaskDrawer').classList.add('show');
        renderCats(); selectCat(Object.keys(TASK_DB)[0]);
    }
    function closeAutoDrawer() { document.getElementById('autoTaskDrawer').classList.remove('show'); renderSettle(); }
    function toggleManageMode() { isManageMode = !isManageMode; document.getElementById('btnManage').innerText = isManageMode?"ğŸ’¾ å®Œæˆ":"âš™ï¸ ç®¡ç†åº“"; document.getElementById('btnManage').classList.toggle('active'); renderCats(); renderTaskList(currentCategory); }
    function renderCats() {
        const con = document.getElementById('categoryList'); con.innerHTML = '';
        Object.keys(TASK_DB).forEach(k => {
            const div = document.createElement('div'); div.className = `cat-item ${k===currentCategory?'active':''}`;
            div.innerText = isManageMode ? `âœï¸ ${k}` : k;
            div.onclick = isManageMode ? () => editCat(k) : () => selectCat(k, div);
            con.appendChild(div);
        });
        if(isManageMode) con.innerHTML += `<div class="cat-item" style="color:var(--primary)" onclick="addCat()"><b>+ åˆ†ç±»</b></div>`;
    }
    function selectCat(k, el) { currentCategory = k; if(el) { document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); } renderTaskList(k); }
    function renderTaskList(k) {
        const con = document.getElementById('taskList'); con.innerHTML = '';
        if(isManageMode) con.innerHTML += `<div class="add-new-btn" style="padding:10px; text-align:center; color:var(--primary); font-size:12px; font-weight:bold; background:#f8fafc; border-bottom:1px solid #eee;" onclick="addTaskDB('${k}')">+ æ–°å¢ä»»åŠ¡</div>`;
        (TASK_DB[k]||[]).forEach((t, i) => {
            const div = document.createElement('div'); div.className = 'task-option'; if(isManageMode) div.classList.add('edit-mode-border');
            const btn = isManageMode ? `<div class="delete-icon" onclick="event.stopPropagation();delTaskDB('${k}',${i})">ğŸ—‘ï¸</div>` : `<div class="btn-add-claim" style="padding:4px 8px;">+</div>`;
            div.onclick = isManageMode ? () => editTaskDB(k, i) : () => claimTask(t.name, t.exp);
            div.innerHTML = `<div><div class="t-opt-title">${isManageMode?'âœ ':''}${t.name}</div><div class="t-opt-exp">+${t.exp} EXP</div></div>${btn}`;
            con.appendChild(div);
        });
    }
    function claimTask(n, e) { students.find(s=>s.id===currentAutoStudentId).tasks.push({name:n, type:'TASK', status:'COMPLETED', exp:e, isAuto:true, attempts:0}); closeAutoDrawer(); }
    function addManualTask() { const n=document.getElementById('manualName').value; const e=parseInt(document.getElementById('manualExp').value); if(n) claimTask(n, e); }
    
    // CMS Ops
    function addCat() { const n=prompt("æ–°åˆ†ç±»:"); if(n) { TASK_DB[n]=[]; renderCats(); selectCat(n); } }
    function editCat(o) { if(confirm("åˆ é™¤åˆ†ç±»?")) { delete TASK_DB[o]; renderCats(); selectCat(Object.keys(TASK_DB)[0]); } else { const n=prompt("é‡å‘½å", o); if(n) { TASK_DB[n]=TASK_DB[o]; delete TASK_DB[o]; renderCats(); selectCat(n); } } }
    function addTaskDB(k) { const n=prompt("ä»»åŠ¡å:"); const e=prompt("ç»éªŒå€¼:"); if(n) { TASK_DB[k].unshift({name:n, exp:parseInt(e)||10}); renderTaskList(k); } }
    function editTaskDB(k, i) { const t=TASK_DB[k][i]; const n=prompt("å:", t.name); if(n) { t.name=n; t.exp=parseInt(prompt("EXP:", t.exp)); renderTaskList(k); } }
    function delTaskDB(k, i) { if(confirm("åˆ é™¤?")) { TASK_DB[k].splice(i,1); renderTaskList(k); } }

    // è·¯ç”±
    function switchPage(pid, el) {
        if(!isPublished && pid!=='prep') { alert('è¯·å‘å¸ƒè®¡åˆ’'); return; }
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('page-'+pid).classList.add('active');
        document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
        el.classList.add('active');
        if(pid==='qc') renderQC();
        if(pid==='settle') renderSettle();
    }

    renderSubjectView();
</script>
</body>
</html>
```