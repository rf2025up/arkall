<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StarJourney - é€‚é…Growark UIé£æ ¼æ¼”ç¤º</title>
    <link rel="stylesheet" href="/star-static/css/growark-style.css">
</head>
<body>
    <div class="phone">

        <!-- ==================== PAGE 1: ç»Ÿä¸€å¤‡è¯¾ ==================== -->
        <div id="page-prep" class="page active">
            <div class="header">
                <div class="page-title">ä»Šæ—¥å¤‡è¯¾</div>
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="switchSubject('chinese', this)">è¯­æ–‡</div>
                    <div class="sub-tab" onclick="switchSubject('math', this)">æ•°å­¦</div>
                    <div class="sub-tab" onclick="switchSubject('english', this)">è‹±è¯­</div>
                </div>
            </div>

            <div class="scroll-area">
                <div id="subject-content">
                    <!-- åŠ¨æ€è¿›åº¦è¾“å…¥ -->
                    <div id="dynamic-input-area" class="dynamic-input-row"></div>

                    <!-- è´¨æ£€è¿‡å…³é¡¹ -->
                    <div class="card" style="border-left: 4px solid var(--qc-color);">
                        <div class="section-header">
                            <div class="section-label" style="color:var(--qc-color)">ğŸ›¡ï¸ è´¨æ£€è¿‡å…³é¡¹</div>
                            <div style="font-size:11px; color:#999;">åŒæ­¥è‡³èŠ±åå†Œ</div>
                        </div>
                        <div class="selected-chips-area" id="qc-chips-area"></div>
                        <div class="btn-dropdown" onclick="openSelector('QC')">+ é€‰æ‹© / æ–°å¢è¿‡å…³é¡¹</div>
                    </div>

                    <!-- è¿‡ç¨‹ä»»åŠ¡é¡¹ -->
                    <div class="card" style="border-left: 4px solid var(--task-color);">
                        <div class="section-header">
                            <div class="section-label" style="color:var(--task-color)">ğŸŒ± å­¦ä¹ è¿‡ç¨‹ä»»åŠ¡</div>
                            <div style="font-size:11px; color:#999;">åŒæ­¥è‡³ç»“ç®—é¡µ</div>
                        </div>
                        <div class="selected-chips-area" id="task-chips-area"></div>
                        <div class="btn-dropdown" onclick="openSelector('TASK')">+ é€‰æ‹© / æ–°å¢ä»»åŠ¡</div>
                    </div>
                </div>

                <!-- å…¨å±€ä¸ªæ€§åŒ–åŠ é¤ -->
                <div class="card" style="border: 2px dashed #E2E8F0; margin-top:20px;">
                    <div class="section-header">
                        <div class="section-label">ğŸŒŸ ä¸ªæ€§åŒ–åŠ é¤ (å…¨ç§‘é€šç”¨)</div>
                    </div>
                    <div id="special-list"></div>
                    <button onclick="showSpecialModal()" style="width:100%; padding:10px; background:#F8FAFC; border:1px solid #E2E8F0; color:var(--gray); border-radius:8px; font-size:13px; font-weight:500;">
                        + ä¸ºç‰¹å®šå­¦ç”Ÿæ·»åŠ ä»»åŠ¡ (å¸¦è®°å¿†)
                    </button>
                </div>

                <button class="btn-main" onclick="publishPlan()">ä¸€é”®å‘å¸ƒä»Šæ—¥è®¡åˆ’</button>
            </div>
        </div>

        <!-- ==================== PAGE 2: è´¨æ£€å° ==================== -->
        <div id="page-qc" class="page">
            <div class="header" style="padding-bottom:12px;">
                <div class="page-title">è¿‡å…³è´¨æ£€å°</div>
                <div style="font-size:12px; color:var(--gray); margin-top:4px;">è®°å½•è¾…å¯¼è¿‡ç¨‹ï¼Œä½“ç°æ·±åº¦æœåŠ¡</div>
            </div>
            <div class="scroll-area">
                <div class="roster-grid" id="roster-container"></div>
            </div>
        </div>

        <!-- ==================== PAGE 3: ç»“ç®—å° ==================== -->
        <div id="page-settle" class="page">
            <div class="header" style="padding-bottom:12px; display:flex; justify-content:space-between;">
                <div>
                    <div class="page-title">ä»»åŠ¡ç»“ç®—å°</div>
                    <div style="font-size:12px; color:var(--gray); margin-top:4px;">ç¡®è®¤å®Œæˆ & å‘æ”¾EXP</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:24px; font-weight:800; color:var(--primary);" id="total-exp">0</div>
                    <div style="font-size:10px; color:#999;">TOTAL EXP</div>
                </div>
            </div>
            <div class="scroll-area" id="settle-container"></div>
            <div style="padding:16px; background:white; border-top:1px solid #eee;">
                <button class="btn-main" onclick="alert('ç»“ç®—å®Œæˆï¼')">ç¡®è®¤ä»Šæ—¥ç»“ç®—</button>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="tab-bar">
            <div class="tab-item active" onclick="switchPage('prep', this)">
                <div class="tab-icon">ğŸ“</div>å¤‡è¯¾
            </div>
            <div class="tab-item" onclick="switchPage('qc', this)">
                <div class="tab-icon">ğŸ›¡ï¸</div>è´¨æ£€
            </div>
            <div class="tab-item" onclick="switchPage('settle', this)">
                <div class="tab-icon">ğŸ’°</div>ç»“ç®—
            </div>
        </div>

        <!-- === å¼¹çª—1: å¤‡è¯¾-åŸºç¡€é¡¹é€‰æ‹©å™¨ === -->
        <div class="drawer-overlay" id="selectorDrawer" style="display: none;">
            <div class="drawer-content">
                <div style="font-weight:700; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <span id="selector-title">é€‰æ‹©é¡¹</span>
                    <span onclick="closeSelector()" style="color:#999; font-size:24px; line-height:1; cursor: pointer;">âœ•</span>
                </div>
                <div class="selector-list" id="selector-list-container"></div>
                <div class="add-new-row">
                    <input type="text" id="new-item-input" class="mini-input" placeholder="è¾“å…¥æ²¡åœ¨åˆ—è¡¨é‡Œçš„æ–°é¡¹..." style="flex:1;">
                    <button class="btn-mini" onclick="addNewItemToSelector()">æ·»åŠ </button>
                </div>
                <button class="btn-main" style="margin-top:15px;" onclick="closeSelector()">ç¡®å®š</button>
            </div>
        </div>

        <!-- === å¼¹çª—2: å¤‡è¯¾-ä¸ªæ€§åŒ–åŠ é¤ (è®°å¿†+å¤šé€‰) === -->
        <div class="drawer-overlay" id="specialModal" style="display: none;">
            <div class="drawer-content">
                <div style="font-weight:700; margin-bottom:15px; display:flex; justify-content:space-between;">
                    æ·»åŠ ä¸ªæ€§åŒ–ä»»åŠ¡ <span onclick="closeModals()" style="color:#999; cursor: pointer;">âœ•</span>
                </div>
                <div style="font-size:12px; color:#666; margin-bottom:8px;">1. é€‰æ‹©å­¦ç”Ÿ (å¤šé€‰)</div>
                <div class="st-select-grid" id="student-select-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆå­¦ç”Ÿé€‰æ‹© -->
                </div>
                <div style="font-size:12px; color:#666; margin-bottom:8px;">2. ä»»åŠ¡å†…å®¹ (å†å²æ ‡ç­¾ + æ‰‹åŠ¨è¾“å…¥)</div>
                <div class="history-area"><div id="special-history-tags"></div></div>
                <input type="text" id="prepInput" placeholder="æ‰‹åŠ¨è¾“å…¥æ–°ä»»åŠ¡..." class="mini-input" style="width:100%; margin-bottom:15px;">
                <button class="btn-main" onclick="confirmAddSpecial()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>

        <!-- === æŠ½å±‰3: è´¨æ£€-å­¦ç”Ÿè¯¦æƒ… (å‡çº§ï¼šè¾…å¯¼æ¬¡æ•°è®°å½•) === -->
        <div class="drawer-right" id="qcDetailDrawer" style="display: none;">
            <div class="drawer-panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <span class="page-title" id="qc-drawer-name" style="margin:0; font-size:18px;">å­¦ç”Ÿ</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <button class="btn-pass-all" onclick="passAllQC()">âœ¨ ä¸€é”®è¿‡å…³</button>
                        <span onclick="closeQcDetail()" style="font-size:24px; color:#999; cursor:pointer;">âœ•</span>
                    </div>
                </div>
                <div class="lesson-edit-box">
                    <div>
                        <div style="font-size:10px; color:#94A3B8; margin-bottom:2px;">å½“å‰è¿›åº¦:</div>
                        <div id="student-current-lesson" style="color:#0F172A; font-weight:600; line-height:1.4;">--</div>
                    </div>
                    <div class="lesson-edit-btn" onclick="openEditLessonModal()">âœ ä¿®æ”¹</div>
                </div>
                <div class="section-label" style="margin-bottom:10px; color:var(--qc-color);">éœ€è¿‡å…³é¡¹ç›® (âš ï¸ ç‚¹ä¸€æ¬¡è®°å½•ä¸€æ¬¡åŠªåŠ›)</div>
                <div id="qc-detail-list"></div>
                <div style="font-size:10px; color:#ccc; text-align:center; margin-top:20px;">ğŸ’¡ é•¿æŒ‰ä»»æ„æ¡ç›®å¯åˆ é™¤</div>
            </div>
        </div>

        <!-- === å¼¹çª—4: è´¨æ£€-è¿›åº¦ä¿®æ”¹ === -->
        <div class="drawer-overlay" id="editLessonModal" style="display: none;">
            <div class="drawer-content">
                <div style="font-weight:700; margin-bottom:20px;">ä¿®æ”¹è¯¥ç”Ÿè¿›åº¦</div>
                <div id="modal-input-area" class="dynamic-input-row" style="margin-bottom:30px;"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" style="background:#F1F5F9; color:#64748B;" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button class="btn-main" onclick="confirmEditLesson()">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>

        <!-- === å¼¹çª—5: ç»“ç®—-CMSä»»åŠ¡åº“ (ç®¡ç†+è¡¥å½•) === -->
        <div class="drawer-overlay" id="autoTaskDrawer" style="display: none;">
            <div class="drawer-content-up" style="display: none;">
                <div class="drawer-header">
                    <div>
                        <div style="font-size:16px; font-weight:700;">è‡ªä¸»ä»»åŠ¡ç”³æŠ¥</div>
                        <div style="font-size:12px; color:#64748B;">å­¦ç”Ÿï¼š<span id="autoStudentName" style="color:#4F46E5; font-weight:bold;">--</span></div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="btn-main" style="background:#F1F5F9; color:#64748B; border: 1px solid #E2E8F0;" onclick="toggleManageMode()">âš™ï¸ ç®¡ç†åº“</button>
                        <div onclick="closeAutoDrawer()" style="padding:5px; cursor:pointer; font-size:18px;">âœ•</div>
                    </div>
                </div>
                <div class="manual-entry-area">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="text" id="manualName" class="manual-input" placeholder="âœ¨ æ‰‹åŠ¨è¾“å…¥ç‰¹æ®Šä»»åŠ¡..." style="flex:1;">
                        <div style="display:flex; align-items:center; background:#F1F5F9; border-radius:8px; padding:0 8px;">
                            <span style="font-size:12px; color:#64748B; font-weight:bold;">+</span>
                            <input type="number" id="manualExp" class="manual-input" value="10" style="width:45px; text-align:center; background:transparent; border:none; padding:8px 0;">
                        </div>
                        <button class="btn-main" style="padding:0 16px; height:40px; background: var(--text); color: white; border: none; border-radius:8px; font-size: 13px; font-weight:600;" onclick="addManualTask()">æ·»åŠ </button>
                    </div>
                </div>
                <div class="selector-body">
                    <div class="category-sidebar" id="categoryList"></div>
                    <div class="task-list-area" id="taskList"></div>
                </div>
            </div>
        </div>

    </div>

    <script src="/star-static/js/api.js"></script>
    <script>
        // --- 1. æ•°æ®ä¸­å¿ƒ (StarJourneyåç«¯é›†æˆ) ---
        const SUBJECT_DB = {
            chinese: {
                inputs: { unit: "1", lesson: "2", title: "å¤è¯—äºŒé¦–" },
                qc_options: ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ", "å¤è¯—é»˜å†™", "è¯¾æ–‡ç†è§£"],
                task_options: ["è¯¾æ–‡æœ—è¯»", "ä¹¦å†™è§„èŒƒ", "é˜…è¯»æ‰“å¡"],
                selected_qc: ["ç”Ÿå­—å¬å†™", "è¯¾æ–‡èƒŒè¯µ"],
                selected_task: ["è¯¾æ–‡æœ—è¯»"]
            },
            math: {
                inputs: { unit: "1", lesson: "3", title: "é™¤æ³•è®¡ç®—" },
                qc_options: ["å£ç®—è¾¾æ ‡", "ç«–å¼è®¡ç®—", "å…¬å¼èƒŒè¯µ"],
                task_options: ["è®²é¢˜å°è€å¸ˆ", "åº”ç”¨é¢˜å®¡é¢˜", "é”™é¢˜è®¢æ­£"],
                selected_qc: ["å£ç®—è¾¾æ ‡"],
                selected_task: ["é”™é¢˜è®¢æ­£"]
            },
            english: {
                inputs: { unit: "1", title: "Hello World" },
                qc_options: ["å•è¯é»˜å†™", "å¥å‹èƒŒè¯µ"],
                task_options: ["æƒ…æ™¯å¯¹è¯", "ç»˜æœ¬é˜…è¯»"],
                selected_qc: ["å•è¯é»˜å†™"],
                selected_task: ["æƒ…æ™¯å¯¹è¯"]
            }
        };

        // CMS ä»»åŠ¡åº“
        const DEFAULT_TASK_DB = {
            "åŸºç¡€æ ¸å¿ƒ": [{name:"å®Œæˆæ•°å­¦ä½œä¸š",exp:5}, {name:"å®Œæˆè¯­æ–‡ä½œä¸š",exp:5}, {name:"é”™é¢˜çº¢ç¬”è®¢æ­£",exp:10}, {name:"ä½œä¸šè‡ªä¸»æ£€æŸ¥",exp:10}],
            "æ•°å­¦å·©å›º": [{name:"100é“å£ç®—",exp:10}, {name:"è¯´é¢˜ç»ƒä¹ ",exp:30}, {name:"æ‰¾æ¯é¢˜/å˜å¼",exp:100}],
            "è¯­æ–‡æ‹“å±•": [{name:"å¬å†™ç»ƒä¹ ",exp:10}, {name:"å¥½å¥ä»¿å†™",exp:30}, {name:"é˜…è¯»æ‰“å¡30åˆ†",exp:25}],
            "è‹±è¯­å·©å›º": [{name:"å•è¯é»˜å†™",exp:15}, {name:"è¯¾æ–‡è·Ÿè¯»",exp:10}, {name:"åˆ¶ä½œå•è¯å¡",exp:30}],
            "ä¹ æƒ¯å…»æˆ": [{name:"æ•´ç†ä¹¦åŒ…",exp:20}, {name:"å…‰ç›˜è¡ŒåŠ¨",exp:20}, {name:"åˆ¶å®šæ˜æ—¥è®¡åˆ’",exp:20}],
            "äº’åŠ©è´¡çŒ®": [{name:"æ•™åŒå­¦é¢˜ç›®",exp:50}, {name:"ç­çº§å«ç”Ÿæ‰“æ‰«",exp:15}]
        };
        let TASK_DB = JSON.parse(JSON.stringify(DEFAULT_TASK_DB));

        // ä»StarJourneyåç«¯è·å–å­¦ç”Ÿæ•°æ®
        let students = [];
        let specialHistory = ["ç½šæŠ„é”™é¢˜", "æœ—è¯»è¯¾æ–‡", "èƒŒè¯µå¤è¯—", "æ•´ç†é”™é¢˜æœ¬"];
        let currentSubject = 'chinese';
        let selectorType = '', isPublished = false, currentStudentId = null, currentAutoStudentId = null, currentCategory = "åŸºç¡€æ ¸å¿ƒ", isManageMode = false;

        // --- 2. APIé›†æˆå‡½æ•° ---

        // ä»åç«¯è·å–å­¦ç”Ÿåˆ—è¡¨
        async function loadStudents() {
            try {
                const result = await starAPI.get('/students');
                if (result.success && result.data) {
                    // å°†Growarkå­¦ç”Ÿæ•°æ®è½¬æ¢ä¸ºStarJourneyéœ€è¦çš„æ ¼å¼
                    students = result.data.map(student => ({
                        id: student.id,
                        name: student.name,
                        avatar: student.avatar_url || 'ğŸ‘¤',
                        tasks: [], // å°†ä»lms_student_recordè·å–
                        lesson: {} // å°†ä»è¯¾ç¨‹ä¿¡æ¯è·å–
                    }));

                    // è·å–æ¯ä¸ªå­¦ç”Ÿçš„ä»»åŠ¡è®°å½•
                    await loadStudentRecords();
                    renderQC();
                }
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
                UI.showError('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥');

                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡
                students = [
                    { id: 1, name: 'å¼ å°æ˜', avatar: 'ğŸ‘¦', tasks: [], lesson: {} },
                    { id: 2, name: 'æå°èŠ±', avatar: 'ğŸ‘§', tasks: [], lesson: {} },
                    { id: 3, name: 'ç‹å¤§åŠ›', avatar: 'ğŸ¤ ', tasks: [], lesson: {} }
                ];
                renderQC();
            }
        }

        // è·å–å­¦ç”Ÿçš„è¿‡å…³è®°å½•
        async function loadStudentRecords() {
            for (const student of students) {
                try {
                    const result = await starAPI.getRecords({ student_id: student.id });
                    if (result.success && result.data) {
                        student.tasks = result.data.map(record => ({
                            id: record.id,
                            name: record.task_name,
                            type: record.task_type,
                            status: record.status,
                            exp: record.exp_value,
                            attempts: record.attempt_count || 0,
                            isSpecial: record.is_special,
                            lesson_unit: record.lesson_unit,
                            lesson_lesson: record.lesson_lesson,
                            lesson_title: record.lesson_title,
                            lesson_subject: record.lesson_subject
                        }));
                    }
                } catch (error) {
                    console.error(`åŠ è½½å­¦ç”Ÿ${student.name}çš„è®°å½•å¤±è´¥:`, error);
                }
            }
        }

        // ä¿å­˜ä»»åŠ¡è®°å½•åˆ°åç«¯
        async function saveStudentRecord(studentId, taskData) {
            try {
                const result = await starAPI.post('/records', {
                    ...taskData,
                    student_id: studentId
                });
                return result.success ? result.data : null;
            } catch (error) {
                console.error('ä¿å­˜ä»»åŠ¡è®°å½•å¤±è´¥:', error);
                UI.showError('ä¿å­˜ä»»åŠ¡è®°å½•å¤±è´¥');
                return null;
            }
        }

        // æ‰¹é‡åˆ›å»ºä»»åŠ¡è®°å½•
        async function saveBatchStudentRecords(studentId, tasks) {
            try {
                const records = tasks.map(task => ({
                    ...task,
                    student_id: studentId
                }));

                const result = await starAPI.post('/records/batch', { records });
                return result.success ? result.data : [];
            } catch (error) {
                console.error('æ‰¹é‡ä¿å­˜ä»»åŠ¡è®°å½•å¤±è´¥:', error);
                UI.showError('æ‰¹é‡ä¿å­˜ä»»åŠ¡è®°å½•å¤±è´¥');
                return [];
            }
        }

        // åˆ é™¤ä»»åŠ¡è®°å½•
        async function deleteStudentRecord(recordId) {
            try {
                await starAPI.delete(`/records/${recordId}`);
                return true;
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡è®°å½•å¤±è´¥:', error);
                UI.showError('åˆ é™¤ä»»åŠ¡è®°å½•å¤±è´¥');
                return false;
            }
        }

        // ä¸€é”®é€šè¿‡æ‰€æœ‰QCä»»åŠ¡
        async function passAllQC(studentId) {
            try {
                const result = await starAPI.patch(`/records/student/${studentId}/pass-all`);
                if (result.success) {
                    UI.showSuccess(`ä¸€é”®è¿‡å…³æˆåŠŸï¼${result.message}`);
                    await loadStudentRecords(); // é‡æ–°åŠ è½½è¯¥å­¦ç”Ÿæ•°æ®
                    renderQCList();
                    renderQC();
                }
            } catch (error) {
                console.error('ä¸€é”®è¿‡å…³å¤±è´¥:', error);
                UI.showError('ä¸€é”®è¿‡å…³å¤±è´¥');
            }
        }

        // --- 3. å¤‡è¯¾é€»è¾‘ (ä¸åŸHTMLåŸºæœ¬ä¸€è‡´) ---
        function switchSubject(sub, el) {
            saveCurrentInputs();
            currentSubject = sub;
            document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
            renderSubjectView();
        }

        function renderSubjectView() {
            const data = SUBJECT_DB[currentSubject];
            renderInputRow('dynamic-input-area', data.inputs, 'inp-prep');
            renderChips('qc-chips-area', data.selected_qc, 'chip-qc');
            renderChips('task-chips-area', data.selected_task, 'chip-task');
        }

        function renderInputRow(cid, obj, pre) {
            const container = document.getElementById(cid);
            container.innerHTML = currentSubject==='english'
                ? `<span class="input-label">Unit</span><input class="inline-input" id="${pre}-unit" value="${obj.unit}"><span class="input-label">Name:</span><input class="inline-input long" id="${pre}-title" value="${obj.title}">`
                : `<span class="input-label">ç¬¬</span><input class="inline-input" id="${pre}-unit" value="${obj.unit}"><span class="input-label">${currentSubject==='math'?'ç« ':'å•å…ƒ'} ç¬¬</span><input class="inline-input" id="${pre}-lesson" value="${obj.lesson}"><span class="input-label">${currentSubject==='math'?'èŠ‚':'è¯¾'} åç§°:</span><input class="inline-input long" id="${pre}-title" value="${obj.title}">`;
        }

        function saveCurrentInputs() {
            const u=document.getElementById('inp-prep-unit'), l=document.getElementById('inp-prep-lesson'), t=document.getElementById('inp-prep-title');
            if(u) SUBJECT_DB[currentSubject].inputs.unit = u.value;
            if(l) SUBJECT_DB[currentSubject].inputs.lesson = l.value;
            if(t) SUBJECT_DB[currentSubject].inputs.title = t.value;
        }

        function renderChips(cid, list, cls) {
            document.getElementById(cid).innerHTML = list.length ?
                list.map(i=>`<div class="chip ${cls}">${i}</div>`).join('') :
                `<div class="chip-empty">æœªé€‰æ‹©</div>`;
        }

        // é€‰æ‹©å™¨
        function openSelector(type) {
            selectorType = type;
            const data = SUBJECT_DB[currentSubject],
                  list = type==='QC' ? data.qc_options : data.task_options,
                  sel = type==='QC' ? data.selected_qc : data.selected_task;

            document.getElementById('selector-title').innerText = type==='QC' ? 'é€‰æ‹©è´¨æ£€é¡¹' : 'é€‰æ‹©ä»»åŠ¡é¡¹';
            document.getElementById('selector-list-container').innerHTML = list.map(opt =>
                `<div class="selector-item ${sel.includes(opt) ? 'selected' : ''}" onclick="toggleSelectOpt(this, '${opt}')">
                    <div class="selector-checkbox">${sel.includes(opt) ? 'âœ“' : ''}</div>
                    <div style="font-size:14px;">${opt}</div>
                </div>`).join('');

            document.getElementById('selectorDrawer').style.display = 'flex';
        }

        function closeSelector() {
            document.getElementById('selectorDrawer').style.display = 'none';
            renderSubjectView();
        }

        function toggleSelectOpt(el, opt) {
            const sel = selectorType==='QC' ? SUBJECT_DB[currentSubject].selected_qc : SUBJECT_DB[currentSubject].selected_task;
            if(sel.includes(opt)) {
                sel.splice(sel.indexOf(opt), 1);
                el.classList.remove('selected');
                el.querySelector('.selector-checkbox').innerText='';
            } else {
                sel.push(opt);
                el.classList.add('selected');
                el.querySelector('.selector-checkbox').innerText='âœ“';
            }
        }

        function addNewItemToSelector() {
            const val = document.getElementById('new-item-input').value.trim();
            if(!val) return;
            const data = SUBJECT_DB[currentSubject];
            (selectorType==='QC'?data.qc_options:data.task_options).push(val);
            (selectorType==='QC'?data.selected_qc:data.selected_task).push(val);
            document.getElementById('new-item-input').value = '';
            openSelector(selectorType);
        }

        // ä¸ªæ€§åŒ–å¼¹çª—
        function showSpecialModal() {
            document.getElementById('specialModal').style.display = 'flex';
            renderHistoryTags();
        }

        function closeModals() {
            document.querySelectorAll('.drawer-overlay').forEach(d=>d.style.display='none');
        }

        function renderHistoryTags() {
            const con = document.getElementById('special-history-tags');
            con.innerHTML = '';
            specialHistory.forEach((t, i) => {
                const tag = document.createElement('div');
                tag.className = 'history-tag';
                tag.dataset.task = t;
                tag.onclick = (e) => {
                    if(!e.target.classList.contains('tag-delete')) tag.classList.toggle('selected');
                };
                tag.innerHTML = `<span>${t}</span><span class="tag-delete" onclick="delHistory(event, ${i})">âœ•</span>`;
                con.appendChild(tag);
            });
        }

        function delHistory(e, i) {
            e.stopPropagation();
            specialHistory.splice(i, 1);
            renderHistoryTags();
        }

        function confirmAddSpecial() {
            const sts = Array.from(document.querySelectorAll('.st-item.selected')).map(e=>e.innerText);
            const input = document.getElementById('prepInput').value.trim();
            const tags = Array.from(document.querySelectorAll('.history-tag.selected')).map(e=>e.dataset.task);
            let tasks = [...tags];
            if(input) {
                tasks.push(input);
                if(!specialHistory.includes(input)) specialHistory.unshift(input);
            }

            if(!sts.length || !tasks.length) return;

            // åˆ›å»ºç‰¹æ®Šä»»åŠ¡è®°å½•åˆ°åç«¯
            const studentIds = sts.map(studentName => {
                const student = students.find(s => s.name === studentName);
                return student ? student.id : null;
            }).filter(id => id !== null);

            if (studentIds.length === 0) {
                UI.showError('è¯·é€‰æ‹©æœ‰æ•ˆå­¦ç”Ÿ');
                return;
            }

            const specialTasks = tasks.map(taskName => ({
                task_name: taskName,
                task_type: 'TASK',
                exp_value: 30,
                is_special: true
            }));

            // ä¸ºæ¯ä¸ªé€‰ä¸­çš„å­¦ç”Ÿåˆ›å»ºç‰¹æ®Šä»»åŠ¡
            for (const studentId of studentIds) {
                saveBatchStudentRecords(studentId, specialTasks);
            }

            document.getElementById('special-list').innerHTML += `<div class="special-item" data-sts='${JSON.stringify(sts)}' data-tasks='${JSON.stringify(tasks)}'><div class="sp-info"><div class="sp-stu">${sts.join(', ')}</div><div class="sp-task">â• ${tasks.join(' + ')}</div></div><div class="sp-del" onclick="this.parentElement.remove()">âœ•</div></div>`;

            closeModals();
            document.querySelectorAll('.st-item').forEach(e=>e.classList.remove('selected'));
            document.getElementById('prepInput').value = '';
            UI.showSuccess('ä¸ªæ€§åŒ–ä»»åŠ¡æ·»åŠ æˆåŠŸï¼');
        }

        // å‘å¸ƒ
        async function publishPlan() {
            saveCurrentInputs();

            // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºä»»åŠ¡è®°å½•
            for (const student of students) {
                const tasks = [];

                // QCä»»åŠ¡
                SUBJECT_DB[currentSubject].selected_qc.forEach(name => {
                    tasks.push({
                        name,
                        task_type: 'QC',
                        exp_value: 20,
                        lesson_unit: SUBJECT_DB[currentSubject].inputs.unit,
                        lesson_lesson: SUBJECT_DB[currentSubject].inputs.lesson || null,
                        lesson_title: SUBJECT_DB[currentSubject].inputs.title,
                        lesson_subject: currentSubject
                    });
                });

                // TASKä»»åŠ¡
                SUBJECT_DB[currentSubject].selected_task.forEach(name => {
                    tasks.push({
                        name,
                        task_type: 'TASK',
                        exp_value: 10,
                        lesson_unit: SUBJECT_DB[currentSubject].inputs.unit,
                        lesson_lesson: SUBJECT_DB[currentSubject].inputs.lesson || null,
                        lesson_title: SUBJECT_DB[currentSubject].inputs.title,
                        lesson_subject: currentSubject
                    });
                });

                // ä¸ªæ€§åŒ–ä»»åŠ¡
                const specialItems = document.querySelectorAll('.special-item');
                specialItems.forEach(item => {
                    const studentNames = JSON.parse(item.dataset.sts);
                    const specialTasks = JSON.parse(item.dataset.tasks);

                    if (studentNames.includes(student.name)) {
                        specialTasks.forEach(task => {
                            tasks.push({
                                ...task,
                                task_type: 'TASK',
                                exp_value: 30,
                                is_special: true,
                                lesson_unit: SUBJECT_DB[currentSubject].inputs.unit,
                                lesson_lesson: SUBJECT_DB[currentSubject].inputs.lesson || null,
                                lesson_title: SUBJECT_DB[currentSubject].inputs.title,
                                lesson_subject: currentSubject
                            });
                        });
                    }
                });

                // æ‰¹é‡ä¿å­˜ä»»åŠ¡
                await saveBatchStudentRecords(student.id, tasks);
            }

            isPublished = true;
            UI.showSuccess('å‘å¸ƒæˆåŠŸï¼');
            switchPage('qc', document.querySelectorAll('.tab-item')[1]);
        }

        function getLessonStr(d) {
            return currentSubject==='english'
                ? `Unit ${d.unit} ${d.title}`
                : `ç¬¬${d.unit}${currentSubject==='math'?'ç« ':'å•å…ƒ'} ç¬¬${d.lesson}${currentSubject==='math'?'èŠ‚':'è¯¾'} ${d.title}`;
        }

        // --- 4. è´¨æ£€é€»è¾‘ (é€‚é…Growark UI) ---
        function renderQC() {
            const con = document.getElementById('roster-container');
            con.innerHTML = '';

            students.forEach(st => {
                const tot = st.tasks.filter(t=>t.type==='QC').length,
                      done = st.tasks.filter(t=>t.type==='QC'&&t.status==='passed').length,
                      pct = tot ? (done/tot)*100 : 0;

                con.innerHTML += `
                    <div class="student-card" onclick="openQCDrawer(${st.id})">
                        <div class="avatar">${st.avatar}</div>
                        <div style="font-weight:700;">${st.name}</div>
                        <div style="font-size:10px; color:#999; margin-bottom:4px;">${getLessonStr(st.lesson)}</div>
                        <div class="progress-bar">
                            <div class="progress-val" style="width:${pct}%; background:${pct===100?'var(--success)':'var(--qc-color)'}"></div>
                        </div>
                    </div>
                `;
            });
        }

        function openQCDrawer(studentId) {
            currentStudentId = studentId;
            const st = students.find(s=>s.id===studentId);

            if (!st) {
                UI.showError('å­¦ç”Ÿä¸å­˜åœ¨');
                return;
            }

            document.getElementById('qc-drawer-name').innerText = st.name;
            document.getElementById('student-current-lesson').innerText = getLessonStr(st.lesson);
            renderQCList();
            document.getElementById('qcDetailDrawer').style.display = 'flex';
        }

        function closeQCDetail() {
            document.getElementById('qcDetailDrawer').style.display = 'none';
            renderQC();
        }

        function renderQCList() {
            const st = students.find(s=>s.id===currentStudentId),
                  con = document.getElementById('qc-detail-list');
            if (!st) {
                con.innerHTML = '<div class="loading"><div class="loading-spinner"></div>åŠ è½½ä¸­...</div>';
                return;
            }

            const qcTasks = st.tasks.filter(t=>t.type==='QC');
            con.innerHTML = '';

            if (qcTasks.length === 0) {
                con.innerHTML = '<div style="text-align: center; color: #9CA3AF; padding: 20px;">æš‚æ— QCä»»åŠ¡</div>';
                return;
            }

            qcTasks.forEach((task, index) => {
                const isPass = task.status === 'passed';
                const attemptTag = task.attempts > 0 ? `<span class="attempt-tag">${task.attempts}æ¬¡å°è¯•</span>` : '';
                const highAttempts = task.attempts > 2 ? 'attempt-tag high' : '';

                const div = document.createElement('div');
                div.className = 'qc-item';

                // é•¿æŒ‰åˆ é™¤åŠŸèƒ½
                let lpTimer = null, isLp = false;

                div.addEventListener('touchstart', (e) => {
                    if(e.target.classList.contains('btn-retry') || e.target.classList.contains('checkbox')) return;
                    isLp = false;
                    lpTimer = setTimeout(() => {
                        isLp = true;
                        if (confirm(`ç¡®å®šè¦åˆ é™¤"${task.name}"å—ï¼Ÿ`)) {
                            deleteStudentRecord(task.id).then(() => {
                                UI.showSuccess('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
                                // é‡æ–°åŠ è½½å­¦ç”Ÿæ•°æ®
                                loadStudents();
                            });
                        }
                    }, 600);
                });

                div.addEventListener('touchend', (e) => {
                    clearTimeout(lpTimer);
                    if (!isLp && !e.target.classList.contains('btn-retry') && !e.target.classList.contains('checkbox')) {
                        togglePass(index);
                    }
                });

                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤"${task.name}"å—ï¼Ÿ`)) {
                        deleteStudentRecord(task.id).then(() => {
                            UI.showSuccess('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
                            loadStudents();
                        });
                    }
                });

                div.innerHTML = `
                    <div class="btn-retry" onclick="recordAttempt(${index})" title="è®°å½•ä¸€æ¬¡è¾…å¯¼å°è¯•">
                        âš ï¸ è¾…å¯¼
                        ${attemptTag}
                    </div>
                    <div class="checkbox ${isPass ? 'checked' : ''}" onclick="togglePass(${index})" title="${isPass ? 'æ ‡è®°ä¸ºæœªé€šè¿‡' : 'æ ‡è®°ä¸ºé€šè¿‡'}">
                        ${isPass ? 'âœ“' : ''}
                    </div>
                    <div style="flex:1; color:${isPass?'#ccc':''}; text-decoration:${isPass?'line-through':''};">
                        ${task.name}
                        ${attemptTag}
                    </div>
                `;

                con.appendChild(div);
            });
        }

        // æ ¸å¿ƒé€»è¾‘ï¼šè®°å½•è¾…å¯¼/å°è¯• (é›†æˆStarJourney API)
        async function recordAttempt(index) {
            const st = students.find(s=>s.id===currentStudentId);
            if (!st) return;

            const task = st.tasks.filter(t=>t.type==='QC')[index];
            if (task.status === 'passed') {
                UI.showInfo('ä»»åŠ¡å·²é€šè¿‡ï¼Œæ— éœ€è®°å½•å°è¯•');
                return;
            }

            try {
                const result = await starAPI.recordAttempt(task.id);
                if (result.success) {
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    task.attempts = result.data.attempt_count;
                    UI.showSuccess(`è¾…å¯¼å°è¯•è®°å½•æˆåŠŸï¼å½“å‰å°è¯•æ¬¡æ•°ï¼š${task.attempts}`);
                    renderQCList();

                    // æ·»åŠ è§¦è§‰åé¦ˆ
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            } catch (error) {
                console.error('è®°å½•è¾…å¯¼å°è¯•å¤±è´¥:', error);
                UI.showError('è®°å½•è¾…å¯¼å°è¯•å¤±è´¥');
            }
        }

        function togglePass(index) {
            const st = students.find(s=>s.id===currentStudentId);
            if (!st) return;

            const task = st.tasks.filter(t=>t.type==='QC')[index];
            const newStatus = task.status === 'passed' ? 'pending' : 'passed';

            try {
                const result = newStatus === 'passed' ?
                    await starAPI.markAsPassed(task.id) :
                    null;

                if (result || newStatus === 'pending') {
                    task.status = newStatus;
                    UI.showSuccess(`ä»»åŠ¡${newStatus === 'passed' ? 'é€šè¿‡' : 'é‡æ–°å¼€å¯'}æˆåŠŸï¼`);
                    renderQCList();
                }
            } catch (error) {
                console.error('åˆ‡æ¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                UI.showError('åˆ‡æ¢ä»»åŠ¡çŠ¶æ€å¤±è´¥');
            }
        }

        // è¿›åº¦ä¿®æ”¹
        function openEditLessonModal() {
            const st = students.find(s=>s.id===currentStudentId);
            if (st) {
                renderInputRow('modal-input-area', st.lesson, 'inp-mod');
                document.getElementById('editLessonModal').style.display = 'flex';
            }
        }

        async function confirmEditLesson() {
            const st = students.find(s=>s.id===currentStudentId);
            if (!st) return;

            const lessonData = {
                unit: document.getElementById('inp-mod-unit').value,
                lesson: document.getElementById('inp-mod-lesson').value,
                title: document.getElementById('inp-mod-title').value
            };

            // æ›´æ–°å­¦ç”Ÿçš„lessonä¿¡æ¯
            st.lesson = lessonData;

            try {
                // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæ›´æ–°å­¦ç”Ÿè¿›åº¦ä¿¡æ¯
                document.getElementById('student-current-lesson').innerText = getLessonStr(lessonData);
                document.getElementById('editLessonModal').style.display = 'none';
                UI.showSuccess('è¿›åº¦ä¿®æ”¹æˆåŠŸï¼');
            } catch (error) {
                UI.showError('è¿›åº¦ä¿®æ”¹å¤±è´¥');
            }
        }

        function closeEditModal() {
            document.getElementById('editLessonModal').style.display = 'none';
        }

        // --- 5. ç»“ç®—é€»è¾‘ & CMS (é€‚é…Growark UI) ---
        function renderSettle() {
            const con = document.getElementById('settle-container');
            con.innerHTML = '';
            let total = 0;

            students.forEach(st => {
                let rows = '';
                st.tasks.forEach(task => {
                    const done = (task.type==='QC'&&task.status==='passed') || (task.type!=='QC'&&task.status==='completed');
                    if(done) total += task.exp;

                    let icon = task.type==='QC'
                        ? (done ? `<div class="magic-check">âœ“</div>` : `<div class="magic-check" style="background:#fee2e2;color:#ef4444;">âœ•</div>`)
                        : `<div class="checkbox ${done?'checked':''}">${done?'âœ“':''}</div>`;

                    let click = task.type==='QC'
                        ? `onclick="UI.showInfo('è¯·å»è´¨æ£€å°æ“ä½œ')"`
                        : `onclick="toggleTask(${st.id}, '${task.name}')"`;

                    // åŠªåŠ›æ ‡ç­¾é€»è¾‘
                    let effortTag = '';
                    if(task.type === 'QC' && task.attempts > 0 && done) {
                        effortTag = `<span class="badge badge-effort">ğŸ”¥ ${task.attempts+1}æ¬¡è¿‡å…³</span>`;
                    }

                    rows += `
                        <div class="task-row" ${click}>
                            ${icon}
                            <div style="flex:1;">
                                <span style="${done?'color:#ccc':''}">${task.isSpecial?'ğŸŒŸ ': ''}${task.name}</span>
                                ${task.type==='QC'?'<span class="badge badge-qc">è´¨æ£€</span>':''}
                                ${task.isSpecial?'<span class="badge badge-special">åŠ é¤</span>':''}
                                ${effortTag}
                            </div>
                            <div style="font-weight:bold; color:#F59E0B; font-size:12px;">+${task.exp}</div>
                        </div>
                    `;
                });

                con.innerHTML += `
                    <div class="settle-group">
                        <div class="group-header">
                            <div style="display:flex;align-items:center;gap:8px;">${st.avatar}<b>${st.name}</b></div>
                            <div class="btn-add-claim" onclick="openAutoDrawer(${st.id})">+ ä»»åŠ¡</div>
                        </div>
                        ${rows}
                    </div>
                `;
            });

            document.getElementById('total-exp').innerText = total;
        }

        function toggleTask(studentId, taskName) {
            const st = students.find(s=>s.id===studentId);
            if (st) {
                const task = st.tasks.find(x=>x.name===taskName);
                if (task) {
                    task.status = task.status==='completed'?'pending':'completed';
                    renderSettle();
                }
            }
        }

        // --- 6. CMSå¼¹çª— ---
        function openAutoDrawer(studentId) {
            currentAutoStudentId = studentId;
            const student = students.find(s=>s.id===studentId);

            if (student) {
                document.getElementById('autoStudentName').innerText = student.name;
                renderCats();
                selectCat(Object.keys(TASK_DB)[0]);
                document.getElementById('autoTaskDrawer').style.display = 'flex';
            }
        }

        function closeAutoDrawer() {
            document.getElementById('autoTaskDrawer').style.display = 'none';
            renderSettle();
        }

        function toggleManageMode() {
            isManageMode = !isManageMode;
            const btn = document.getElementById('btnManage');
            btn.innerText = isManageMode ? "ğŸ’¾ å®Œæˆ" : "âš™ï¸ ç®¡ç†åº“";
            btn.classList.toggle('active');
            renderCats();
            renderTaskList(currentCategory);
        }

        function renderCats() {
            const con = document.getElementById('categoryList');
            con.innerHTML = '';

            Object.keys(TASK_DB).forEach(k => {
                const div = document.createElement('div');
                div.className = `cat-item ${k===currentCategory?'active':''}`;
                div.innerText = isManageMode ? `âœï¸ ${k}` : k;
                div.onclick = isManageMode ? () => editCat(k) : () => selectCat(k, div);
                con.appendChild(div);
            });

            if(isManageMode) {
                con.innerHTML += `<div class="cat-item" style="color:var(--primary)" onclick="addCat()"><b>+ åˆ†ç±»</b></div>`;
            }
        }

        function selectCat(k, el) {
            currentCategory = k;
            if(el) {
                document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active'));
                el.classList.add('active');
            }
            renderTaskList(k);
        }

        function renderTaskList(k) {
            const con = document.getElementById('taskList');
            con.innerHTML = '';

            if(isManageMode) {
                con.innerHTML += `<div class="add-new-btn" style="padding:10px; text-align:center; color:var(--primary); font-size:12px; font-weight:bold; background:#f8fafc; border-bottom:1px solid #eee;" onclick="addTaskDB('${k}')">+ æ–°å¢ä»»åŠ¡</div>`;
            }

            (TASK_DB[k]||[]).forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'task-option';
                if(isManageMode) div.classList.add('edit-mode-border');

                const btn = isManageMode ?
                    `<div class="delete-icon" onclick="event.stopPropagation();delTaskDB('${k}',${i})">ğŸ—‘ï¸</div>` :
                    `<div class="btn-add-claim" style="padding:4px 8px;">+</div>`;

                div.onclick = isManageMode ? () => editTaskDB(k, i) : () => claimTask(t.name, t.exp);

                div.innerHTML = `
                    <div>
                        <div class="t-opt-title">${isManageMode?'âœ ': ''}${t.name}</div>
                        <div class="t-opt-exp">+${t.exp} EXP</div>
                    </div>
                    ${btn}
                `;
                con.appendChild(div);
            });
        }

        function claimTask(name, exp) {
            const student = students.find(s=>s.id===currentAutoStudentId);
            if (student) {
                const taskData = {
                    name: name,
                    task_type: 'TASK',
                    status: 'completed',
                    exp_value: exp,
                    is_auto: true,
                    lesson_unit: SUBJECT_DB[currentSubject].inputs.unit,
                    lesson_lesson: SUBJECT_DB[currentSubject].inputs.lesson || null,
                    lesson_title: SUBJECT_DB[currentSubject].inputs.title,
                    lesson_subject: currentSubject
                };

                saveStudentRecord(student.id, taskData).then(() => {
                    closeAutoDrawer();
                });
            }
        }

        function addManualTask() {
            const name = document.getElementById('manualName').value;
            const exp = parseInt(document.getElementById('manualExp').value) || 10;
            if(name) {
                claimTask(name, exp);
                document.getElementById('manualName').value = '';
            }
        }

        // CMS Operations
        function addCat() {
            const n = prompt("æ–°åˆ†ç±»:");
            if(n) {
                TASK_DB[n]=[];
                renderCats();
                selectCat(n);
            }
        }

        function editCat(o) {
            if(confirm("åˆ é™¤åˆ†ç±»?")) {
                delete TASK_DB[o];
                renderCats();
                selectCat(Object.keys(TASK_DB)[0]);
            } else {
                const n = prompt("é‡å‘½å", o);
                if(n) {
                    TASK_DB[n]=TASK_DB[o];
                    delete TASK_DB[o];
                    renderCats();
                    selectCat(n);
                }
            }
        }

        function addTaskDB(k) {
            const n = prompt("ä»»åŠ¡å:");
            const e = prompt("ç»éªŒå€¼:");
            if(n) {
                TASK_DB[k].unshift({name:n, exp:parseInt(e)||10});
                renderTaskList(k);
            }
        }

        function editTaskDB(k, i) {
            const t=TASK_DB[k][i];
            const n=prompt("å:", t.name);
            if(n) {
                t.name=n;
                t.exp=parseInt(prompt("EXP:", t.exp));
                renderTaskList(k);
            }
        }

        function delTaskDB(k, i) {
            if(confirm("åˆ é™¤?")) {
                TASK_DB[k].splice(i, 1);
                renderTaskList(k);
            }
        }

        // --- è·¯ç”± ---
        function switchPage(pid, el) {
            if(!isPublished && pid!=='prep') {
                UI.showInfo('è¯·å…ˆå‘å¸ƒè®¡åˆ’');
                return;
            }

            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById('page-'+pid).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');

            if(pid==='qc') renderQC();
            if(pid==='settle') renderSettle();
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async function() {
            // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('onclick').match(/switchSubject\('([^']+)'\)/)[1];
                    if (tabName) {
                        switchSubject(tabName, this);
                    }
                });
            });

            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('record-form')?.addEventListener('submit', handleRecordSubmit);
            document.getElementById('mistake-form')?.addEventListener('submit', handleMistakeSubmit);

            // ç»‘åˆ¶åº•éƒ¨å¯¼èˆªäº‹ä»¶
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    const pageId = this.getAttribute('onclick').match(/switchPage\('([^']+)'\)/)[1];
                    if (pageId) {
                        switchPage(pageId, this);
                    }
                });
            });

            // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
            checkServerStatus();

            // åŠ è½½å­¦ç”Ÿæ•°æ®
            await loadStudents();

            // æ¸²æŸ“åˆå§‹è§†å›¾
            renderSubjectView();

            // ç”Ÿæˆå­¦ç”Ÿé€‰æ‹©ç½‘æ ¼
            renderStudentSelectGrid();
        });

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            const statusElement = document.getElementById('server-status');
            if (!statusElement) return;

            try {
                const health = await starAPI.healthCheck();
                if (health.success) {
                    statusElement.textContent = 'âœ… StarJourneyæœåŠ¡å™¨è¿è¡Œæ­£å¸¸';
                } else {
                    statusElement.textContent = 'âŒ æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸';
                }
            } catch (error) {
                statusElement.textContent = 'âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
            }
        }

        // è·å–å­¦ç”Ÿé€‰æ‹©ç½‘æ ¼
        async function renderStudentSelectGrid() {
            const grid = document.getElementById('student-select-grid');
            if (!grid) return;

            try {
                const result = await starAPI.get('/students');
                if (result.success && result.data) {
                    grid.innerHTML = result.data.map(student =>
                        `<div class="st-item" data-student-id="${student.id}">${student.name}</div>`
                    ).join('');

                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    grid.querySelectorAll('.st-item').forEach(item => {
                        item.addEventListener('click', function() {
                            this.classList.toggle('selected');
                        });
                    });
                }
            } catch (error) {
                grid.innerHTML = `
                    <div class="st-item">å¼ å°æ˜</div>
                    <div class="st-item">æå°èŠ±</div>
                    <div class="st-item">ç‹å¤§åŠ›</div>
                `;
                }
            }
        }

        // å¤„ç†è¿‡å…³è®°å½•è¡¨å•æäº¤
        async function handleRecordSubmit(event) {
            event.preventDefault();

            const formData = {
                student_id: parseInt(document.getElementById('record-student-id').value),
                task_name: document.getElementById('record-task-name').value,
                task_type: document.getElementById('record-task-type').value,
                exp_value: parseInt(document.getElementById('record-exp-value').value) || 10,
                lesson_subject: document.getElementById('record-subject').value,
                lesson_unit: document.getElementById('record-unit').value ? parseInt(document.getElementById('record-unit').value) : null,
                lesson_lesson: document.getElementById('record-lesson').value ? parseInt(document.getElementById('record-lesson').value) : null,
                lesson_title: document.getElementById('record-title').value,
                is_special: document.getElementById('record-special').value === 'true'
            };

            try {
                const result = await starAPI.createRecord(formData);
                UI.showSuccess(`è¿‡å…³è®°å½•åˆ›å»ºæˆåŠŸï¼ä»»åŠ¡ï¼š${formData.task_name}`);
                document.getElementById('record-form').reset();
                document.getElementById('record-student-id').value = '28';
                document.getElementById('record-exp-value').value = '10';

                // é‡æ–°åŠ è½½æ•°æ®
                await loadStudentRecords();
                renderQC();
                loadOverview();
            } catch (error) {
                UI.showError(`åˆ›å»ºå¤±è´¥ï¼š${error.message}`);
            }
        }

        // å¤„ç†é”™é¢˜è®°å½•è¡¨å•æäº¤
        async function handleMistakeSubmit(event) {
            event.preventDefault();

            const tagsText = document.getElementById('mistake-tags').value;
            const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()) : [];

            const formData = {
                student_id: parseInt(document.getElementById('mistake-student-id').value),
                ocr_text: document.getElementById('mistake-text').value,
                subject: document.getElementById('mistake-subject').value,
                tags: tags,
                difficulty_level: parseInt(document.getElementById('mistake-difficulty').value)
            };

            try {
                const result = await starAPI.createMistake(formData);
                UI.showSuccess(`é”™é¢˜è®°å½•åˆ›å»ºæˆåŠŸï¼${formData.subject}ç§‘ç›®`);
                document.getElementById('mistake-form').reset();
                document.getElementById('mistake-student-id').value = '28';
                document.getElementById('mistake-difficulty').value = '1';

                // é‡æ–°åŠ è½½æ•°æ®
                loadMistakes();
                loadOverview();
            } catch (error) {
                UI.showError(`åˆ›å»ºå¤±è´¥ï¼š${error.message}`);
            }
        }

        // åŠ è½½é”™é¢˜è®°å½•
        async function loadMistakes() {
            const container = document.getElementById('mistakes-list') || document.getElementById('mistakes-list');
            if (!container) return;

            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>æ­£åœ¨åŠ è½½é”™é¢˜...</div>';

            try {
                const result = await starAPI.getMistakes();
                const mistakes = result.data || [];

                if (mistakes.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æš‚æ— é”™é¢˜è®°å½•</p>';
                    return;
                }

                const html = mistakes.map(mistake => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div>
                                <span class="list-item-title">${mistake.ocr_text ? mistake.ocr_text.substring(0, 50) + '...' : 'æ— æ–‡æœ¬'}</span>
                                ${UI.getStatusBadge(mistake.status)}
                                <span class="status-badge status-pending">${mistake.subject}</span>
                            </div>
                            <button class="btn btn-danger" onclick="deleteMistake('${mistake.id}')">åˆ é™¤</button>
                        </div>
                        <div class="list-item-meta">
                            <span>ğŸ‘¤ ${mistake.student_name || 'æœªçŸ¥'}</span>
                            <span>ğŸ“Š éš¾åº¦${mistake.difficulty_level}çº§</span>
                            <span>ğŸ•’ ${UI.formatDate(mistake.created_at)}</span>
                        </div>
                        ${mistake.tags && mistake.tags.length > 0 ? `
                            <div style="margin-top: 8px;">
                                ${mistake.tags.map(tag => `<span style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px;">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½é”™é¢˜è®°å½•å¤±è´¥:', error);
                container.innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</p>';
            }
        }

        // åˆ é™¤é”™é¢˜è®°å½•
        async function deleteMistake(mistakeId) {
            UI.confirm('ç¡®å®šè¦åˆ é™¤æ­¤é”™é¢˜è®°å½•å—ï¼Ÿ', async () => {
                try {
                    await starAPI.deleteMistake(mistakeId);
                    UI.showSuccess('é”™é¢˜åˆ é™¤æˆåŠŸ');
                    loadMistakes();
                    loadOverview();
                } catch (error) {
                    UI.showError(`åˆ é™¤å¤±è´¥ï¼š${error.message}`);
                }
            });
        }

        // åˆ é™¤ä»»åŠ¡è®°å½•
        async function deleteStudentRecord(recordId) {
            UI.confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡è®°å½•å—ï¼Ÿ', async () => {
                try {
                    await starAPI.deleteRecord(recordId);
                    UI.showSuccess('ä»»åŠ¡è®°å½•åˆ é™¤æˆåŠŸ');
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadStudents();
                } catch (error) {
                    UI.showError(`åˆ é™¤å¤±è´¥ï¼š${error.message}`);
                }
            });
        }

        // åŠ è½½æ€»è§ˆæ•°æ®
        async function loadOverview() {
            try {
                const records = await starAPI.getRecords();
                const mistakes = await starAPI.getMistakes();

                const totalRecords = records.data ? records.data.length : 0;
                const passedRecords = records.data ? records.data.filter(r => r.status === 'passed').length : 0;
                const totalAttempts = records.data ? records.data.reduce((sum, r) => sum + (r.attempt_count || 0), 0) : 0;
                const totalMistakes = mistakes.data ? mistakes.data.length : 0;

                document.getElementById('total-records').textContent = totalRecords;
                document.getElementById('passed-records').textContent = passedRecords;
                document.getElementById('total-attempts').textContent = totalAttempts;
                document.getElementById('total-mistakes').textContent = totalMistakes;
            } catch (error) {
                console.error('åŠ è½½æ€»è§ˆæ•°æ®å¤±è´¥:', error);
                document.getElementById('total-records').textContent = '0';
                document.getElementById('passed-records').textContent = '0';
                document.getElementById('total-attempts').textContent = '0';
                document.getElementById('total-mistakes').textContent = '0';
            }
        }
    </script>
</body>
</html>