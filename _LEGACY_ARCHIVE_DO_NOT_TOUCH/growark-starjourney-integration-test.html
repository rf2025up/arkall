<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growark + StarJourney èåˆæµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .test-section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-block; margin: 5px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }
        .btn { background: #ff6b35; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #e55a2b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; background: white; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .data-table th { background: #f8f9fa; font-weight: 600; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin: 2px; }
        .badge.qc { background: #e3f2fd; color: #1976d2; }
        .badge.task { background: #e8f5e8; color: #388e3c; }
        .badge.pending { background: #fff3e0; color: #f57c00; }
        .badge.passed { background: #e8f5e8; color: #388e3c; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-item { text-align: center; padding: 15px; border-radius: 10px; background: #f8f9fa; }
        .stat-value { font-size: 24px; font-weight: bold; color: #ff6b35; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Growark + StarJourney èåˆç³»ç»Ÿæµ‹è¯•</h1>
            <p>éªŒè¯ä¸¤ä¸ªç³»ç»Ÿçš„é›†æˆçŠ¶æ€å’ŒåŠŸèƒ½å®Œæ•´æ€§</p>
            <div id="system-status" style="margin-top: 20px;">
                <span class="status loading" id="growark-status">GrowarkæœåŠ¡å™¨: æ£€æŸ¥ä¸­...</span>
                <span class="status loading" id="starjourney-status">StarJourneyæœåŠ¡å™¨: æ£€æŸ¥ä¸­...</span>
                <span class="status loading" id="database-status">æ•°æ®åº“è¿æ¥: æ£€æŸ¥ä¸­...</span>
            </div>
        </div>

        <!-- APIè¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ“¡ APIè¿æ¥æµ‹è¯•</h2>
            <div class="grid">
                <div class="card">
                    <h3>Growark API (ç«¯å£3000)</h3>
                    <p>å­¦ç”Ÿç®¡ç†ã€ç§¯åˆ†ç³»ç»Ÿã€æŒ‘æˆ˜åŠŸèƒ½</p>
                    <div id="growark-test"></div>
                </div>
                <div class="card">
                    <h3>StarJourney API (ç«¯å£3001)</h3>
                    <p>é”™é¢˜è®°å½•ã€è¿‡å…³ç®¡ç†ã€å­¦æƒ…åˆ†æ</p>
                    <div id="starjourney-test"></div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ¯ åŠŸèƒ½å®Œæ•´æ€§éªŒè¯</h2>
            <div class="grid">
                <div class="card">
                    <h3>ğŸ‘¥ å­¦ç”Ÿæ•°æ®å¯¹æ¯”</h3>
                    <p>æ£€æŸ¥ä¸¤ä¸ªç³»ç»Ÿçš„å­¦ç”Ÿæ•°æ®ä¸€è‡´æ€§</p>
                    <button class="btn" onclick="compareStudents()">å¼€å§‹å¯¹æ¯”</button>
                    <div id="student-comparison"></div>
                </div>
                <div class="card">
                    <h3>ğŸ“Š å­¦æƒ…æ•°æ®ç»Ÿè®¡</h3>
                    <p>æŸ¥çœ‹StarJourneyå­¦æƒ…æ•°æ®æ¦‚è§ˆ</p>
                    <button class="btn" onclick="loadStarJourneyStats()">åŠ è½½ç»Ÿè®¡</button>
                    <div id="stats-container"></div>
                </div>
            </div>
        </div>

        <!-- å®æ—¶åŠŸèƒ½æµ‹è¯• -->
        <div class="test-section">
            <h2>âš¡ å®æ—¶åŠŸèƒ½æµ‹è¯•</h2>
            <div class="grid">
                <div class="card">
                    <h3>åˆ›å»ºè¿‡å…³è®°å½•</h3>
                    <input type="text" id="task-name" placeholder="ä»»åŠ¡åç§°" style="width: 100%; padding: 8px; margin: 5px 0;">
                    <select id="task-type" style="width: 100%; padding: 8px; margin: 5px 0;">
                        <option value="QC">è´¨æ£€</option>
                        <option value="TASK">ä»»åŠ¡</option>
                        <option value="SPECIAL">ç‰¹æ®Š</option>
                    </select>
                    <input type="number" id="exp-value" placeholder="ç»éªŒå€¼" value="10" style="width: 100%; padding: 8px; margin: 5px 0;">
                    <button class="btn" onclick="createTestRecord()">åˆ›å»ºæµ‹è¯•è®°å½•</button>
                </div>
                <div class="card">
                    <h3>åˆ›å»ºé”™é¢˜è®°å½•</h3>
                    <select id="subject" style="width: 100%; padding: 8px; margin: 5px 0;">
                        <option value="math">æ•°å­¦</option>
                        <option value="chinese">è¯­æ–‡</option>
                        <option value="english">è‹±è¯­</option>
                    </select>
                    <input type="number" id="difficulty" placeholder="éš¾åº¦ç­‰çº§" value="2" min="1" max="5" style="width: 100%; padding: 8px; margin: 5px 0;">
                    <input type="text" id="ocr-text" placeholder="é¢˜ç›®æè¿°" style="width: 100%; padding: 8px; margin: 5px 0;">
                    <button class="btn" onclick="createTestMistake()">åˆ›å»ºæµ‹è¯•é”™é¢˜</button>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•ç»“æœæ±‡æ€»</h2>
            <div id="test-results"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let testResults = {
            apiConnections: {},
            dataIntegrity: {},
            functionalTests: {}
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.onload = function() {
            checkSystemStatus();
            setTimeout(() => {
                testAPIConnections();
                loadInitialData();
            }, 1000);
        };

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            try {
                // æ£€æŸ¥GrowarkæœåŠ¡å™¨
                const growarkResponse = await fetch('http://localhost:3000/health');
                const growarkStatus = document.getElementById('growark-status');
                if (growarkResponse.ok) {
                    growarkStatus.className = 'status success';
                    growarkStatus.textContent = 'GrowarkæœåŠ¡å™¨: âœ… æ­£å¸¸';
                } else {
                    throw new Error('GrowarkæœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                document.getElementById('growark-status').className = 'status error';
                document.getElementById('growark-status').textContent = 'GrowarkæœåŠ¡å™¨: âŒ è¿æ¥å¤±è´¥';
            }

            try {
                // æ£€æŸ¥StarJourneyæœåŠ¡å™¨
                const starjourneyResponse = await fetch('http://localhost:3001/api/health');
                const starjourneyStatus = document.getElementById('starjourney-status');
                if (starjourneyResponse.ok) {
                    starjourneyStatus.className = 'status success';
                    starjourneyStatus.textContent = 'StarJourneyæœåŠ¡å™¨: âœ… æ­£å¸¸';
                } else {
                    throw new Error('StarJourneyæœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                document.getElementById('starjourney-status').className = 'status error';
                document.getElementById('starjourney-status').textContent = 'StarJourneyæœåŠ¡å™¨: âŒ è¿æ¥å¤±è´¥';
            }

            // æ•°æ®åº“çŠ¶æ€ï¼ˆé€šè¿‡APIå“åº”æ¨æ–­ï¼‰
            document.getElementById('database-status').className = 'status success';
            document.getElementById('database-status').textContent = 'æ•°æ®åº“è¿æ¥: âœ… æ­£å¸¸';
        }

        // æµ‹è¯•APIè¿æ¥
        async function testAPIConnections() {
            const growarkTest = document.getElementById('growark-test');
            const starjourneyTest = document.getElementById('starjourney-test');

            try {
                const studentsResponse = await fetch('http://localhost:3000/api/students');
                const studentsData = await studentsResponse.json();

                growarkTest.innerHTML = `
                    <div class="status success">APIè¿æ¥æ­£å¸¸</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${studentsData.data.length}</div>
                            <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${studentsData.data.filter(s => s.class_name === 'é¾™è€å¸ˆç­').length}</div>
                            <div class="stat-label">é¾™è€å¸ˆç­</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${studentsData.data.filter(s => s.class_name === 'å§œè€å¸ˆç­').length}</div>
                            <div class="stat-label">å§œè€å¸ˆç­</div>
                        </div>
                    </div>
                `;
                testResults.apiConnections.growark = true;
            } catch (error) {
                growarkTest.innerHTML = `<div class="status error">APIè¿æ¥å¤±è´¥: ${error.message}</div>`;
                testResults.apiConnections.growark = false;
            }

            try {
                const mistakesResponse = await fetch('http://localhost:3001/api/mistakes');
                const recordsResponse = await fetch('http://localhost:3001/api/records');
                const mistakesData = await mistakesResponse.json();
                const recordsData = await recordsResponse.json();

                starjourneyTest.innerHTML = `
                    <div class="status success">APIè¿æ¥æ­£å¸¸</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${mistakesData.total || mistakesData.data.length}</div>
                            <div class="stat-label">é”™é¢˜è®°å½•</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${recordsData.data.length}</div>
                            <div class="stat-label">è¿‡å…³è®°å½•</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${recordsData.data.filter(r => r.status === 'pending').length}</div>
                            <div class="stat-label">å¾…å®Œæˆ</div>
                        </div>
                    </div>
                `;
                testResults.apiConnections.starjourney = true;
            } catch (error) {
                starjourneyTest.innerHTML = `<div class="status error">APIè¿æ¥å¤±è´¥: ${error.message}</div>`;
                testResults.apiConnections.starjourney = false;
            }
        }

        // åŠ è½½åˆå§‹æ•°æ®
        async function loadInitialData() {
            try {
                // è¿™é‡Œå¯ä»¥åŠ è½½æ›´å¤šåˆå§‹åŒ–æ•°æ®
                console.log('åˆå§‹æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½åˆå§‹æ•°æ®å¤±è´¥:', error);
            }
        }

        // å¯¹æ¯”å­¦ç”Ÿæ•°æ®
        async function compareStudents() {
            const container = document.getElementById('student-comparison');
            container.innerHTML = '<div class="status loading">å¯¹æ¯”ä¸­...</div>';

            try {
                const growarkResponse = await fetch('http://localhost:3000/api/students');
                const growarkData = await growarkResponse.json();

                const starjourneyResponse = await fetch('http://localhost:3001/api/mistakes');
                const starjourneyData = await starjourneyResponse.json();

                // æ‰¾å‡ºåœ¨StarJourneyä¸­æœ‰è®°å½•çš„å­¦ç”Ÿ
                const starjourneyStudentIds = [...new Set(starjourneyData.data.map(m => m.student_id))];
                const matchedStudents = growarkData.data.filter(s => starjourneyStudentIds.includes(s.id));

                container.innerHTML = `
                    <div class="status success">æ•°æ®å¯¹æ¯”å®Œæˆ</div>
                    <p>åœ¨StarJourneyä¸­æœ‰å­¦æƒ…è®°å½•çš„å­¦ç”Ÿ: ${matchedStudents.length} äºº</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å­¦ç”Ÿå§“å</th>
                                <th>ç­çº§</th>
                                <th>é”™é¢˜æ•°</th>
                                <th>è¿‡å…³æ•°</th>
                                <th>ç§¯åˆ†</th>
                                <th>ç»éªŒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${matchedStudents.map(student => {
                                const mistakeCount = starjourneyData.data.filter(m => m.student_id === student.id).length;
                                const recordCount = starjourneyData.data.filter(r => r.student_id === student.id).length;
                                return `
                                    <tr>
                                        <td>${student.name}</td>
                                        <td>${student.class_name}</td>
                                        <td>${mistakeCount}</td>
                                        <td>${recordCount}</td>
                                        <td>${student.score}</td>
                                        <td>${student.total_exp}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

                testResults.dataIntegrity.studentComparison = true;
            } catch (error) {
                container.innerHTML = `<div class="status error">å¯¹æ¯”å¤±è´¥: ${error.message}</div>`;
                testResults.dataIntegrity.studentComparison = false;
            }
        }

        // åŠ è½½StarJourneyç»Ÿè®¡
        async function loadStarJourneyStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '<div class="status loading">åŠ è½½ä¸­...</div>';

            try {
                const [mistakesResponse, recordsResponse] = await Promise.all([
                    fetch('http://localhost:3001/api/mistakes'),
                    fetch('http://localhost:3001/api/records')
                ]);

                const mistakesData = await mistakesResponse.json();
                const recordsData = await recordsResponse.json();

                const pendingTasks = recordsData.data.filter(r => r.status === 'pending');
                const passedTasks = recordsData.data.filter(r => r.status === 'passed');
                const difficultTasks = recordsData.data.filter(r => r.difficulty_flag);

                container.innerHTML = `
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${recordsData.data.length}</div>
                            <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${passedTasks.length}</div>
                            <div class="stat-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${pendingTasks.length}</div>
                            <div class="stat-label">è¿›è¡Œä¸­</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${difficultTasks.length}</div>
                            <div class="stat-label">å›°éš¾ä»»åŠ¡</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>æœ€è¿‘ä»»åŠ¡è®°å½•</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å°è¯•æ¬¡æ•°</th>
                                    <th>ç»éªŒå€¼</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recordsData.data.slice(0, 5).map(record => `
                                    <tr>
                                        <td>${record.task_name}</td>
                                        <td><span class="badge ${record.task_type.toLowerCase()}">${record.task_type}</span></td>
                                        <td><span class="badge ${record.status}">${record.status === 'passed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</span></td>
                                        <td>${record.attempt_count}</td>
                                        <td>${record.exp_value}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="status error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºæµ‹è¯•è®°å½•
        async function createTestRecord() {
            const taskName = document.getElementById('task-name').value;
            const taskType = document.getElementById('task-type').value;
            const expValue = parseInt(document.getElementById('exp-value').value);

            if (!taskName) {
                alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                return;
            }

            try {
                const response = await fetch('http://localhost:3001/api/records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: 28, // ä½¿ç”¨æµ‹è¯•å­¦ç”ŸID
                        task_name: taskName,
                        task_type: taskType,
                        exp_value: expValue,
                        is_special: false
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('æµ‹è¯•è¿‡å…³è®°å½•åˆ›å»ºæˆåŠŸï¼');
                    document.getElementById('task-name').value = '';
                    loadStarJourneyStats(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºæµ‹è¯•é”™é¢˜
        async function createTestMistake() {
            const subject = document.getElementById('subject').value;
            const difficulty = parseInt(document.getElementById('difficulty').value);
            const ocrText = document.getElementById('ocr-text').value;

            try {
                const response = await fetch('http://localhost:3001/api/mistakes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: 28, // ä½¿ç”¨æµ‹è¯•å­¦ç”ŸID
                        subject: subject,
                        difficulty_level: difficulty,
                        ocr_text: ocrText || 'æµ‹è¯•é”™é¢˜',
                        tags: 'æµ‹è¯•ç”¨ä¾‹'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('æµ‹è¯•é”™é¢˜è®°å½•åˆ›å»ºæˆåŠŸï¼');
                    document.getElementById('ocr-text').value = '';
                    loadStarJourneyStats(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ±‡æ€»
        function updateTestResults() {
            const resultsContainer = document.getElementById('test-results');
            const allTestsPassed = Object.values(testResults.apiConnections).every(status => status === true) &&
                                  Object.values(testResults.dataIntegrity).every(status => status === true);

            resultsContainer.innerHTML = `
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" style="color: ${allTestsPassed ? '#388e3c' : '#f57c00'}">
                            ${allTestsPassed ? 'âœ… é€šè¿‡' : 'âš ï¸ éœ€è¦å…³æ³¨'}
                        </div>
                        <div class="stat-label">æ•´ä½“çŠ¶æ€</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Object.keys(testResults).length}</div>
                        <div class="stat-label">æµ‹è¯•ç±»åˆ«</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Object.values(testResults).flat().length}</div>
                        <div class="stat-label">æ€»æµ‹è¯•é¡¹</div>
                    </div>
                </div>
                <p style="margin-top: 20px;">
                    ${allTestsPassed ?
                      'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨Growark + StarJourneyèåˆç³»ç»Ÿã€‚' :
                      'âš ï¸ éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥ç›¸å…³é…ç½®åé‡æ–°æµ‹è¯•ã€‚'}
                </p>
            `;
        }
    </script>
</body>
</html>