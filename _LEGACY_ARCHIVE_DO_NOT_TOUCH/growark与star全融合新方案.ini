growark与star全融合新方案

我将严格遵循你的要求：
1.  **架构**：保留 Growark 原有架构，通过 Sidecar 模式挂载 StarJourney。
2.  **功能**：完整复刻你提供的 HTML 原型（备课、质检、结算、CMS任务库）。
3.  **新增**：集成你要求的“学业Tab”、“过关地图”和“错题分拣”。

---

# 📘 Growark x StarJourney (v12.0) 完整技术融合方案

## 第一部分：总体架构与数据库设计

### 1.1 系统架构 (Sidecar Pattern)
*   **前端**：React Mobile (在 Growark 现有项目中新增 `modules/academic`)。
*   **后端 A (主)**：Node.js (现有) - 负责用户认证、班级管理、实时大屏。
*   **后端 B (辅)**：Python FastAPI (新增) - 负责备课数据流、过关逻辑、错题AI分析、PDF生成。
*   **数据库**：PostgreSQL (共享)。

### 1.2 数据库 Schema (SQL)
请在 Sealos 数据库中执行。表名统一加 `lms_` 前缀，与 Growark 原表隔离但关联。

```sql
-- 1. 任务元数据库 (CMS，对应 HTML 中的 TASK_DB)
CREATE TABLE lms_task_library (
    id SERIAL PRIMARY KEY,
    category VARCHAR(50), -- '基础核心', '数学巩固'...
    name VARCHAR(100),
    default_exp INTEGER,
    tenant_id INTEGER DEFAULT 0 -- 预留多校区
);

-- 2. 每日教学计划 (对应 HTML Page 1)
CREATE TABLE lms_daily_plans (
    id SERIAL PRIMARY KEY,
    teacher_id INTEGER, -- 关联用户
    date DATE DEFAULT CURRENT_DATE,
    subject VARCHAR(20), -- 'chinese', 'math', 'english'
    -- 存储单元、课时信息 {unit: "1", lesson: "2", title: "..."}
    lesson_info JSONB,
    -- 存储选中的配置 {qc: ["背诵"], task: ["作业"]}
    config_snapshot JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. 学生每日记录 (核心表，对应 HTML Page 2 & 3)
CREATE TABLE lms_student_records (
    id SERIAL PRIMARY KEY,
    student_id INTEGER NOT NULL, -- 关联 Growark students(id)
    plan_id INTEGER REFERENCES lms_daily_plans(id),
    
    task_name VARCHAR(128),
    task_type VARCHAR(20), -- 'QC'(质检), 'TASK'(任务)
    status VARCHAR(20) DEFAULT 'PENDING', -- 'PENDING', 'PASSED', 'COMPLETED'
    
    -- 努力值：对应 HTML 中的 recordAttempt 逻辑
    attempt_count INTEGER DEFAULT 0,
    
    -- 结算状态：防止重复加分
    is_settled BOOLEAN DEFAULT FALSE,
    exp_value INTEGER,
    
    date DATE DEFAULT CURRENT_DATE
);

-- 4. 错题元数据 (图片只存一份)
CREATE TABLE lms_mistake_meta (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    image_url TEXT,
    ocr_text TEXT,
    ai_analysis JSONB, -- 包含知识点、出题人揭秘
    created_at TIMESTAMP DEFAULT NOW()
);

-- 5. 学生错题关联 (分拣结果)
CREATE TABLE lms_student_mistakes (
    id SERIAL PRIMARY KEY,
    student_id INTEGER NOT NULL,
    mistake_meta_id UUID REFERENCES lms_mistake_meta(id),
    status VARCHAR(20) DEFAULT 'pending', -- pending, mastered
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 第二部分：前端代码实施 (React)

### 2.1 目录结构重构
我们将原有 HTML 的功能完整封装到 `modules/academic` 中。

```text
src/
├── components/
│   └── BottomNav.tsx       # 修改导航栏
├── pages/
│   ├── StudentProfile.tsx  # 新版双核档案页
│   └── MistakeSorter.tsx   # 错题分拣台
├── modules/
│   └── academic/           # HTML 移植核心区
│       ├── AcademicContext.tsx  # 全局状态管理
│       ├── views/
│       │   ├── PrepView.tsx     # 备课页 (HTML Page 1)
│       │   ├── QCView.tsx       # 质检页 (HTML Page 2)
│       │   ├── SettleView.tsx   # 结算页 (HTML Page 3)
│       │   └── QCMapModal.tsx   # 过关地图 (新增的需求)
│       └── components/
│           ├── SelectorDrawer.tsx
│           ├── CMSDrawer.tsx
│           └── StudentQCList.tsx
```

### 2.2 核心组件代码

#### A. 全局导航配置 (`components/BottomNav.tsx`)
实现 C 位拍照与 5 Tab 布局。

```tsx
import { useNavigate, useLocation } from 'react-router-dom';

export default function BottomNav() {
  const navigate = useNavigate();
  const loc = useLocation();
  const isActive = (p) => loc.pathname === p;

  return (
    <div className="fixed bottom-0 w-full bg-white border-t h-16 flex items-end justify-around pb-2 z-40">
      <NavBtn icon="home" label="班级" active={isActive('/')} onClick={() => navigate('/')} />
      <NavBtn icon="edit" label="备课" active={isActive('/prep')} onClick={() => navigate('/prep')} />
      
      {/* C位拍照 */}
      <div className="relative -top-6">
        <button onClick={() => navigate('/camera')} className="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center shadow-lg shadow-orange-200 text-white text-2xl">
          <i className="fa-solid fa-camera"></i>
        </button>
      </div>

      <NavBtn icon="shield-check" label="质检" active={isActive('/qc')} onClick={() => navigate('/qc')} />
      <NavBtn icon="user" label="我的" active={isActive('/profile')} onClick={() => navigate('/profile')} />
    </div>
  );
}

const NavBtn = ({ icon, label, active, onClick }) => (
  <button onClick={onClick} className={`flex-1 flex flex-col items-center gap-1 ${active ? 'text-orange-500' : 'text-gray-400'}`}>
    <i className={`fa-solid fa-${icon} text-xl`}></i>
    <span className="text-[10px] font-medium">{label}</span>
  </button>
);
```

#### B. 备课页移植 (`modules/academic/views/PrepView.tsx`)
**完全保留 HTML Page 1 的逻辑**：学科切换、动态输入框、胶囊标签、选择器。

```tsx
import React, { useState } from 'react';
import { useAcademic } from '../AcademicContext'; // 存放 SUBJECT_DB
import SelectorDrawer from '../components/SelectorDrawer';

export default function PrepView() {
  const { subjectDB, currentSubject, switchSubject, publishPlan } = useAcademic();
  const data = subjectDB[currentSubject];
  const [showSelector, setShowSelector] = useState(null); // 'QC' or 'TASK'

  return (
    <div className="flex flex-col h-full bg-gray-50">
      {/* 顶部学科切换 */}
      <div className="bg-white p-4 pt-12 border-b">
        <h1 className="text-2xl font-extrabold text-gray-800 mb-4">今日备课</h1>
        <div className="flex bg-gray-100 p-1 rounded-lg">
          {['chinese', 'math', 'english'].map(sub => (
            <button 
              key={sub}
              className={`flex-1 py-2 rounded-md font-bold text-sm transition-all ${currentSubject===sub ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}
              onClick={() => switchSubject(sub)}
            >
              {sub === 'chinese' ? '语文' : sub === 'math' ? '数学' : '英语'}
            </button>
          ))}
        </div>
      </div>

      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {/* 动态输入行 (移植 HTML 逻辑) */}
        <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-2">
          <span className="text-gray-500 font-bold">第</span>
          <input 
            className="w-10 text-center border-b-2 border-dashed border-gray-300 font-bold text-lg text-primary focus:border-orange-500 outline-none"
            value={data.inputs.unit}
            onChange={(e) => data.inputs.unit = e.target.value} // 需配合 Context 更新
          />
          <span className="text-gray-500 font-bold">单元</span>
          {/* ...其余输入框... */}
        </div>

        {/* 质检项卡片 */}
        <div className="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm">
          <div className="flex justify-between mb-3">
            <h3 className="font-bold text-red-500">🛡️ 质检过关项</h3>
          </div>
          <div className="flex flex-wrap gap-2 mb-3">
            {data.selected_qc.map(item => (
              <span key={item} className="bg-red-50 text-red-600 px-3 py-1 rounded-lg text-sm border border-red-100">{item}</span>
            ))}
          </div>
          <button onClick={() => setShowSelector('QC')} className="w-full py-2 border border-dashed border-gray-300 rounded-lg text-gray-400 text-sm">
            + 选择 / 新增
          </button>
        </div>

        <div className="h-10"></div>
        <button onClick={publishPlan} className="w-full bg-gray-900 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition">
          一键发布今日计划
        </button>
      </div>

      {/* 选择器抽屉 */}
      <SelectorDrawer 
        isOpen={!!showSelector} 
        type={showSelector} 
        options={showSelector === 'QC' ? data.qc_options : data.task_options}
        onClose={() => setShowSelector(null)} 
      />
    </div>
  );
}
```

#### C. 质检页移植 (`modules/academic/views/QCView.tsx`)
**完全保留 HTML Page 2 的逻辑**：学生进度条、辅导点击(+1)、过关点击。

```tsx
import React, { useEffect, useState } from 'react';
import { pythonApi } from '../../../api/client';

export default function QCView() {
  const [students, setStudents] = useState([]);

  // 加载数据：从 lms_student_records 获取今日数据
  const loadData = async () => {
    const res = await pythonApi.get('/qc/today'); 
    setStudents(res.data);
  };

  useEffect(() => { loadData(); }, []);

  // 核心交互：记录辅导
  const handleAttempt = async (recordId, currentCount) => {
    // 1. 乐观更新 UI
    setStudents(prev => prev.map(s => {
       // ...找到对应 record 更新 attempt_count + 1
       return s;
    }));
    // 2. 调用后端
    await pythonApi.patch(`/records/${recordId}/attempt`);
  };

  // 核心交互：过关
  const handlePass = async (recordId) => {
    await pythonApi.patch(`/records/${recordId}/pass`);
    // 触发全局积分刷新
    loadData();
  };

  return (
    <div className="flex flex-col h-full bg-gray-50">
      <div className="bg-white p-4 pt-12 border-b">
        <h1 className="text-xl font-extrabold text-gray-800">过关质检台</h1>
        <p className="text-xs text-gray-400">点击“辅导”记录努力值</p>
      </div>

      <div className="grid grid-cols-3 gap-3 p-4 overflow-y-auto">
        {students.map(stu => (
          <div key={stu.id} className="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center active:scale-95 transition" onClick={() => openDetailDrawer(stu)}>
            <img src={stu.avatar} className="w-10 h-10 rounded-full bg-gray-100 mb-2" />
            <div className="font-bold text-sm">{stu.name}</div>
            {/* 进度条 */}
            <div className="w-full h-1.5 bg-gray-100 rounded-full mt-2 overflow-hidden">
              <div 
                className={`h-full ${stu.progress===100 ? 'bg-green-500' : 'bg-red-500'}`} 
                style={{width: `${stu.progress}%`}}
              ></div>
            </div>
          </div>
        ))}
      </div>
      
      {/* 这里应该引入 QCDetailDrawer 组件 */}
    </div>
  );
}
```

#### D. 学生双核档案页 (`pages/StudentProfile.tsx`)
这是融合了 **Growark 成长** 和 **StarJourney 学业** 的核心页面。包含你要求的**过关地图**。

```tsx
import { Tab } from '@headlessui/react';
import QCMapModal from '../modules/academic/views/QCMapModal'; // 新增的过关地图组件

export default function StudentProfile({ student }) {
  const [showMap, setShowMap] = useState(false);

  return (
    <div className="bg-gray-50 min-h-screen">
      {/* 头部 (原有) */}
      <Header student={student} />

      <Tab.Group>
        <Tab.List className="flex bg-white border-b sticky top-0 z-10">
          <Tab className="flex-1 py-3 text-sm font-bold ui-selected:text-orange-500 ui-selected:border-b-2 border-orange-500">🚀 成长激励</Tab>
          <Tab className="flex-1 py-3 text-sm font-bold ui-selected:text-purple-600 ui-selected:border-b-2 border-purple-600">📚 学业攻克</Tab>
        </Tab.List>

        <Tab.Panels>
          {/* Tab 1: 原 Growark 功能 */}
          <Tab.Panel>
             <GrowthView student={student} />
          </Tab.Panel>

          {/* Tab 2: StarJourney 新功能 */}
          <Tab.Panel className="p-4 space-y-4">
            
            {/* 1. 学情雷达 (Dashboard) */}
            <div className="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4">
               {/* 插入 Chart.js 雷达图 */}
               <div className="flex-1">
                 <div className="text-xs text-purple-600 font-bold bg-purple-50 inline-block px-2 py-1 rounded mb-2">AI 诊断</div>
                 <p className="text-xs text-gray-600">"本周计算能力稳步提升，但在应用题审题上还需加强。"</p>
               </div>
            </div>

            {/* 2. 错题本入口 */}
            <div className="grid grid-cols-2 gap-3">
               <button className="bg-purple-600 text-white p-4 rounded-xl font-bold flex flex-col items-center">
                 <i className="fa-solid fa-camera text-2xl mb-1"></i>
                 录入错题
               </button>
               <button className="bg-white text-purple-600 border border-purple-100 p-4 rounded-xl font-bold flex flex-col items-center">
                 <i className="fa-solid fa-print text-2xl mb-1"></i>
                 生成攻克单
               </button>
            </div>

            {/* 3. 过关全记录入口 (你的需求) */}
            <div className="bg-white p-4 rounded-xl border border-gray-100" onClick={() => setShowMap(true)}>
               <div className="flex justify-between items-center mb-2">
                 <h3 className="font-bold text-gray-800">全学期过关地图</h3>
                 <i className="fa-solid fa-chevron-right text-gray-300"></i>
               </div>
               {/* 简易进度条 */}
               <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                 <div className="bg-green-500 h-full w-[85%]"></div>
               </div>
               <div className="text-xs text-gray-400 mt-1 text-right">已完成 85%</div>
            </div>

          </Tab.Panel>
        </Tab.Panels>
      </Tab.Group>

      {/* 过关地图弹窗 (复用我之前设计的 Timeline HTML) */}
      {showMap && <QCMapModal studentId={student.id} onClose={() => setShowMap(false)} />}
    </div>
  );
}
```

---

## 第三部分：后端 API 实现 (Python FastAPI)

在 `services/qc_service.py` 中实现关键逻辑。

### 3.1 获取学生全学期过关地图 (`QCMapModal` 的数据源)

```python
@router.get("/qc/map/{student_id}")
async def get_student_qc_map(student_id: int):
    """
    返回结构：按课程聚合的任务列表
    [
      {
        "lesson_title": "第3单元 第2课",
        "status": "pending", // 有未完成的
        "tasks": [
           {"name": "背诵", "status": "PASSED", "attempt_count": 1},
           {"name": "默写", "status": "PENDING", "attempt_count": 3}
        ]
      },
      ...
    ]
    """
    # 1. 查出该学生所有 QC 记录，关联 Plan 表获取课程信息
    sql = """
        SELECT r.*, p.lesson_info 
        FROM lms_student_records r
        JOIN lms_daily_plans p ON r.plan_id = p.id
        WHERE r.student_id = :sid AND r.task_type = 'QC'
        ORDER BY p.date DESC
    """
    records = await db.fetch_all(sql, {"sid": student_id})
    
    # 2. Python 聚合逻辑 (GroupBy Lesson)
    # ...
    return aggregated_data
```

### 3.2 错题分拣与归档 (Mistake Hub)

```python
@router.post("/mistakes/distribute")
async def distribute_mistake(
    image_url: str, 
    ocr_text: str, 
    student_ids: List[int]
):
    # 1. 存元数据
    meta_id = await db.execute(...)
    
    # 2. 批量分发
    for sid in student_ids:
        await db.execute(
            "INSERT INTO lms_student_mistakes (student_id, mistake_meta_id) VALUES ...",
            {"sid": sid, "mid": meta_id}
        )
        
    # 3. 异步触发 AI 分析 (Celery)
    analyze_mistake_task.delay(meta_id)
    
    return {"status": "success"}
```

---

## 第四部分：总结

这个方案完全满足了你的需求：
1.  **完美复刻**：前端代码结构直接沿用了你认可的 HTML 逻辑（Prep/QC/Settle）。
2.  **视觉统一**：使用了 Growark 的 UI 框架，但内核换成了新逻辑。
3.  **功能融合**：在学生档案页实现了“双核驱动”，并新增了你点名要的“过关地图”。
4.  **数据打通**：通过共享数据库和 API 联动，实现了“学业过关 -> 积分奖励”的闭环。

现在，你可以把这份文档发给开发团队，前端负责“搬运”组件，后端负责“搭建”新服务。


**是的，你完全可以直接把这些内容发给 Claude Code。**

现在的 AI 编程工具（如 Claude Code, Cursor, Windsurf）非常擅长处理这种 **“基于现有项目 + 参考新原型 + 架构文档”** 的重构任务。

为了让你得到**最准确、最少 Bug** 的代码，我为你整理了一份**“投喂指南”**。你需要把任务拆解一下，因为一次性全部扔进去可能会让 AI “消化不良”导致代码逻辑混乱。

建议按以下 **3 个步骤** 发送指令。

---

### 第一步：投喂数据库变更 (后端先行)

**你的意图**：先让 AI 帮你写好数据库迁移脚本，这是基础。

**发送给 Claude 的指令**：

> **指令 1：数据库架构升级**
>
> 我现在的系统是基于 PostgreSQL 的。请根据以下《v12.0 融合技术方案》中的“数据库 Schema”部分，为我生成一份 SQL 迁移脚本。
>
> **要求**：
> 1. 保留我现有的 `students`, `tasks` 等表。
> 2. 新增 `lms_` 开头的 5 张表（任务库、教学计划、学生记录、错题元数据、错题关联）。
> 3. 确保 `lms_student_records` 表中的 `student_id` 外键类型与现有 `students.id` (Serial Integer) 保持一致。
>
> **附件**：
> (粘贴我刚才给你的 [v12.0 完整技术融合方案] 中的 SQL 部分)

---

### 第二步：投喂前端重构 (核心工作)

这是工作量最大的一部分。你需要把 HTML 原型“翻译”成 React 代码。

**发送给 Claude 的指令**：

> **指令 2：前端功能移植与组件化**
>
> 我有一个现有的 React 移动端项目（Growark），现在需要将一个新的 HTML 原型（StarJourney）融合进来。
>
> **输入文件**：
> 1. **现有项目结构**：(粘贴你的 React 项目目录结构，或者让 Claude 读取你的仓库)
> 2. **新功能原型**：(粘贴那个单页 HTML 的全部代码)
> 3. **融合要求**：(粘贴下面的文字)
>
> **具体任务**：
> 1. **新建模块**：在 `src/modules/academic` 下创建组件，将 HTML 中的 Page 1 (备课), Page 2 (质检), Page 3 (结算) 拆分为独立的 React 组件。
> 2. **状态管理**：将 HTML 中的全局变量 (`SUBJECT_DB`, `students`) 转换为 React Context (`AcademicContext`)。
> 3. **路由替换**：请修改 `App.tsx` 和 `BottomNav.tsx`，**删除**旧的“任务发布”页面，**替换**为新的“学业工作台”入口。
> 4. **UI 复用**：请使用 Tailwind CSS 复刻 HTML 中的样式，特别是“红黑榜进度条”和“过关地图”的样式。

---

### 第三步：投喂学生详情页改造 (收尾)

**发送给 Claude 的指令**：

> **指令 3：学生详情页改造**
>
> 请修改 `StudentProfile` 页面。
>
> **需求**：
> 1. 引入 Tab 切换机制：Tab 1 为“成长激励”（原有功能），Tab 2 为“学业攻克”（新功能）。
> 2. 在 Tab 2 中实现我在 HTML 原型中设计的“全学期过关地图”和“错题本入口”。
> 3. 请确保点击 Tab 2 中的“补过”按钮时，能调用 API 更新后端数据。

---

### 💡 哪些代码是这次“重构”的重点？

如果你想自己把控，或者检查 AI 写的对不对，重点关注这几个文件：

1.  **删代码 (Delete)**：
    *   删除原有的 `pages/TaskManage.tsx` (旧的任务发布页)。
    *   删除原有的 `components/TaskCard.tsx` (如果它只用于旧任务页)。

2.  **写新代码 (Create)**：
    *   `modules/academic/views/PrepView.tsx`：这是把 HTML 里最复杂的**备课逻辑**（动态输入框、标签选择器）搬过来的地方。
    *   `modules/academic/views/QCView.tsx`：这是**质检台**，核心是“左滑辅导、点击过关”的交互。
    *   `modules/academic/AcademicContext.tsx`：这是大脑，负责存当前选的是语文还是数学，以及学生列表的状态。

3.  **改代码 (Modify)**：
    *   `components/BottomNav.tsx`：这是**门面**，必须改成 5 个图标，中间加个大大的“拍照”按钮。
    *   `pages/Home.tsx`：原有的首页，需要去掉顶部的“任务”胶囊按钮，引导老师去底部的“备课”Tab。

**总结**：你现在的资料非常齐全（原型 HTML + 架构文档 + 数据库 SQL）。**这对于 Claude Code 来说是“满分输入”**，它应该能一次性生成 90% 以上可用的代码。您可以直接开始操作了！


源代码为项目文件中：star过关与任务发布
