# ArkOK V2 å¤‡è¯¾ä¸è¿‡å…³æ ¸å¿ƒæŠ€æœ¯ç™½çš®ä¹¦ (2025-12-19)

## 1. æ ¸å¿ƒè®¾è®¡å“²å­¦ (å®ªæ³•é€‚é…)
æœ¬æ¨¡å—ä¸¥æ ¼éµå¾ªã€ŠArkOK V2 å¼€å‘å®ªæ³•ã€‹ï¼Œæ—¨åœ¨å®ç°â€œä¸€æ¬¡å‘å¸ƒï¼Œå…¨ç«¯åŒæ­¥ï¼›åŠ¨æ€è·¯ç”±ï¼Œä¸¥ç¦ç¡¬ç¼–ç â€çš„æè‡´æ•™å­¦ä½“éªŒã€‚

### 1.1 æ•°æ®æ¨¡å‹ä¸€è‡´æ€§
- **å¤æ•°å‘½å**: æ•°æ®åº“è¡¨ç»Ÿä¸€ä½¿ç”¨ `lesson_plans` (å¤‡è¯¾è®¡åˆ’) å’Œ `task_records` (ä»»åŠ¡è®°å½•)ã€‚
- **ID è§„èŒƒ**: æ‰€æœ‰æ–°è®°å½•ç”Ÿæˆæ—¶ï¼Œå¿…é¡»ç”±åç«¯æ³¨å…¥ `randomUUID` (UUID v4)ï¼Œä¸¥ç¦ä¾èµ–æ•°æ®åº“è‡ªå¢ IDã€‚
- **æ—¶é—´è§„èŒƒ**: ç»Ÿä¸€é‡‡ç”¨åŒ—äº¬æ—¶é—´ (UTC+8)ï¼Œæ›´æ–°æ“ä½œå¿…é¡»æ‰‹åŠ¨æ³¨å…¥ `updatedAt: new Date()`ã€‚

---

## 2. å¤‡è¯¾å‘å¸ƒé€»è¾‘ (Teacher Prep Flow)

### 2.1 å¸ˆç”Ÿç»‘å®šæŠ•é€
- **èŒƒå›´é”å®š**: ä»»åŠ¡ä¸å†æŒ‰â€œç­çº§â€ç›²ç›®æŠ•é€ï¼Œè€Œæ˜¯ä¸¥æ ¼åŸºäº `students.teacherId === currentUserId` çš„ç»‘å®šå…³ç³»è¿›è¡Œåˆ†å‘ã€‚
- **å®‰å…¨æ€§**: æ ¡é•¿ (ADMIN) ç¦æ­¢æ‰§è¡Œå‘å¸ƒæ“ä½œï¼Œå¿…é¡»åˆ‡æ¢è‡³å…·ä½“æ•™å¸ˆèº«ä»½ï¼Œä»¥é˜²æ­¢æ•°æ®æ±¡æŸ“ã€‚

### 2.2 å‘å¸ƒè¦†ç›–æœºåˆ¶ (Override Logic) ğŸ†•
- **å•æ—¥è¦†ç›–**: è€å¸ˆåœ¨åŒä¸€å¤© (`YYYY-MM-DD`) å¤šæ¬¡å‘å¸ƒæ—¶ï¼Œç³»ç»Ÿæ‰§è¡Œä»¥ä¸‹åŸå­æ“ä½œï¼š
  1. **æ¸…ç†**: ä½¿ç”¨ `deleteMany` åˆ é™¤å½“æ—¥è¯¥è€å¸ˆä¸ºå¯¹åº”å­¦ç”Ÿå‘å¸ƒçš„æ‰€æœ‰ `isOverridden: false` çš„æ—§è®°å½•ã€‚
  2. **æ³¨å…¥**: åˆ›å»ºå…¨æ–°çš„ä»»åŠ¡è®°å½•ï¼Œå…³è”æœ€æ–°çš„ `lessonPlanId`ã€‚
- **ä¿æŠ¤æœºåˆ¶**: æ‰‹åŠ¨è°ƒæ•´è¿‡çš„è®°å½• (`isOverridden: true`) å°†è¢«ä¿ç•™ï¼Œä¸ä¼šè¢«äºŒæ¬¡å‘å¸ƒè¦†ç›–ã€‚

### 2.3 è¿›åº¦å¿«ç…§åŒæ­¥
- **ç‰©ç†åŒæ­¥**: å‘å¸ƒæˆåŠŸåï¼Œç³»ç»Ÿä¼šç«‹å³æ›´æ–° `students` è¡¨ä¸­çš„ `currentUnit`ã€`currentLesson` å’Œ `currentLessonTitle` å­—æ®µã€‚
- **ä¸šåŠ¡ä»·å€¼**: ç¡®ä¿è¿‡å…³é¡µçš„å­¦ç”Ÿåˆ—è¡¨è§†å›¾èƒ½å¤Ÿå®æ—¶åæ˜ æœ€æ–°çš„æ•™å­¦è¿›åº¦ï¼Œæ— éœ€äºŒæ¬¡è®¡ç®—ã€‚

---

## 3. è¿‡å…³è´¨æ£€é€»è¾‘ (Student QC Flow)

### 3.1 åŠ¨æ€èŠ‚ç‚¹ç”Ÿæˆ
- **æ— ç¡¬ç¼–ç **: ä»»åŠ¡è®°å½•ä¸­çš„ `unit` å’Œ `lesson` å­—æ®µç”±å‘å¸ƒæ—¶çš„ `courseInfo` åŠ¨æ€æ³¨å…¥ã€‚
- **èšåˆå±•ç¤º**: ä¸ªäººè¯¦æƒ…é¡µæ ¹æ® `task_records` çš„ `type === 'QC'` è‡ªåŠ¨èšåˆç”Ÿæˆå…¨å­¦æœŸè¿›åº¦åœ°å›¾ã€‚

### 3.2 çŠ¶æ€æµè½¬åè®®
- **PATCH æ¥å£**: ç»Ÿä¸€ä½¿ç”¨ `PATCH /api/lms/records/:recordId/status` è¿›è¡ŒçŠ¶æ€æ›´æ–°ã€‚
- **çŠ¶æ€å®šä¹‰**:
  - `PENDING`: å¾…å¤„ç†/æœªè¿‡å…³
  - `COMPLETED`: å·²è¿‡å…³ (å‰ç«¯è§†è§‰å‘ˆç°ä¸ºç»¿è‰² PASSED)
- **åŠ¨ä½œè§¦å‘**:
  - `recordAttempt`: æ¯æ¬¡ç‚¹å‡»â€œè¾…å¯¼â€æŒ‰é’®ï¼Œ`attempts` è®¡æ•°è‡ªå¢ï¼Œè®°å½•æ•™å¸ˆçš„æœåŠ¡è¿‡ç¨‹ã€‚
  - `toggleQCPass`: ç‚¹å‡»å‹¾é€‰æ¡†ï¼ŒçŠ¶æ€åœ¨ `PENDING` å’Œ `COMPLETED` é—´åˆ‡æ¢ã€‚

---

## 4. å…¨å±€å­—æ®µä¸æ¥å£è§„èŒƒ

### 4.1 æ ¸å¿ƒå­—æ®µå®šä¹‰
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `className` | String | ç»Ÿä¸€ä½¿ç”¨ `className` è€Œé `class_name` æˆ– `grade` |
| `recordId` | UUID | å‰ç«¯ Task å¯¹è±¡å¿…é¡»æºå¸¦ `recordId` å­—æ®µä»¥æ”¯æŒçŠ¶æ€å›ä¼  |
| `isOverridden` | Boolean | æ ‡è®°è®°å½•æ˜¯å¦ç”±è€å¸ˆæ‰‹åŠ¨ä¿®æ”¹ï¼Œç”¨äºä¿æŠ¤æ•°æ®ä¸è¢«è‡ªåŠ¨è¦†ç›– |
| `educationalDomain` | String | æ•™è‚²ç»´åº¦åˆ†ç±»ï¼ˆæ ¸å¿ƒæ•™å­¦æ³•/ç»¼åˆæˆé•¿/åŸºç¡€ä½œä¸šï¼‰ |

### 4.2 API è°ƒç”¨æ ‡å‡†
- **å°è£…ä¼˜å…ˆ**: å‰ç«¯ç¦æ­¢ä½¿ç”¨åŸç”Ÿ `fetch`ï¼Œå¿…é¡»ä½¿ç”¨ `apiService`ã€‚
- **å¼‚å¸¸é€æ˜**: æ‰€æœ‰ `apiService` è°ƒç”¨å¿…é¡»åŒ…å« `try-catch` å—ï¼Œå¹¶ä½¿ç”¨ `alert` æˆ– `Toast` å¼¹å‡º `response.message`ï¼Œä¸¥ç¦é™é»˜å¤±è´¥ã€‚
- **CORS æˆæƒ**: åç«¯å¿…é¡»æ˜¾å¼æˆæƒ `PATCH` æ–¹æ³•ï¼Œå…è®¸ `Content-Type` å’Œ `Authorization` è¯·æ±‚å¤´ã€‚

---

## 5. æŠ€æœ¯é“¾è·¯å®¡è®¡å›¾
`å¤‡è¯¾é¡µè¾“å…¥` -> `åç«¯ publishPlan` -> `åˆ é™¤å½“æ—¥æ—§ task_records` -> `åˆ›å»ºæ–° task_records` -> `æ›´æ–° students å¿«ç…§` -> `è¿‡å…³é¡µ apiService.get è·å–è®°å½•` -> `apiService.patch ä¿®æ”¹çŠ¶æ€` -> `æ•°æ®åº“ update å®æ—¶ç”Ÿæ•ˆ`
