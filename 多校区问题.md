# 多校区管理问题总结

## 问题描述

在开发过程中发现了一个关键的多校区管理问题：**首页点击学生无法显示个人详情页的任务数据**。

### 表现症状
1. 首页学生点击事件正常，能跳转到个人详情页
2. 个人详情页API调用逻辑正确
3. 但个人详情页显示"没有任务记录"
4. 过关页的任务数据没有传递到个人详情页

## 根本原因分析

### 核心问题：学校ID权限隔离

**数据隔离机制**：
- 系统采用严格的学校ID（schoolId）权限隔离
- 所有数据查询都必须基于登录用户的schoolId
- 这是多租户架构的安全基础

**具体冲突**：
```json
// 测试学生数据
{
  "studentId": "test-student-123",
  "schoolId": "test-school-123"        // 学生属于测试学校
}

// 管理员账号数据
{
  "userId": "admin",
  "schoolId": "625e503b-aa7e-44fe-9982-237d828af717"  // 管理员属于默认学校
}
```

**API查询逻辑**：
```typescript
// getDailyRecords 方法
const records = await this.prisma.taskRecord.findMany({
  where: {
    schoolId: req.user.schoolId,  // 使用登录用户的schoolId
    studentId: req.query.studentId,
    // ...
  }
});
```

当管理员查询学生任务记录时，系统使用管理员的schoolId去查询，但学生属于不同的schoolId，导致查询返回空结果。

## 解决方案

### 方案1：创建正确学校的账号（推荐）

```typescript
// 为测试学校创建专属老师账号
const teacher = await prisma.teacher.upsert({
  where: { username: 'testteacher2' },
  update: {},
  create: {
    username: 'testteacher2',
    password: await bcrypt.hash('test123', 10),
    name: '测试老师2',
    schoolId: 'test-school-123'  // 与学生相同的schoolId
  }
});
```

### 方案2：修改学生归属（有约束风险）

```typescript
// 可能违反唯一约束 (schoolId, name)
// 不推荐，可能导致数据不一致
```

### 方案3：使用管理员特权

```typescript
// 为ADMIN角色添加跨学校查询权限
if (user.role === 'ADMIN') {
  // 允许查询所有学校的数据
  queryCondition.schoolId = undefined;
}
```

## 多校区管理注意事项

### 1. 数据安全原则
- **严格隔离**：每个学校的用户只能访问自己学校的数据
- **权限最小化**：用户只能看到被授权访问的内容
- **审计追踪**：所有跨学校操作都应该有日志记录

### 2. 测试环境配置
- **学校一致性**：测试时确保用户和学生属于同一个schoolId
- **多角色测试**：为每个学校创建对应的老师和管理员账号
- **数据完整性**：测试数据要符合多租户架构约束

### 3. 开发规范
- **API设计**：所有数据接口都必须考虑schoolId过滤
- **前端逻辑**：UI要基于用户权限显示对应的数据
- **错误处理**：跨学校访问要返回明确的错误信息

### 4. 部署考虑
- **环境隔离**：开发、测试、生产环境使用不同的schoolId
- **数据迁移**：迁移脚本要处理schoolId映射
- **权限检查**：部署后验证所有学校的数据隔离正常

## 技术实现细节

### API端点分析
```typescript
// /api/lms/daily-records 端点
router.get('/daily-records', authenticateToken, async (req, res) => {
  const { studentId, date } = req.query;

  // 关键：使用登录用户的schoolId进行查询
  const schoolId = req.user.schoolId;
  const records = await lmsService.getDailyRecords(schoolId, studentId, date);
});
```

### 数据库约束
```sql
-- 学生表约束
CONSTRAINT student_school_name_unique UNIQUE (schoolId, name)

-- 任务记录表约束
CONSTRAINT task_record_school_student_unique UNIQUE (schoolId, studentId, title, created_at)
```

### 权限中间件
```typescript
// 认证中间件确保token中的schoolId与查询一致
const authenticateToken = (req, res, next) => {
  const user = jwt.verify(token, process.env.JWT_SECRET);
  req.user = user;  // 包含userId, schoolId, role等信息
  next();
};
```

## 验证方法

### 1. API测试
```bash
# 使用正确学校的账号测试
curl -X POST "http://localhost:3000/api/auth/login" \
  -d '{"username":"testteacher2","password":"test123"}'

# 获取token后测试任务记录API
curl -X GET "http://localhost:3000/api/lms/daily-records?studentId=test-student-123&date=2025-12-16" \
  -H "Authorization: Bearer ${token}"
```

### 2. 日志分析
```typescript
// 服务器日志应显示：
console.log(`🔥 [LMS DEBUG] 传入参数: schoolId=${schoolId}, studentId=${studentId}`);
console.log(`🔥 [LMS DEBUG] 查询结果: 找到 ${records.length} 条记录`);
```

### 3. 前端验证
- 首页能正常显示学生列表
- 点击学生头像能跳转到个人详情页
- 个人详情页能显示该学生的任务记录
- 过关页的数据能同步到个人详情页

## 生产环境建议

### 1. 账号管理
- 为每个学校创建独立的管理员账号
- 定期审计学校账号的权限配置
- 实施强密码策略和定期轮换

### 2. 数据隔离验证
- 定期检查数据隔离是否正常工作
- 模拟跨学校访问测试
- 监控异常的跨学校查询请求

### 3. 错误处理
- 提供清晰的权限错误提示
- 记录所有权限拒绝的访问尝试
- 实现管理员跨学校访问的审批流程

## 总结

这次问题暴露了多校区架构中的一个关键设计点：**数据隔离必须从数据库层面到API层面全面实施**。在多租户SaaS应用中，任何忽略schoolId的查询都可能导致数据泄露或权限绕过。

**关键经验**：
- 测试数据必须符合生产环境的权限约束
- API设计要始终考虑多租户隔离
- 错误的权限设置会导致功能完全不可用
- 需要为每个业务场景准备相应的测试账号

通过这次排查，我们建立了完整的多校区测试流程，为后续开发奠定了基础。